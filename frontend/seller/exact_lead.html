<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/exact-lead-stylr.css">
    <link rel="stylesheet" href="/static/sales-dashboard-style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/sales_style/complex.css">
    <link rel="stylesheet" href="/static/sales_style/header-sales.css">

   
    <style>
        .notification {
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            max-width: 500px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: white;
            margin-left: 15px;
            padding: 0;
            line-height: 1;
        }

        body {
        background: {% if user and user.background_theme %} url('{{ user.background_theme }}')  lightgray 50% / cover no-repeat {% else %} #ffffff {% endif %};
        transition: background 0.5s ease;
    }

    .apt-card.available {
  background-color: #e6ffed; /* light green */
  border: 1px solid #28a745; /* green border */
}
.apt-card.sold {
  background-color: #ffe6e6; /* light red */
  border: 1px solid #dc3545; /* red border */
}
    .apt-card.booked {
  background-color: #fff4e5; /* light orange */
  border: 1px solid #ffc107; /* orange border */
}
    .action-button.booked {
      background-color: #fff4e5; /* light orange */
      border: 1px solid #ffc107; /* orange border */
      color: #000;
    }

    .action-button.disabled {
      background-color: #e0e0e0;
      border: 1px solid #ccc;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Стили для новых кнопок действий лида */
    .lead-actions-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 24px;
      padding: 24px;
      background: linear-gradient(180deg, #f3f4ff 0%, #ffffff 100%);
      border-radius: 24px;
      border: 1px solid rgba(99, 102, 241, 0.08);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }

    .lead-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px 24px;
      border-radius: 20px;
      background: linear-gradient(180deg, #fbfdff 0%, #ffffff 100%);
      border: 1px solid rgba(148, 163, 184, 0.22);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.06);
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      min-height: 92px;
      text-align: left;
    }

    .lead-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 22px 48px rgba(15, 23, 42, 0.12);
      border-color: rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }

    .lead-btn-icon {
      width: 56px;
      height: 56px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 18px;
      color: #fff;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      flex-shrink: 0;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .lead-action-btn:hover .lead-btn-icon {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.16);
    }

    .lead-btn-icon svg {
      width: 28px;
      height: 28px;
    }

    .lead-btn-text {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      line-height: 1.35;
    }

    /* Стили для кнопки фиксации клиента */
    .lead-schedule-btn {
      border-color: rgba(245, 158, 11, 0.28);
      background: linear-gradient(180deg, #fff7eb 0%, #ffffff 100%);
    }

    .lead-schedule-btn .lead-btn-icon {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      box-shadow: 0 18px 34px rgba(245, 158, 11, 0.32);
    }

    .lead-schedule-btn:hover {
      border-color: rgba(245, 158, 11, 0.4);
      box-shadow: 0 24px 48px rgba(245, 158, 11, 0.22);
    }

    /* Стили для модального окна планирования созвона */
    .schedule-callback-modal {
      max-width: 500px;
      padding: 30px;
    }

    .schedule-form-group {
      margin-bottom: 24px;
    }

    .schedule-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
      letter-spacing: 0.025em;
    }

    /* Стили для контейнера даты и времени */
    .datetime-input-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .schedule-datetime-input {
      width: 100%;
      padding: 12px 16px 12px 48px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      color: #374151;
      background: #ffffff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .schedule-datetime-input:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
      background: #fefbf3;
    }

    .schedule-datetime-input:hover {
      border-color: #d97706;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .datetime-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      pointer-events: none;
      transition: color 0.3s ease;
    }

    .schedule-datetime-input:focus + .datetime-icon,
    .schedule-datetime-input:hover + .datetime-icon {
      color: #f59e0b;
    }

    /* Стили для контейнера текстовой области */
    .textarea-container {
      position: relative;
      display: flex;
      align-items: flex-start;
    }

    .schedule-textarea {
      width: 100%;
      padding: 12px 16px 12px 48px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      color: #374151;
      background: #ffffff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      resize: vertical;
      min-height: 100px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
    }

    .schedule-textarea:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
      background: #fefbf3;
    }

    .schedule-textarea:hover {
      border-color: #d97706;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .schedule-textarea::placeholder {
      color: #9ca3af;
      font-weight: 400;
      font-style: italic;
    }

    .textarea-icon {
      position: absolute;
      left: 16px;
      top: 16px;
      color: #9ca3af;
      pointer-events: none;
      transition: color 0.3s ease;
    }

    .schedule-textarea:focus + .textarea-icon,
    .schedule-textarea:hover + .textarea-icon {
      color: #f59e0b;
    }

    /* Анимация появления полей */
    .schedule-form-group {
      animation: slideInUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .schedule-form-group:nth-child(1) {
      animation-delay: 0.1s;
    }

    .schedule-form-group:nth-child(2) {
      animation-delay: 0.2s;
    }

    @keyframes slideInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Стили для кнопки созвона */
    .lead-call-btn {
      border-color: rgba(139, 92, 246, 0.28);
      background: linear-gradient(180deg, #f5f3ff 0%, #ffffff 100%);
    }

    .lead-call-btn .lead-btn-icon {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: #fff;
      box-shadow: 0 18px 34px rgba(139, 92, 246, 0.32);
    }

    .lead-call-btn:hover {
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 24px 48px rgba(124, 58, 237, 0.22);
    }

    .lead-call-btn.completed {
      border-color: rgba(16, 185, 129, 0.32);
      background: linear-gradient(180deg, #ecfdf5 0%, #ffffff 100%);
    }

    .lead-call-btn.completed .lead-btn-icon {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 18px 34px rgba(16, 185, 129, 0.28);
    }

    .lead-call-btn.completed .lead-btn-text {
      color: #047857;
      font-weight: 700;
    }

    /* Стили для кнопки бронирования */
    .lead-booking-btn {
      border-color: rgba(16, 185, 129, 0.28);
      background: linear-gradient(180deg, #ecfdf5 0%, #ffffff 100%);
    }

    .lead-booking-btn .lead-btn-icon {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
      box-shadow: 0 18px 34px rgba(16, 185, 129, 0.32);
    }

    .lead-booking-btn:hover {
      border-color: rgba(5, 150, 105, 0.4);
      box-shadow: 0 24px 48px rgba(5, 150, 105, 0.22);
    }

    .lead-booking-btn.booked {
      background: linear-gradient(180deg, #fff7ed 0%, #ffffff 100%);
      border-color: rgba(245, 158, 11, 0.28);
    }

    .lead-booking-btn.booked .lead-btn-icon {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 18px 34px rgba(245, 158, 11, 0.28);
    }

    /* Стили для кнопки договора */
    .lead-contract-btn {
      border-color: rgba(33, 107, 244, 0.3);
      background: linear-gradient(180deg, #edf4ff 0%, #ffffff 100%);
    }

    .lead-contract-btn .lead-btn-icon {
      background: linear-gradient(135deg, #216bf4, #1d4ed8);
      color: #fff;
      box-shadow: 0 18px 34px rgba(33, 107, 244, 0.32);
    }

    .lead-contract-btn:hover {
      border-color: rgba(33, 107, 244, 0.45);
      box-shadow: 0 24px 48px rgba(33, 107, 244, 0.24);
    }

    /* Стили для кнопки удаления */
    .lead-delete-btn {
      border-color: rgba(239, 68, 68, 0.35);
      background: linear-gradient(180deg, #fff5f5 0%, #ffffff 100%);
    }

    .lead-delete-btn .lead-btn-icon {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      box-shadow: 0 18px 34px rgba(239, 68, 68, 0.32);
    }

    .lead-delete-btn .lead-btn-text {
      color: #b91c1c;
    }

    .lead-delete-btn:hover {
      border-color: rgba(220, 38, 38, 0.45);
      box-shadow: 0 24px 48px rgba(220, 38, 38, 0.24);
    }

    /* Стили для кнопки архивации */
    .lead-archive-btn {
      border-color: rgba(249, 115, 22, 0.3);
      background: linear-gradient(180deg, #fff7ed 0%, #ffffff 100%);
    }

    .lead-archive-btn .lead-btn-icon {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff;
      box-shadow: 0 18px 34px rgba(249, 115, 22, 0.32);
    }

    .lead-archive-btn .lead-btn-text {
      color: #c2410c;
    }

    .lead-archive-btn:hover {
      border-color: rgba(234, 88, 12, 0.42);
      box-shadow: 0 24px 48px rgba(234, 88, 12, 0.24);
    }

    /* Состояния кнопок */
    .lead-action-btn.disabled {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
      pointer-events: none;
      transform: none;
    }

    .lead-action-btn.disabled .lead-btn-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }

    .lead-action-btn.disabled .lead-btn-text {
      color: #9ca3af;
    }

    /* Анимация появления */
    .lead-actions-container {
      animation: slideInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    @keyframes slideInUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Планшеты - 2 колонки */
    @media (max-width: 1024px) and (min-width: 769px) {
      .lead-actions-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
        padding: 18px;
      }
    }

    /* Мобильная адаптивность - 1 колонка */
    @media (max-width: 768px) {
      .lead-actions-container {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 16px;
        margin-top: 16px;
      }

      .lead-action-btn {
        padding: 16px 12px;
        min-height: 80px;
      }

      .lead-btn-icon {
        width: 40px;
        height: 40px;
        margin-bottom: 8px;
      }

      .lead-btn-text {
        font-size: 13px;
      }
    }

    .price-input {
      width: auto;
      display: inline-block;
      box-sizing: content-box;
    }

    /* Стили для редактирования клиента */
    .client-header-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .phone-container {
      display: flex;
      align-items: center;

      gap: 8px;
    }

    .edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .edit-btn:hover {
      background-color: #f3f4f6;
      color: #374151;
    }

    .edit-btn svg {
      width: 16px;
      height: 16px;
    }

    .edit-input {
      background: #ffffff;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      outline: none;
      width: 100%;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .edit-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    /* Стили для модального окна статуса */
    .status-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      width: 100%;
    }

    .status-option:hover {
      border-color: #6366f1;
      background: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .status-option.selected {
      border-color: #6366f1;
      background: #eef2ff;
    }

    .status-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .status-icon.new {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-icon.in-work {
      background: #fef3c7;
      color: #d97706;
    }

    .status-icon.processed {
      background: #d1fae5;
      color: #059669;
    }

    .status-icon.sent {
      background: #e0e7ff;
      color: #6366f1;
    }

    .status-icon.waiting {
      background: #fce7f3;
      color: #be185d;
    }

    .status-icon.closed {
      background: #fee2e2;
      color: #dc2626;
    }

    .status-icon.inactive {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status-info {
      flex: 1;
    }

    .status-name {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .status-desc {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.4;
    }

    </style>
</head>

<body>
    <div id="notification" class="notification" style="display: none;">
        <span id="notification-message"></span>
        <button id="close-notification" class="close-btn">&times;</button>
    </div>
    {% if user.role.id == 2%}
    {% include 'partials/mop-header.html' %}
    {% else %}
    {% include 'partials/header.html' %}
   
{% endif %}
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <input type="text" id="leadId" value="{{ lead.id }}" hidden="true">
    <div class="main-content">
        <div class="client-info">
            <div class="client-header-container">
                <h1 class="client-header" id="client-name">{{ lead.full_name }}</h1>
                <button class="edit-btn" onclick="editClientName()" title="Редактировать имя">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </div>
            <hr class="divider">

            <div class="info-grid">
                <div class="info-box-tag">
                    <span class="tag input_info_lead"> {{ lead.contact_source}}</span>
                </div>
                <div class="info-box-tag">
                    <span class="input_info_lead">{{ lead.region}}</span>
                </div>
                <div class="info-box-tag phone-container">
                    <span class="input_info_lead" id="client-phone">{{ lead.phone}}</span>
                    <button class="edit-btn" onclick="editClientPhone()" title="Редактировать телефон">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
                <div class="info-box-tag">
                    <span class="input_info_lead">{{ lead.created_at.strftime('%d.%m.%Y') }}</span>
                </div>
            </div>


            <hr class="divider">



            <div class="info-grid">
                <div class="info-box">
                    <div class="info-label">Метров²</div>
                    <div class="info-value">{{ lead.square_meters }}м²</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Количество комнат</div>
                    <div class="info-value">{{ lead.rooms }} комнат</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Этаж</div>
                    <div class="info-value">{{ lead.floor }} этаж</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Вид оплаты</div>
                    <div class="info-value">{{ lead.payment_type}}</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Блок</div>
                    <div class="info-value">{{ lead.block }}</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Номер квартиры</div>
                    <div class="info-value">№{{ lead.number_apartments}}</div>
                </div>
                
            </div>
            <hr class="divider">
            <div class="info-box info-box--full info-box--interactive" id="lead-attach-trigger" role="button" tabindex="0">
                <div class="info-label">Жилой комплекс</div>
                <div class="info-value">{{ lead.complex_name or '—' }}</div>
                <div class="info-action-hint">Закрепить квартиру к лиду</div>
            </div>
          
<div class="price-card">
  <input type="hidden" id="squareMeters" value="{{ lead.square_meters }}">
  <div class="price-title">Предварительная сумма</div>
  <div class="price-main">
    <input type="text" id="totalPriceInput" class="price-input"
           value='{% if lead.down_payment %}{{ "{:,.0f}".format(lead.down_payment) }}{% else %}{{ "{:,.0f}".format(lead.total_price) }}{% endif %}'
           size='{% if lead.down_payment %}{{ "{:,.0f}".format(lead.down_payment)|length }}{% else %}{{ "{:,.0f}".format(lead.total_price)|length }}{% endif %}' />
    <span>сум</span>
  </div>
  <hr class="divider">
  <div class="price-subtitle">Стоимость 1м²</div>
  <div class="price-value">
    <input type="text" id="pricePerM2Input" class="price-input"
           value="{% if lead.square_meters_price %}{{ '{:,.0f}'.format(lead.square_meters_price) }}{% else %}0{% endif %}"
           size='{% if lead.square_meters_price %}{{ "{:,.0f}".format(lead.square_meters_price)|length }}{% else %}1{% endif %}' />
    <span>сум/м²</span>
  </div>
  <input type="hidden" id="downPayment" value="{{ lead.down_payment or 0 }}">
<input type="hidden" id="installmentPeriod" value="{{ lead.installment_period or 1 }}">
  
</div>
    <!-- Hidden fields for monthly calculation -->
    
          
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h1 class="client-header">Управление лидом</h1>
            </div>

            <div class="message">
                Добрый день! Я бы хотел узнать подробнее про здание и обсудить сроки въезда.
                <div class="time">12:30</div>
            </div>

            <div class="message sent">
                Здравствуйте!
                <div class="time">12:32</div>
            </div>

            <div class="message sent">
                Для уточнения данного вопроса вам необходимо связаться с нами по телефону
                <div class="time">12:33</div>
            </div>

            <div id="comments-container" class="comments-container space-y-4 overflow-y-auto mb-4 mt-10"></div>

            <div class="comment-form space-y-3">
                <p class="comment-note text-xs text-gray-500">
                    Добавьте заметку, чтобы напомнить себе о следующем действии по этому лиду.
                </p>
                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="internal-comment" class="rounded border-gray-300">
                        Внутренний комментарий
                    </label>
                </div>

                <div class="comment-input-row flex gap-2">
                    <textarea id="comment-input" placeholder="Введите комментарий..."
                        class="flex-1 min-h-[80px] p-2 border rounded-lg resize-none"></textarea>
                    <button id="send-comment"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 self-end">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="buttons-row">
              <div class="quick-action-button-wrapper view-chat-button">
                <button type="button" class="quick-action-button quick-action-button--ghost" id="viewChatButton">
                  <span class="quick-action-button__icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22" fill="none">
                      <path d="M15.6751 2.75006H6.32506C4.01141 2.75006 2.75006 4.01141 2.75006 6.32506V15.6751C2.75006 17.9887 4.01141 19.2501 6.32506 19.2501H15.6751C17.9887 19.2501 19.2501 17.9887 19.2501 15.6751V6.32506C19.2501 4.01141 17.9887 2.75006 15.6751 2.75006Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7.3335 8.25H14.6668" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      <path d="M7.3335 13.75H11.0002" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span class="quick-action-button__text">Посмотреть чат полностью</span>
                  <span class="quick-action-button__arrow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                      <path d="M8 5L13 10L8 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          <!-- Chat Modal -->
<div id="chatModal" class="modal" style="display:none;">
  <div class="modal-content chat-modal-content">
      <div class="chat-modal-header">
          <h2>Запись чата</h2>
          <button type="button" class="modal-close-button" onclick="closeChatModal()">×</button>
      </div>
      <div class="chat-modal-body full-chat-content">
          <!-- Full chat will be populated here -->
      </div>
  </div>
</div>
            


            <div class="lead-actions-container">
                <button id="scheduleCallbackButton" class="lead-action-btn lead-schedule-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="lead-btn-text">Запланировать созвон</div>
                </button>
                
                <button id="statusButton" class="lead-action-btn lead-status-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="lead-btn-text">Статус</div>
                </button>
                
                <button id="bookingButton" class="lead-action-btn lead-booking-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="lead-btn-text">Бронирование</div>
                </button>
                
                <button id="contractButton" class="lead-action-btn lead-contract-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                    </svg>
                    </div>
                    <div class="lead-btn-text">Заключение договора</div>
                </button>
                
                <button id="deleteLeadButton" class="lead-action-btn lead-delete-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
              </svg>
                    </div>
                    <div class="lead-btn-text">Удалить лида</div>
            </button>
                
                <button id="markInactiveButton" class="lead-action-btn lead-archive-btn" type="button">
                    <div class="lead-btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 9.5l5.5 5.5H14v2h-4v-2H6.5L12 9.5z" fill="currentColor"/>
                  </svg>
                    </div>
                    <div class="lead-btn-text">Сделать неактуальным</div>
            </button>
            </div>
        </div>
        <div id="contractModal" class="modal">
            <div class="modal-content">
                <h2 class="client-header">Создание договора</h2>
                <form id="contractForm">
                    <input type="hidden" name="lead_id" id="lead_id">
                    <label>Номер договора:</label>
                    <input type="text" name="contract_number" required class="contract-input">
                    <label>Дата договора:</label>
                    <input type="date" name="contractDate" required class="contract-input">
                    <label>Блок:</label>
                    <input type="text" name="block" value="0" required class="contract-input">
                    <label>Этаж:</label>
                    <input type="number" name="floor" value="0" required class="contract-input">
                    <label>Номер квартиры:</label>
                    <input type="number" name="apartmentNumber" value="0" required class="contract-input">
                    <label>Кол-во комнат:</label>
                    <input type="number" name="rooms" value="0" required class="contract-input">
                    <label>Площадь (м²):</label>
                    <input type="number" name="size" value="0" required class="contract-input">
                    <label>Общая стоимость:</label>
                    <input type="text" name="totalPrice"
                        value="" required class="contract-input">
                    <label>Стоимость 1 м²:</label>
                    <input type="text" name="pricePerM2"
                        value="" required class="contract-input">
                    <label>Выбор оплаты (%):</label>
                    <input type="text" name="paymentChoice" value="" required class="contract-input">
                    <label>Сумма первоначального взноса:</label>
                    <input type="text" name="initialPayment" id="initialPayment"
                        value="" required class="contract-input">
                    <label>Ф/И/О:</label>
                    <input type="text" name="fullName" required class="contract-input">
                    <label>Серия паспорта:</label>
                    <input type="text" name="passportSeries" required class="contract-input">
                    <label>ПИНФЛ:</label>
                    <input type="text" name="pinfl" required class="contract-input">
                    <label>Кем выдан:</label>
                    <input type="text" name="issuedBy" required class="contract-input">
                    <label>Адрес прописки:</label>
                    <input type="text" name="registrationAddress" required class="contract-input">
                    <label>Номер телефона:</label>
                    <input type="text" name="phone" required class="contract-input">
                    <label>Отдел продаж:</label>
                    <input type="text" name="salesDepartment" required class="contract-input">
                    <div class="container-button">
                        <button type="submit" class="btn active">Создать</button>
                        <button class="btn" type="button" onclick="closeModal()">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="callbackModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-sure">
                    <h2 class="modal-title">Забронировать квартиру №{{ lead.number_apartments}} для лида?</h2>
        
                </div>
                <div class="modal-actions">
                    <button class="btn cancel" onclick="closeModalNot()">Отменить</button>
                    <button class="btn confirm" id="confirmRoleButton">Да</button>
                </div>
            </div>
        </div>
        <div id="unbookingModal" class="modal" style="display: none;">
          <div class="modal-content">
            <h2 class="client-header">Снять бронь с квартиры №{{ lead.number_apartments }}?</h2>
            <div class="modal-actions">
              <button class="btn cancel" onclick="closeUnbookingModal()">Отменить</button>
              <button class="btn confirm" id="confirmUnbookingButton">Снять бронь</button>
            </div>
          </div>
        </div>
        <div id="deleteModal" class="modal" style="display: none;">
          <div class="modal-content">
            <div class="modal-sure">
              <h2 class="modal-title">Удалить лида "{{ lead.full_name }}"?</h2>
            </div>
            <div class="modal-actions">
              <button class="btn cancel" onclick="closeDeleteModal()">Отменить</button>
              <button class="btn danger" id="confirmDeleteButton">Да</button>
            </div>
          </div>
        </div>
        <!-- Inactive Lead Modal -->
        <div id="inactiveModal" class="modal" style="display: none;">
          <div class="modal-content">
            <div class="modal-sure">
              <h2 class="modal-title">Сделать лида неактуальным?</h2>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
              <button class="btn cancel" onclick="closeInactiveModal()">Отмена</button>
              <button class="btn confirm" id="confirmInactiveButton">Да</button>
            </div>
          </div>
        </div>

        <!-- Schedule Callback Modal -->
        <div id="scheduleCallbackModal" class="modal" style="display: none;">
          <div class="modal-content schedule-callback-modal">
            <h2 class="client-header">Запланировать созвон</h2>
            <form id="scheduleCallbackForm">
              <div class="form-group schedule-form-group">
                <label for="callbackDateTime" class="schedule-label">Дата и время созвона:</label>
                <div class="datetime-input-container">
                  <input type="datetime-local" id="callbackDateTime" name="callbackDateTime" class="schedule-datetime-input" required>
                  <div class="datetime-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M8 2v3m8-3v3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="form-group schedule-form-group">
                <label for="callbackNotes" class="schedule-label">Заметки к созвону:</label>
                <div class="textarea-container">
                  <textarea id="callbackNotes" name="callbackNotes" class="schedule-textarea" rows="4" placeholder="Дополнительная информация о созвоне..."></textarea>
                  <div class="textarea-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" onclick="closeScheduleCallbackModal()" class="btn cancel">Отмена</button>
                <button type="submit" class="btn confirm">Запланировать созвон</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Status Change Modal -->
        <div id="statusModal" class="modal" style="display: none;">
          <div class="modal-content">
            <h2 class="client-header">Изменить статус лида</h2>
            <div class="status-options">
              <button class="status-option" data-status="NEW">
                <div class="status-icon new">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Новый</div>
                  <div class="status-desc">Только что созданный лид</div>
                </div>
              </button>
              
              <button class="status-option" data-status="IN_WORK">
                <div class="status-icon in-work">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">В работе</div>
                  <div class="status-desc">Активно обрабатывается</div>
                </div>
              </button>
              
              <button class="status-option" data-status="PROCESSED">
                <div class="status-icon processed">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Обработан</div>
                  <div class="status-desc">Успешно завершен</div>
                </div>
              </button>
              
              <button class="status-option" data-status="SENT">
                <div class="status-icon sent">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Отправлен</div>
                  <div class="status-desc">Материалы отправлены</div>
                </div>
              </button>
              
              <button class="status-option" data-status="WAITING_RESPONSE">
                <div class="status-icon waiting">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Ожидает ответа</div>
                  <div class="status-desc">Ждем реакции клиента</div>
                </div>
              </button>
              
              <button class="status-option" data-status="CLOSED">
                <div class="status-icon closed">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Закрыт</div>
                  <div class="status-desc">Дело закрыто</div>
                </div>
              </button>
              
              <button class="status-option" data-status="INACTIVE">
                <div class="status-icon inactive">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">Неактивен</div>
                  <div class="status-desc">Неактуальный лид</div>
                </div>
              </button>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
              <button class="btn cancel" onclick="closeStatusModal()">Отмена</button>
            </div>
          </div>
        </div>
    </div>

    <!-- Attach Apartment Modal -->
<div id="attachModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 class="client-header">Закрепить квартиру к лиду</h2>
      <input type="hidden" id="attach-lead-id" value="{{lead.id}}">
  
      <!-- Шаг 1: выбор ЖК -->
      <div class="form-group">
        <label for="attach-jk-select">Выберите ЖК:</label>
        <select id="attach-jk-select" class="contract-input">
          <option value="">Загрузка...</option>
        </select>
      </div>
  
      <!-- Шаг 2: выбор блока -->
      <div id="attach-blocks" class="blocks-container" style="margin-top:1rem;"></div>
  
      <!-- Шаг 3: шахматка квартир -->
      <div id="attach-apartments" class="apartment-grid" style="margin-top:1rem;"></div>
  
      <div class="container-button" style="margin-top:1.5rem; display:flex; gap:8px;">
        <button type="button" class="btn" onclick="closeAttachModal()">Отмена</button>
      </div>
    </div>
  </div>


  
    <script src="/static/exact-lead-scripts.js"></script>
    {% if user.role.id == 1 %}
    <script src="/static/search-lead-scripts.js"></script>
    {% else %}
    <script src="/static/mop-dashboard-main.js"></script>
{% endif %}

    <!-- Chat Modal Script -->
    <script>
      function openChatModal() {
        var modalBody = document.querySelector('#chatModal .full-chat-content');
        document.getElementById('chatModal').style.display = 'block';
      }

      function closeChatModal() {
        document.getElementById('chatModal').style.display = 'none';
      }

      document.getElementById('viewChatButton').addEventListener('click', openChatModal);
    </script>
    <script>
function openContractModal(prefilledData) {
    document.getElementById('contractModal').style.display = 'block';
    // Insert full styled form with prefill and today's date
    const modalContent = document.querySelector('#contractModal .modal-content');
    modalContent.innerHTML = `
        <h1 style="margin-top: 0;">Оформление договора</h1>
        <form id="contract-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; font-family: Inter, sans-serif;">
            <input type="hidden" name="jkName" value="${prefilledData.jkName}">
            
            <div style="grid-column: 1/3; display: flex; gap: 16px;">
                <div style="flex: 1;">
                    <label for="contractDate" style="font-weight: 500;">Дата договора</label>
                    <input type="date" id="contractDate" name="contractDate" class="contract-input" value="${new Date().toISOString().slice(0,10)}" required style="width: 100%; margin-bottom: 8px;">
                </div>
                <div style="flex: 1;">
                    <label for="contractNumber" style="font-weight: 500;">Номер договора</label>
                    <input type="text" id="contractNumber" name="contractNumber" class="contract-input" value="${prefilledData.contractNumber || '1'}" required style="width: 100%; margin-bottom: 8px;">
                </div>
            </div>
            <div>
                <label for="block" style="font-weight: 500;">Блок</label>
                <input type="text" id="block" name="block" class="contract-input" value="${prefilledData.block || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="floor" style="font-weight: 500;">Этаж</label>
                <input type="number" id="floor" name="floor" class="contract-input" value="${prefilledData.floor || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="apartmentNumber" style="font-weight: 500;">Номер квартиры</label>
                <input type="number" id="apartmentNumber" name="apartmentNumber" class="contract-input" value="${prefilledData.apartmentNumber || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="rooms" style="font-weight: 500;">Количество комнат</label>
                <input type="number" id="rooms" name="rooms" class="contract-input" value="${prefilledData.rooms || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="size" style="font-weight: 500;">Площадь (м²)</label>
                <input type="number" id="size" name="size" class="contract-input" value="${prefilledData.size || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="paymentChoice" style="font-weight: 500;">Вид оплаты (%)</label>
                <input type="text" id="paymentChoice" name="paymentChoice" class="contract-input" value="${prefilledData.paymentChoice || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="totalPrice" style="font-weight: 500;">Общая стоимость</label>
                <input type="text" id="totalPrice" name="totalPrice" class="contract-input" value="${prefilledData.totalPrice || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="pricePerM2" style="font-weight: 500;">Стоимость 1 м²</label>
                <input type="text" id="pricePerM2" name="pricePerM2" class="contract-input" value="${prefilledData.pricePerM2 || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="initialPayment" style="font-weight: 500;">Первоначальный взнос</label>
                <input type="text" id="initialPayment" name="initialPayment" class="contract-input" value="${prefilledData.initialPayment || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div style="grid-column: 1/3; border-top: 1px solid #eee; margin-top: 8px; padding-top: 12px;"></div>
            <div>
                <label for="fullName" style="font-weight: 500;">ФИО</label>
                <input type="text" id="fullName" name="fullName" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="passportSeries" style="font-weight: 500;">Серия паспорта</label>
                <input type="text" id="passportSeries" name="passportSeries" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="pinfl" style="font-weight: 500;">ПИНФЛ</label>
                <input type="text" id="pinfl" name="pinfl" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="issuedBy" style="font-weight: 500;">Кем выдан</label>
                <input type="text" id="issuedBy" name="issuedBy" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div style="grid-column: 1/3;">
                <label for="registrationAddress" style="font-weight: 500;">Адрес прописки</label>
                <input type="text" id="registrationAddress" name="registrationAddress" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="phone" style="font-weight: 500;">Телефон</label>
                <input type="text" id="phone" name="phone" class="contract-input" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div>
                <label for="salesDepartment" style="font-weight: 500;">Отдел продаж</label>
                <input type="text" id="salesDepartment" name="salesDepartment" class="contract-input" value="${prefilledData.sellerName || ''}" required style="width: 100%; margin-bottom: 8px;">
            </div>
            <div style="grid-column: 1/3; display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                <button type="submit" class="action-btn" style="background: #216BF4; color: #fff; border-radius: 6px; padding: 10px 24px; font-weight: 600;">Создать</button>
                <button type="button" class="action-btn" style="background: #eee; color: #333; border-radius: 6px; padding: 10px 24px; font-weight: 600;" onclick="closeModal()">Отмена</button>
            </div>
        </form>
    `;
    // Prefill values for personal info fields if present in prefilledData
    if (prefilledData) {
        // The above template already fills contract fields; for personal fields, set if present
        const keys = ['fullName', 'passportSeries', 'pinfl', 'issuedBy', 'registrationAddress', 'phone', 'salesDepartment'];
        keys.forEach(key => {
            if (prefilledData[key]) {
                const input = modalContent.querySelector(`[name="${key}"]`);
                if (input) input.value = prefilledData[key];
            }
        });
    }
    const form = document.getElementById('contract-form');
    form.onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        try {
            const response = await fetch('/excel/generate-contract', {
                method: 'POST',
                body: JSON.stringify(Object.fromEntries(formData)),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail);
            }
            const blob = await response.blob();
            const contentDisposition = response.headers.get("Content-Disposition");
            const filename = contentDisposition
                ? contentDisposition.split("filename=")[1].replace(/"/g, "")
                : "contract_and_registry.zip";
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            document.getElementById('contractModal').style.display = 'none';
            form.reset();
            // Обновляем статус квартиры в Excel на "продана"
            await updateApartmentStatusInExcel(
              prefilledData.jkName,
              prefilledData.block,
              prefilledData.floor,
              prefilledData.apartmentNumber,
              "продана"
            );
            showNotification('Договор успешно создан и квартира отмечена как проданная!', 'success');
            // После создания договора переводим лид в состояние PROCESSED
            const leadId = document.getElementById('leadId').value;
            await fetch(`/api/leads/${leadId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ state: 'PROCESSED' })
            });
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };
}


        async function updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, newStatus) {
    try {
        const response = await fetch("/excel/update-status", { // Новый эндпоинт
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                jkName: jkName,
                blockName: blockName,
                floor: parseInt(floor, 10),
                // apartmentNumber может быть строкой или числом, бэкенд должен это учесть
                apartmentNumber: isNaN(parseInt(apartmentNumber)) ? apartmentNumber : parseInt(apartmentNumber, 10),
                newStatus: newStatus
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log("Результат обновления Excel:", result.message);
            if (result.status === 'warning') {
                console.warn("Предупреждение при обновлении Excel:", result.message);
                // Можно показать некритичное уведомление админу/менеджеру
            }
        } else {
            console.error(`Ошибка при обновлении статуса в Excel (${response.status}): ${response.statusText}`);
            // Не блокируем пользователя, т.к. лид создан, но логируем ошибку
            // Можно отправить лог ошибки на бэкенд
        }
    } catch (error) {
        console.error("Сетевая ошибка при обновлении статуса в Excel:", error);
        // Логируем ошибку
    }
}


  document.getElementById('confirmRoleButton').addEventListener('click', async function() {
    var jkName = "{{ lead.complex_name }}";
    var blockName = "{{ lead.block }}";
    var floor = parseInt("{{ lead.floor }}");
    var apartmentNumber = parseInt("{{ lead.number_apartments }}");
    var updates = [{
      jkName: jkName,
      blockName: blockName,
      floor: floor,
      apartmentNumber: apartmentNumber,
      newStatus: "бронь"
    }];

           // Send booking request
    const response = await fetch('/excel/complexes/chess', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ updates: updates })
    });
    const data = await response.json();
    if (!response.ok) {
      // If the apartment is already booked
      if (response.status === 404 && data.detail && data.detail.not_updated) {
        showNotification('Эта квартира уже забронирована и не может быть забронирована.', 'error');
      } else {
        // General error fallback
        const message = typeof data.detail === 'string' ? data.detail : 'Ошибка бронирования';
        showNotification(message, 'error');
      }
      return;
    }
        // Success case
        showNotification('Квартира успешно забронирована!', 'success');
        location.reload();
    closeModalNot();
  });
    </script>
    <script>
    // --- Contract Button logic ---
    async function fetchLastContractNumber(jkName) {
      try {
        const response = await fetch(`/excel/last-contract-number?jkName=${encodeURIComponent(jkName)}`);
        if (!response.ok) {
          if (response.status === 404) return null;
          throw new Error(`Ошибка получения номера договора: ${response.statusText}`);
        }
        const data = await response.json();
        return data.lastContractNumber;
      } catch (error) {
        console.error('Ошибка при получении номера договора:', error);
        return null;
      }
    }

    document.getElementById('contractButton').addEventListener('click', async function() {
      const jkName = "{{ lead.complex_name }}";
      const sellerName = "{{ user.first_name }} {{user.last_name }}";
      const blockName = "{{ lead.block }}";
      const floor = parseInt("{{ lead.floor }}", 10);
      const apartmentNumber = parseInt("{{ lead.number_apartments }}", 10);
      const rooms = {{ lead.rooms }};
      const size = {{ lead.square_meters }};
      const totalPrice = {{ (lead.total_price) | round(2)}};
      const pricePerM2 = {{ lead.square_meters_price }};
      const monthlyPayment = {{ (lead.monthly_payment or 0) | round(2) }}
      const paymentChoice = "{{ lead.down_payment_percent }}";
      {% if lead.down_payment %}
      const initialPayment = {{ (lead.down_payment | round(2)) }};
      {% else %}
      const initialPayment = {{ (lead.total_price | round(2)) }};
      {% endif %}

      const nextContractNumber = await fetchLastContractNumber(jkName) || '';
      openContractModal({
        jkName,
        block: blockName,
        floor,
        apartmentNumber,
        rooms,
        size,
        totalPrice,
        pricePerM2,
        paymentChoice,
        initialPayment,
        monthlyPayment,
        sellerName,
        contractNumber: nextContractNumber,
        
      });
    });
    </script>
    <script>
document.addEventListener('DOMContentLoaded', async function() {
  const jkName = "{{ lead.complex_name }}";
  const blockName = "{{ lead.block }}";
  const floor = parseInt("{{ lead.floor }}");
  const apartmentNumber = parseInt("{{ lead.number_apartments }}");
  const bookingBtn = document.getElementById('bookingButton');
  const contractBtn = document.getElementById('contractButton');
  try {
    const res = await fetch(`/excel/apartment-status?jkName=${encodeURIComponent(jkName)}&blockName=${encodeURIComponent(blockName)}&floor=${floor}&apartmentNumber=${apartmentNumber}`);
    if (res.ok) {
      const data = await res.json();
      if (data.apartmentStatus && data.apartmentStatus.toLowerCase() === 'бронь') {
        bookingBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
        <path opacity="0.5"
          d="M6.92894 41.071C9.85786 44 14.5719 44 24 44C33.428 44 38.1422 44 41.071 41.071C44 38.1422 44 33.428 44 24C44 14.5719 44 9.85786 41.071 6.92894C38.1422 4 33.428 4 24 4C14.5719 4 9.85786 4 6.92894 6.92894C4 9.85786 4 14.5719 4 24C4 33.428 4 38.1422 6.92894 41.071Z"
          fill="#ffc107" />
        <path fill-rule="evenodd" clip-rule="evenodd"
          d="M24 14.5C24.8284 14.5 25.5 15.1716 25.5 16V23.3786L30.0606 27.9394C30.6464 28.5252 30.6464 29.4748 30.0606 30.0606C29.4748 30.6464 28.5252 30.6464 27.9394 30.0606L22.9394 25.0606C22.658 24.7794 22.5 24.3978 22.5 24V16C22.5 15.1716 23.1716 14.5 24 14.5Z"
          fill="#ffc107" />
      </svg>
      <div>Забронировано</div>
    `;
        bookingBtn.classList.add('booked');
      }
      else if (data.apartmentStatus && data.apartmentStatus.toLowerCase() === 'продана') {
        bookingBtn.disabled = true;
        bookingBtn.classList.add('disabled');
        contractBtn.disabled = true;
        contractBtn.classList.add('disabled');
        // Disable all other action buttons when apartment is sold
        const attachBtn = document.querySelector('.attach-apartment-button button');
        // Удалена кнопка фиксации клиента
        if (attachBtn) {
          attachBtn.disabled = true;
          attachBtn.classList.add('disabled');
        }
      }
    }
  } catch (e) {
    console.error('Status fetch error', e);
  }
  bookingBtn.addEventListener('click', function() {
    if (bookingBtn.disabled) return;
    if (bookingBtn.classList.contains('booked')) {
      document.getElementById('unbookingModal').style.display = 'block';
    } else {
      openModalNot({{ lead.id }});
    }
  });

  });

  // Обработчик для кнопки статуса
  const statusBtn = document.getElementById('statusButton');
  statusBtn.addEventListener('click', function() {
    document.getElementById('statusModal').style.display = 'block';
  });

  // Обработчик для кнопки фиксации клиента
  const scheduleCallbackBtn = document.getElementById('scheduleCallbackButton');
  scheduleCallbackBtn.addEventListener('click', function() {
    // Устанавливаем минимальную дату на сегодня
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(9, 0, 0, 0); // 9:00 утра завтра
    
    const dateTimeInput = document.getElementById('callbackDateTime');
    dateTimeInput.min = now.toISOString().slice(0, 16);
    dateTimeInput.value = tomorrow.toISOString().slice(0, 16);
    
    document.getElementById('scheduleCallbackModal').style.display = 'block';
  });

  // Обработчик формы планирования созвона
  document.getElementById('scheduleCallbackForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      const leadId = document.getElementById('leadId').value;
      const callbackDateTime = document.getElementById('callbackDateTime').value;
      const callbackNotes = document.getElementById('callbackNotes').value;
      
      const response = await fetch(`/api/leads/${leadId}/schedule-callback`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          callbackTime: new Date(callbackDateTime).toISOString(),
          notes: callbackNotes
        })
      });

      if (response.ok) {
        showNotification('Созвон успешно запланирован!', 'success');
        closeScheduleCallbackModal();
        
        // После планирования созвона переводим лид в состояние "В работе"
        await fetch(`/api/leads/${leadId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ state: 'IN_WORK' })
        });
        // Обновляем данные на главной странице
        setTimeout(() => {
          if (window.opener && window.opener.loadLeads) {
            window.opener.loadLeads();
          }
        }, 1000);
        
      } else {
        const errorData = await response.json();
        showNotification('Ошибка при планировании созвона: ' + (errorData.detail || 'Неизвестная ошибка'), 'error');
      }
    } catch (error) {
      console.error('Ошибка при планировании созвона:', error);
      showNotification('Ошибка сети при планировании созвона', 'error');
    }
  });

  // Функция закрытия модального окна планирования созвона
  function closeScheduleCallbackModal() {
    document.getElementById('scheduleCallbackModal').style.display = 'none';
    document.getElementById('scheduleCallbackForm').reset();
  }

  // Функция закрытия модального окна статуса
  function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
  }

  // Обработчики для выбора статуса
  document.addEventListener('DOMContentLoaded', function() {
    const statusOptions = document.querySelectorAll('.status-option');
    statusOptions.forEach(option => {
      option.addEventListener('click', async function() {
        const status = this.getAttribute('data-status');
        await updateLeadStatus(status);
        closeStatusModal();
      });
    });
  });





  
  async function updateLeadStatus(status) {
    try {
      const leadId = document.getElementById('leadId').value;
      const response = await fetch(`/api/leads/${leadId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          state: status,

          callbacks: []
        })
      });

      if (response.ok) {
        const statusNames = {
          'NEW': 'Новый',
          'IN_WORK': 'В работе',
          'PROCESSED': 'Обработан',
          'SENT': 'Отправлен',
          'WAITING_RESPONSE': 'Ожидает ответа',
          'CLOSED': 'Закрыт',
          'INACTIVE': 'Неактивен'
        };
        showNotification(`Статус изменен на: ${statusNames[status]} (запланированные созвоны очищены)`, 'success');
        
        // Обновляем данные на главной странице
        setTimeout(() => {
          if (window.opener && window.opener.loadLeads) {
            window.opener.loadLeads();
          }
        }, 1000);
      } else {
        const errorData = await response.json();
        showNotification('Ошибка при изменении статуса: ' + (errorData.detail || 'Неизвестная ошибка'), 'error');
      }
    } catch (error) {
      console.error('Ошибка при изменении статуса:', error);
      showNotification('Ошибка сети при изменении статуса', 'error');
    }
  }

    function closeModal(){
        document.getElementById('contractModal').style.display = 'none'
    }
    function closeUnbookingModal() {
      document.getElementById('unbookingModal').style.display = 'none';
    }

    document.getElementById('confirmUnbookingButton').addEventListener('click', async function() {
      const jkName = "{{ lead.complex_name }}";
      const blockName = "{{ lead.block }}";
      const floor = parseInt("{{ lead.floor }}");
      const apartmentNumber = parseInt("{{ lead.number_apartments }}");
      const updates = [{
        jkName,
        blockName,
        floor,
        apartmentNumber,
        newStatus: "свободна"  // или "доступно" по вашему стандарту
      }];
      const response = await fetch('/excel/complexes/chess', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates })
      });
      const data = await response.json();
      if (response.ok) {
        showNotification('Бронь снята!', 'success');
        closeUnbookingModal();
        const bookingBtn = document.getElementById('bookingButton');
        bookingBtn.classList.remove('booked');
        location.reload()
      } else {
        showNotification(data.detail || 'Ошибка при снятии брони', 'error');
      }
    });
    </script>
<script src="/static/sales_style/complex.js"></script>
<script src="/static/notification-sales.js"></script>
<script src="/static/notification_scripts.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var sqm = parseFloat(document.getElementById('squareMeters').value) || 0;
    var totalInput = document.getElementById('totalPriceInput');
    var priceInput = document.getElementById('pricePerM2Input');
    var monthlyInput = document.getElementById('monthlyPaymentInput');
    var downPayment  = parseFloat(document.getElementById('downPayment').value.replace(/,/g, '')) || 0;
    var period       = parseInt(document.getElementById('installmentPeriod').value, 10) || 1;
  

    function updateTotal() {
      // Remove thousand separators before parsing
      var price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
      var totalValue = sqm * price;
      // Format with commas as thousand separators
      totalInput.value = totalValue.toLocaleString('en-US');
      updateMonthly();
    }
    function updatePrice() {
      var total = parseFloat(totalInput.value.replace(/,/g, '')) || 0;
      var priceValue = sqm ? (total / sqm) : 0;
      priceInput.value = priceValue.toLocaleString('en-US');
      updateMonthly();
    }

    priceInput.addEventListener('input', updateTotal);
    totalInput.addEventListener('input', updatePrice);
  });

  // Функции для редактирования клиента
  function editClientName() {
    const nameElement = document.getElementById('client-name');
    const currentName = nameElement.textContent.trim();
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    input.className = 'edit-input';
    input.style.fontSize = '2.5rem';
    input.style.fontWeight = '400';
    input.style.fontFamily = '"Vela Sans GX"';
    input.style.border = '2px solid #3b82f6';
    input.style.borderRadius = '8px';
    input.style.padding = '8px 12px';
    
    nameElement.innerHTML = '';
    nameElement.appendChild(input);
    input.focus();
    input.select();
    
    function saveName() {
      const newName = input.value.trim();
      if (newName && newName !== currentName) {
        updateClientField('full_name', newName);
      }
      nameElement.textContent = newName || currentName;
    }
    
    function cancelEdit() {
      nameElement.textContent = currentName;
    }
    
    input.addEventListener('blur', saveName);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        saveName();
      } else if (e.key === 'Escape') {
        cancelEdit();
      }
    });
  }

  function editClientPhone() {
    const phoneElement = document.getElementById('client-phone');
    const currentPhone = phoneElement.textContent.trim();
    
    const input = document.createElement('input');
    input.type = 'tel';
    input.value = currentPhone;
    input.className = 'edit-input';
    input.style.fontSize = '1rem';
    input.style.fontWeight = '500';
    input.style.border = '2px solid #3b82f6';
    input.style.borderRadius = '8px';
    input.style.padding = '4px 8px';
    input.style.width = '100%';
    
    phoneElement.innerHTML = '';
    phoneElement.appendChild(input);
    input.focus();
    input.select();
    
    function savePhone() {
      const newPhone = input.value.trim();
      if (newPhone && newPhone !== currentPhone) {
        updateClientField('phone', newPhone);
      }
      phoneElement.textContent = newPhone || currentPhone;
    }
    
    function cancelEdit() {
      phoneElement.textContent = currentPhone;
    }
    
    input.addEventListener('blur', savePhone);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        savePhone();
      } else if (e.key === 'Escape') {
        cancelEdit();
      }
    });
  }

  async function updateClientField(field, value) {
    try {
      const leadId = document.getElementById('leadId').value;
      const response = await fetch(`/api/leads/${leadId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ [field]: value })
      });

      if (response.ok) {
        showNotification(`${field === 'full_name' ? 'Имя' : 'Телефон'} успешно обновлен!`, 'success');
      } else {
        const errorData = await response.json();
        showNotification('Ошибка при обновлении: ' + (errorData.detail || 'Неизвестная ошибка'), 'error');
      }
    } catch (error) {
      console.error('Ошибка при обновлении клиента:', error);
      showNotification('Ошибка сети при обновлении', 'error');
    }
  }
  </script>
</body>

<script>
function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

document.getElementById('deleteLeadButton').addEventListener('click', function() {
  document.getElementById('deleteModal').style.display = 'block';
});

document.getElementById('confirmDeleteButton').addEventListener('click', async function() {
  const leadId = document.getElementById('leadId').value;
  try {
    const response = await fetch(`/api/leads/${leadId}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Ошибка удаления лида');
    // Store notification for main page
    sessionStorage.setItem('notificationMessage', 'Лид успешно удалён');
    sessionStorage.setItem('notificationType', 'success');
    window.location.href = '/dashboard/sales';
  } catch (error) {
    showNotification(error.message, 'error');
  }
});
</script>
<script>
  // Open Inactive Modal
  document.getElementById('markInactiveButton').addEventListener('click', function() { 
    document.getElementById('inactiveModal').style.display = 'block';
  });
  // Close Inactive Modal
  function closeInactiveModal() {
    document.getElementById('inactiveModal').style.display = 'none';
  }
  // Confirm Inactivation
  document.getElementById('confirmInactiveButton').addEventListener('click', async function() {
    const leadId = document.getElementById('leadId').value;
    try {
      const response = await fetch(`/api/leads/${leadId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: 'INACTIVE' })
      });
      if (!response.ok) throw new Error('Не удалось обновить статус лида');
      showNotification('Лид помечен неактуальным', 'success');
      closeInactiveModal();
      // Optionally, redirect or reload to refresh UI
      location.reload();
    } catch (error) {
      showNotification(error.message, 'error');
    }
  });
</script>
</html>

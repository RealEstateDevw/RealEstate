<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/complexes-style.css">
    <style>* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f8f9fa;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .back-button {
            font-size: 20px;
            color: #333;
            margin-right: 15px;
            cursor: pointer;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-button {
            display: flex;
            align-items: center;
            background-color: #f0f2f5;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-button.active {
            background-color: #e6f0ff;
            color: #0066ff;
        }

        .filter-icon {
            margin-right: 8px;
            color: #0066ff;
        }

        .dropdown-icon {
            margin-left: 5px;
        }

        .search-container {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f0f2f5;
            border-radius: 20px;
            padding: 8px 15px;
            margin-right: 15px;
        }

        .search-icon {
            color: #999;
            margin-right: 8px;
        }

        .search-input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            width: 120px;
        }

        .profile-icon {
            width: 35px;
            height: 35px;
            background-color: #0066ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        #complexes-container {
    display: none; /* Скрыт по умолчанию */
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    padding: 20px;
    background-color: #fff; /* Белый фон */
}

.complex-card, .complex-card-info {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    text-align: center;
    width: 200px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}


.complex-card-info {
    position: relative;
  display: inline-block;
}

.complex-card img, .complex-card-info img {
    display: block;
    width: 100%;
    border-radius: 5px;
}
.hover-area {
  position: absolute;
  /* Задайте координаты и размеры нужной области */
  /* Например, top, left, width, height задаются inline или через класс */
  background-color: rgba(255, 255, 255, 0); /* изначально прозрачный */
  transition: transform 0.3s, background-color 0.3s;
  cursor: pointer;
}

/* Эффект при наведении */
.hover-area:hover {
  transform: scale(1.1);
  background-color: rgba(255, 255, 255, 0.2); /* легкий светлый оверлей */
}

#jk-details-container {
    display: flex;
    /* flex-direction: column;
    align-items: center; */
    gap: 1rem;
    padding: 1rem;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-width: 1200px;
    margin: 20px auto;
  }

  /* Стили для изображения */
  .jk-render-image {
    display: block;
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  /* Контейнер кнопок */
  .blocks-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-top: 1rem;
  }

  /* Стили для кнопок */
  .block-button {
    padding: 10px 20px;
    border: none;
    background-color: #007bff;
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .block-button:hover {
    background-color: #0056b3;
  }


  /* Каждый этаж (floor-container) идёт отдельным блоком */
.floor-container {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  background-color: #ffffff;
  padding: 0.5rem;
  border-radius: 4px;
}

/* Метка этажа (цифра) */
.floor-label {
  flex-shrink: 0;
  width: 50px;
  font-weight: bold;
  font-size: 1.2rem;
  color: #424242;
  text-align: center;
  margin-right: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #e0e0e0;
  border-radius: 4px;
}

/* Сетка квартир на этаже */
.apartment-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem; /* Расстояние между карточками */
  flex: 1;     /* Занимает всё доступное пространство */
}

/* Общий стиль карточки квартиры */
.apartment-card {
  flex: 0 0 calc(14.28% - 0.5rem); /* 7 карточек в ряд, при необходимости подберите другое значение */
  box-sizing: border-box;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 20px;
  padding: 0.5rem;
  min-height: 100px;
  display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 12px;
    box-sizing: border-box;

  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* При наведении делаем карточку чуть «выше» */
.apartment-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.card-header {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    font-weight: 500;
  }

  /* Центральный элемент — крупная цена */
  .card-price {
    font-size: 24px;
    margin: 4px 0;  /* Небольшие отступы сверху и снизу */
    line-height: 1.2;
  }

  /* Нижняя строка: "47.6 м2" слева, "сум" справа */
  .card-footer {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    font-weight: 500;
  }
  .apartment-card.available {
    background: #04E762; /* светло-зелёный */
  border: 1px solid #04E762;
  color: #fff;
}

.apartment-card.sold {
    background: #CCD0D2; /* светло-серый */
  border: 1px solid #CCD0D2;
}

.apartment-card.reserved {
    background: #F5B700; /* светло-серый */
  border: 1px solid #F5B700;
  color: #fff;
}

.apartment-card.unavailable {
  background-color: #eeeeee;
  border: 1px solid #bdbdbd;
}
/* Кнопка «Назад к выбору блоков» */
.back-button {
  position: fixed;
  top: 1rem;
  left: 1rem;
  padding: 0.5rem 1rem;
  background-color: #2196f3;
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  z-index: 999; /* Чтобы кнопка была поверх остальных элементов */
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.back-button:hover {
  background-color: #1976d2;
}
        </style>
</head>
<body>
<header class="header">
        <div class="filter-options">
            <div class="filter-button">
                <i class="fas fa-filter filter-icon"></i>
                Шахматка
            </div>
            <button class="filter-button"  onclick="showComplexes()">
                <i class="fas fa-th filter-icon"></i>
                Шахматка +
            </button>
            <div class="filter-button">
                <i class="fas fa-building filter-icon"></i>
                Фасады
            </div>
            <div class="filter-button">
                Тип
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="filter-button">
                Комнат
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="filter-button">
                Цена
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="filter-button">
                Площадь
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="filter-button">
                Акции
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
        </div>
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Поиск">
            </div>
            <div class="profile-icon">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>
    <div id="complexes-container" style="display: none;"></div>
    <div id="jk-details-container" style="display: none;"></div>

<script>
    async function fetchData(url, errorMessage) {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`${errorMessage}: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error(`${errorMessage}:`, error);
        throw error;
    }
}
async function showComplexes() {
    try {
        // Делаем запрос к серверу
        const response = await fetch('/api/complexes');
        const result = await response.json();

        if (result.status === "success") {
            complexesContainer = document.getElementById("complexes-container")
            // Очищаем контейнер ЖК и делаем его видимым
            complexesContainer.innerHTML = "";
            complexesContainer.style.display = "flex";

            // Создаем карточки ЖК
            result.complexes.forEach(complex => {
                const card = document.createElement("div");
                card.className = "complex-card";
                card.setAttribute("data-jk-name", complex.name); // Указываем имя ЖК

                card.innerHTML = `
                    <img src="${complex.render}" alt="Рендер ${complex.name}" class="complex-image">
                    <h3 class="complex-title">${complex.name}</h3>
                     
                `;

                complexesContainer.appendChild(card);
            });

            // // Назад на главную
            // const backButton = document.createElement("button");
            // backButton.textContent = 'Назад на главную страницу';
            // backButton.className = 'back-button top-left';
            // backButton.addEventListener('click', () => {
            //     complexesContainer.style.display = 'none'; // Скрываем контейнер ЖК
            //     homeContainer.style.display = 'block'; // Показываем главный контейнер
            //     if (navbar) navbar.style.display = 'flex'; // Показываем меню
            //     // Показываем слайды снова
            //     const slides = document.querySelectorAll(".slide");
            //     slides.forEach(slide => {
            //         slide.style.display = "block";
            //     });
            // });
            // complexesContainer.appendChild(backButton);
        } else {
            console.error('Ошибка загрузки ЖК: ', result.message);
            alert('Ошибка загрузки ЖК: ' + result.message);
        }
    } catch (error) {
        console.error("Ошибка загрузки ЖК:", error);
        alert('Ошибка загрузки ЖК: ' + error.message);
    }
}

let globalShaxmatkaData = null;
let globalRenderImage = null;
// Глобальная переменная для хранения выбора пользователя
let userSelection = {
    totalPrice: null,
    pricePerM2: null
};
// Глобальная переменная для хранения выбора тип оплаты 30,50,70 или 100%
let selectedPaymentOption = ''; // Явно задайте начальное значение
// Глобальная переменная для хранения первоначального взноса
let initialPayment = null;
console.log('Initial Payment:', initialPayment); // Отладка

// Функция для отображения данных ЖК на сайте
function showJKDetails(shaxmatkaData, renderImage, jkName) {
    globalShaxmatkaData = shaxmatkaData; // Сохраняем данные в глобальную переменную
    globalRenderImage = renderImage; // Сохраняем renderImage в глобальной переменной
    // Обновляем глобальную переменную

    const complexesContainer = document.getElementById("complexes-container");
    const jkDetailsContainer = document.getElementById("jk-details-container");

    // Скрываем другие секции

    complexesContainer.style.display = "none";
    // jkDetailsContainer.style.display = "block";

    // Очищаем контейнер
    jkDetailsContainer.innerHTML = "";
    jkDetailsContainer.style.display = "inline-block"
    jkDetailsContainer.style.position = "relative"
    // Логируем путь к изображению
    console.log(`Проверка пути к изображению: ${renderImage}`);



    // Отображаем первую картинку из папки render
    const image = document.createElement("img");
    console.log(`Путь к изображению: ${renderImage}`);
    image.src = renderImage; // Передаём путь к первой картинке
    image.alt = `Рендер ЖК ${jkName}`;
    image.className = "jk-render-image";
    jkDetailsContainer.appendChild(image);

    // Добавляем кнопки блоков
    const uniqueBlocks = [...new Set(shaxmatkaData.map(row => row[0]))];
    const blocksContainer = document.createElement("div");
    blocksContainer.className = "blocks-container";
    uniqueBlocks.forEach(block => {
        const button = document.createElement("button");
        button.textContent = `${block}`;
        button.className = "block-button";
        button.addEventListener("click", () => {
            console.log(`Выбран блок: ${block}`);
            filterBlockData(shaxmatkaData, block, renderImage, jkName);
        });
        blocksContainer.appendChild(button);
    });

    jkDetailsContainer.appendChild(blocksContainer);
    const backButtonToComplexes = document.createElement("button");
    backButtonToComplexes.textContent = "Назад к ЖК";
    backButtonToComplexes.className = "back-button top-left";
    backButtonToComplexes.addEventListener("click", () => {
        jkDetailsContainer.style.display = "none";
        complexesContainer.style.display = "flex";
    });
    jkDetailsContainer.appendChild(backButtonToComplexes);
}

document.addEventListener('DOMContentLoaded', function () {
    const complexesContainer = document.getElementById("complexes-container");

    complexesContainer.addEventListener('click', async function (event) {
        const card = event.target.closest(".complex-card");
        if (card) {
            const jkName = card.getAttribute("data-jk-name");
            console.log(`Выбран ЖК: ${jkName}`);

            try {
                const response = await fetch(`/api/complexes/jk/${jkName}`);
                const result = await response.json();

                if (result.status === "success") {
                    console.log("Данные ЖК:", result);

                    // Открываем страницу с ЖК
                    showJKDetails(result.shaxmatka, result.render, jkName);
                } else {
                    alert(`Ошибка: ${result.message}`);
                }
            } catch (error) {
                console.error("Ошибка при загрузке данных ЖК:", error);
            }
        }
    });
});

function filterBlockData(shaxmatkaData, block, renderImage, jkName) {
    console.log("Проверка данных shaxmatkaData:", shaxmatkaData);
    const jkDetailsContainer = document.getElementById("jk-details-container");
    jkDetailsContainer.style.maxWidth = "100%";

    // Фильтруем данные по блоку
    const filteredData = shaxmatkaData.filter(row => row[0] === block);

    // Группируем данные по этажам
    const floors = filteredData.reduce((acc, row) => {
        const floor = row[6]; // Этаж
        if (!acc[floor]) acc[floor] = [];
        acc[floor].push(row);
        return acc;
    }, {});

    // Очищаем контейнер
    jkDetailsContainer.innerHTML = "";

    // Создаем структуру для этажей
    Object.keys(floors).sort((a, b) => b - a).forEach(floor => {
        const floorContainer = document.createElement("div");
        floorContainer.className = "floor-container";

        const floorLabel = document.createElement("div");
        floorLabel.className = "floor-label";
        floorLabel.textContent = `${floor}`;
        floorContainer.appendChild(floorLabel);

        const apartmentGrid = document.createElement("div");
        apartmentGrid.className = "apartment-grid";

        floors[floor].forEach(row => {
            const statusMap = {
                "свободна": "available",
                "продана": "sold",
                "бронь": "booked"
            };
            const status = row[2].trim();
            const mappedStatus = statusMap[status] || "unknown";
            const apartmentCard = document.createElement("div");
            apartmentCard.className = `apartment-card ${mappedStatus}`;

            if (!jkName || !block || !row[5]) {
                console.warn("Некорректные данные для квартиры:", { jkName, block, size: row[5] });
                return;
            }

            // Извлекаем количество комнат из row[3]
            const rooms = row[3] || "Не указано";

            apartmentCard.setAttribute("data-jk-name", jkName);
            apartmentCard.setAttribute("data-block", block);
            apartmentCard.setAttribute("data-size", row[5]);
            apartmentCard.setAttribute("data-floor", row[6]);
            apartmentCard.setAttribute("data-number", row[4]);
            apartmentCard.setAttribute("data-rooms", rooms);

            console.log("Filtered Data Row:", row);

            const price = status === "свободна" && row.length > 7
                ? `от ${Number(row[7]).toLocaleString('ru-RU')} сум`
                : "";
            const cleanedPrice = price
                .replace(/от\s*/gi, "")
                .replace(/сум\s*/gi, "")
                .trim();

            apartmentCard.innerHTML = `
                <div class="card-header">
                    <span>${row[1] || "Тип не указан"}</span>
                    <span>№${row[4] || "Номер кв не указан"}</span>
                </div>
                <div class="card-price">
                    ${price 
                        ? `<p class="card-price">${cleanedPrice}</p>` 
                        : `<p class="card-status">${row[2] || "Неизвестно"}</p>`}
                </div>
                <div class="card-footer">
                    <span>${row[5] || "-"} м</span>
                    <span>сум</span>
                </div>
            `;
            apartmentGrid.appendChild(apartmentCard);
        });

        floorContainer.appendChild(apartmentGrid);
        jkDetailsContainer.appendChild(floorContainer);
    });

    // Добавляем кнопку "Назад к выбору блоков"
    const backButton = document.createElement("button");
    backButton.textContent = "Назад к выбору блоков";
    backButton.className = "back-button top-left";
    backButton.addEventListener("click", () => {
        jkDetailsContainer.innerHTML = ""; // Очищаем данные блока
        showJKDetails(shaxmatkaData, renderImage, jkName); // Передаем изображение заново
    });
    jkDetailsContainer.appendChild(backButton);
}

async function fetchPlanImage(jkName, blockName, apartmentSize) {
    const url = `/api/complexes/plan-image?jkName=${encodeURIComponent(jkName)}&blockName=${encodeURIComponent(blockName)}&apartmentSize=${encodeURIComponent(apartmentSize)}`;
    try {
        const response = await fetch(url);
        if (response.ok) {
            return URL.createObjectURL(await response.blob());
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || "Ошибка загрузки изображения.");
        }
    } catch (error) {
        console.error("Ошибка при загрузке изображения планировки:", error);
        throw error;
    }
}

// Функция для очистки контейнера
function clearContainer(containerId) {
    const container = document.getElementById(containerId);
    if (container) container.innerHTML = '';
}

// Функция для обновления поля выбора оплаты (30, 50, 70 или 100% оплаты)
function updatePaymentChoice(paymentPercentage) {
    selectedPaymentOption = paymentPercentage; // Устанавливаем текущий выбор
    const paymentChoiceInput = document.querySelector('input[name="paymentChoice"]');
    if (paymentChoiceInput) {
        paymentChoiceInput.value = `${paymentPercentage}%`;
    }
}

// Функция для обработки клика по карточке квартиры
document.body.addEventListener('click', async function (event) {
    // Ищем ближайший родительский элемент с классом 'apartment-card'
    // Это делает клик более надежным, если внутри карточки есть другие элементы
    const card = event.target.closest('.apartment-card');

    if (card) {
        // Получаем данные из атрибутов карточки
        const jkName = card.getAttribute("data-jk-name");
        const blockName = card.getAttribute("data-block");
        const apartmentSize = card.getAttribute("data-size");
        const floor = card.getAttribute("data-floor");
        const apartmentNumber = card.getAttribute("data-number");
        const rooms = card.getAttribute("data-rooms"); // Получаем кол-во комнат

        // --- Глобальные переменные для хранения выбора пользователя ---
        // (Лучше определить их вне обработчика, если они нужны глобально,
        // но для примера оставим здесь с возможностью обновления)
        let userSelection = {
            totalPrice: 0,
            pricePerM2: 0,
            paymentChoice: null // Хранит выбранный процент (100, 70, 50, 30) или 'hybrid'
        };
        let initialPayment = 0; // Хранит сумму первого взноса
        let selectedPaymentOption = null; // Хранит выбранный процент (число)
        // --- Конец глобальных переменных ---

        function updatePaymentChoice(percentage) {
            console.log('Updating Payment Choice:', percentage);
            selectedPaymentOption = percentage;
            userSelection.paymentChoice = percentage;
        }

        function updateInitialPayment(amount) {
            console.log('Updating Initial Payment:', amount);
            initialPayment = amount;
            // Обновляем поле в модальном окне, если оно открыто
            const initialPaymentInputModal = document.querySelector(".custom-modal #initialPayment");
            if (initialPaymentInputModal) {
                initialPaymentInputModal.value = Number(amount).toLocaleString('ru-RU');
            }
        }

         // --- Вспомогательные функции для запросов (предполагаем, что они существуют) ---
         

         async function fetchData(url, errorMessage) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`${errorMessage}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                alert(error.message);
                throw error; // Пробрасываем ошибку дальше
            }
         }

         function clearContainer(containerId) {
             const container = document.getElementById(containerId);
             if (container) {
                 container.innerHTML = '';
                 container.style.display = 'none'; // Скрываем контейнер при очистке
             }
         }
         // --- Конец вспомогательных функций ---


        if (!jkName || !blockName || !apartmentSize || !floor || !apartmentNumber || !rooms) {
            console.error("Отсутствуют данные для запроса:", { jkName, blockName, apartmentSize, floor, apartmentNumber, rooms });
            alert("Не хватает данных для выполнения запроса. Проверьте data-атрибуты карточки.");
            return;
        }

        try {
            // 1. Получаем изображение планировки
            const planImagePath = await fetchPlanImage(jkName, blockName, apartmentSize);
            console.log(`Путь к изображению: ${planImagePath}`);

            // 2. Получаем данные о квартире
            const apiUrl = `/api/complexes/apartment-info?jkName=${encodeURIComponent(jkName)}&blockName=${encodeURIComponent(blockName)}&apartmentSize=${encodeURIComponent(apartmentSize)}&floor=${encodeURIComponent(floor)}`;
            const apartmentInfo = await fetchData(apiUrl, "Ошибка получения информации о квартире");

            if (apartmentInfo.status === "success") {
                const {
                    pricePerM2_100 = 0, // Предоставляем значения по умолчанию
                    pricePerM2_70 = 0,
                    pricePerM2_50 = 0,
                    pricePerM2_30 = 0,
                    total_price = 0, // Используем это как базовую цену "от"
                    status = "неизвестно",
                    months_left = 0
                } = apartmentInfo.data;

                // --- Константы для текстов (лучше вынести наружу, если много) ---
                const AREA_LABEL = "Площадь";
                const ENTRANCE_LABEL = "Подъезд"; // Или Блок? Уточнить по данным
                const DEADLINE_LABEL = "Срок сдачи";
                const DETAILS_LABEL = "Подробнее";
                const DISCOUNT_TITLE = "Скидка 20%"; // Заменить на динамическое, если возможно
                const DISCOUNT_CONDITION = "Действует до 12.10.2025"; // Заменить на динамическое, если возможно
                const INSTALLMENT_TITLE = `Рассрочка от 10%`; // Заменить на динамическое, если возможно
                const SUBMIT_BUTTON_TEXT = "Отправить заявку";
                const BACK_BUTTON_TEXT = 'Назад к выбору квартиры';
                const PRINT_BUTTON_TEXT = "Печать";

                // 3. Очищаем контейнер перед отображением данных
                const jkDetailsContainer = document.getElementById('jk-details-container');
                clearContainer('jk-details-container'); // Очищаем и скрываем

                // --- СОЗДАНИЕ НОВОЙ HTML СТРУКТУРЫ ---

                // --- Левая колонка: План ---
                const apartmentPlanSection = document.createElement('div');
                apartmentPlanSection.className = 'apartment-plan-section';

                const planTitle = document.createElement('h2');
                planTitle.className = 'plan-section-title';
                // Используем `rooms` и `floor` для заголовка
                planTitle.textContent = `${rooms}-комнатная квартира, ${floor} этаж`;
                apartmentPlanSection.appendChild(planTitle);

                const planImageWrapper = document.createElement('div');
                planImageWrapper.className = 'plan-image-wrapper';
                const planImage = document.createElement('img');
                planImage.className = 'plan-image';
                planImage.src = planImagePath;
                planImage.alt = `План ${rooms}-комнатной квартиры, ${apartmentSize} м²`;
                planImageWrapper.appendChild(planImage);
                apartmentPlanSection.appendChild(planImageWrapper);

                // Добавляем статичные кнопки управления под планом (как в примере HTML)
                const planControls = document.createElement('div');
                planControls.className = 'plan-controls';
                planControls.innerHTML = `
                     <button class="plan-nav-btn" aria-label="Предыдущий план">
                         <i class="fa-solid fa-arrow-left"></i>
                     </button>
                     <button class="plan-nav-btn" aria-label="Следующий план">
                         <i class="fa-solid fa-arrow-right"></i>
                     </button>
                     <div class="plan-actions">
                         <button class="plan-action-btn" aria-label="Печать плана">
                             <i class="fa-solid fa-print"></i>
                         </button>
                         <button class="plan-action-btn" aria-label="Скачать план">
                              <i class="fa-solid fa-download"></i> <!-- Заменил share на download -->
                         </button>
                         <button class="plan-action-btn" aria-label="Добавить в избранное">
                             <i class="fa-regular fa-thumbs-up"></i>
                         </button>
                     </div>`;
                apartmentPlanSection.appendChild(planControls);


                // --- Правая колонка: Инфо-карточка ---
                const infoCardDiv = document.createElement('div');
                infoCardDiv.className = 'info-card';

                // Шапка карточки
                const infoCardHeader = document.createElement('div');
                infoCardHeader.className = 'info-card-header';

                const infoCardTitle = document.createElement('h3');
                infoCardTitle.className = 'info-card-title';
                infoCardTitle.textContent = `${rooms}-комнатная квартира`; // Заголовок карточки
                infoCardHeader.appendChild(infoCardTitle);

                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge';
                statusBadge.textContent = status;
                // Добавляем класс в зависимости от статуса
                const statusLower = status.toLowerCase().trim();
                if (statusLower === 'свободна') {
                    statusBadge.classList.add('status-available');
                } else if (statusLower === 'продана') {
                     statusBadge.classList.add('status-sold'); // Добавьте стиль для .status-sold в CSS
                } else if (statusLower === 'бронь') {
                     statusBadge.classList.add('status-reserved'); // Добавьте стиль для .status-reserved в CSS
                }
                infoCardHeader.appendChild(statusBadge);

                
                infoCardDiv.appendChild(infoCardHeader);

                // Сетка информации
                const infoGrid = document.createElement('div');
                infoGrid.className = 'info-grid';

                // -- Блок Площадь --
                const areaBlock = document.createElement('div');
                areaBlock.className = 'info-block';
                areaBlock.innerHTML = `
                    <span class="info-label">${AREA_LABEL}</span>
                    <span class="info-value area">${apartmentSize} м²</span>`; // Используем кв² или м²? На картинке кв²
                infoGrid.appendChild(areaBlock);

                // -- Блок Подъезд/Блок -- (Используем blockName)
                const entranceBlock = document.createElement('div');
                entranceBlock.className = 'info-block';
                entranceBlock.innerHTML = `
                    <span class="info-label">${ENTRANCE_LABEL}</span>
                    <span class="info-value">${blockName}</span>`; // Используем blockName, как наиболее релевантное
                infoGrid.appendChild(entranceBlock);

                // -- Блок Срок Сдачи -- (Заглушка, т.к. данных нет в API)
                const deadlineBlock = document.createElement('div');
                deadlineBlock.className = 'info-block';
                deadlineBlock.innerHTML = `
                    <span class="info-label">${DEADLINE_LABEL}</span>
                    <span class="info-value">Уточняется</span>`; // Placeholder
                infoGrid.appendChild(deadlineBlock);

                // -- Блок Подробнее -- (Ссылка-заглушка)
                const detailsLinkBlock = document.createElement('a');
                detailsLinkBlock.href = '#'; // Заглушка
                detailsLinkBlock.className = 'info-block details-link-block';
                 detailsLinkBlock.innerHTML = `
                     <span class="info-label">${DETAILS_LABEL}</span>
                     <i class="fa-solid fa-arrow-right"></i>`;
                 detailsLinkBlock.addEventListener('click', (e) => e.preventDefault()); // Предотвращаем переход по ссылке
                 infoGrid.appendChild(detailsLinkBlock);

                infoCardDiv.appendChild(infoGrid);

                // Блоки скидок/рассрочки (Пока статичные, как на картинке)
                const offerBlockDiscount = document.createElement('div');
                offerBlockDiscount.className = 'offer-block discount';
                offerBlockDiscount.innerHTML = `
                    <span class="offer-title">${DISCOUNT_TITLE}</span>
                    <span class="offer-condition">${DISCOUNT_CONDITION}</span>`;
                infoCardDiv.appendChild(offerBlockDiscount);

                const offerBlockInstallment = document.createElement('div');
                offerBlockInstallment.className = 'offer-block installment';
                 // Добавляем динамическую информацию о месяцах, если она есть
                 const installmentTitleText = months_left > 0
                    ? `${INSTALLMENT_TITLE} на ${months_left} мес.`
                    : INSTALLMENT_TITLE;
                offerBlockInstallment.innerHTML = `
                    <span class="offer-title">${installmentTitleText}</span>`;
                infoCardDiv.appendChild(offerBlockInstallment);


                // Секция цены
                const priceSection = document.createElement('div');
                priceSection.className = 'price-section';

                const totalPriceP = document.createElement('p');
                totalPriceP.className = 'total-price';
                // Отображаем базовую цену "от" (pricePerM2_30 * size) или total_price из API?
                // Используем total_price из API как стартовую общую цену
                totalPriceP.textContent = `${Number(total_price).toLocaleString('ru-RU')} сум`;
                priceSection.appendChild(totalPriceP);

                const pricePerMeterP = document.createElement('p');
                pricePerMeterP.className = 'price-per-meter';
                 // Отображаем цену за м² "от" (pricePerM2_30)
                pricePerMeterP.innerHTML = `
                    <span class="currency-icon"><i class="fa-solid fa-dollar-sign"></i></span>
                    ${Number(pricePerM2_30).toLocaleString('ru-RU')} сум за м²`;
                priceSection.appendChild(pricePerMeterP);
                infoCardDiv.appendChild(priceSection);

                // --- ДИНАМИЧЕСКИЕ КНОПКИ И ЛОГИКА ---
                 // Контейнер для кнопок выбора оплаты и результатов расчета
                 const paymentActionsContainer = document.createElement('div');
                 paymentActionsContainer.className = 'payment-actions-container'; // Добавьте стили, если нужно
                 paymentActionsContainer.style.marginTop = "1rem"; // Добавим отступ
                 infoCardDiv.appendChild(paymentActionsContainer); // Добавляем в карточку

                 const buttonsContainer = document.createElement("div");
                 buttonsContainer.className = "buttons-container"; // Можно оставить старый класс или переименовать
                 buttonsContainer.style.display = "flex"; // Расположим кнопки в ряд
                 buttonsContainer.style.gap = "10px"; // Промежуток между кнопками
                 buttonsContainer.style.flexWrap = "wrap"; // Перенос кнопок
                 buttonsContainer.style.marginBottom = "10px";

                 const resultContainer = document.createElement("div");
                 resultContainer.className = "result-container";
                 resultContainer.style.marginTop = "10px";
                 resultContainer.style.padding = "10px";
                 resultContainer.style.backgroundColor = "#fff"; // Добавим фон для читаемости
                 resultContainer.style.borderRadius = "8px";


                // Если квартира свободна, добавляем кнопки для расчетов
                if (statusLower === "свободна") {
                    // Кнопка 100% Оплата
                    const fullPaymentButton = document.createElement("button");
                    fullPaymentButton.textContent = "100% Оплата";
                    fullPaymentButton.className = 'payment-option-btn'; // Добавим класс для стилизации
                    fullPaymentButton.addEventListener("click", () => {
                        updatePaymentChoice(100);
                        const fullPrice_100 = pricePerM2_100 * parseFloat(apartmentSize.replace(',', '.'));
                        const economy = total_price - fullPrice_100; // Считаем экономию от базовой цены
                        userSelection.totalPrice = fullPrice_100;
                        userSelection.pricePerM2 = pricePerM2_100;
                        updateInitialPayment(fullPrice_100); // При 100% оплате первый взнос равен всей сумме
                        resultContainer.innerHTML = `
                            <p><strong>Стоимость квартиры (100%):</strong> ${fullPrice_100.toLocaleString('ru-RU')} сум</p>
                            ${economy > 0 ? `<p><strong>Экономия:</strong> ${economy.toLocaleString('ru-RU')} сум</p>` : ""}
                        `;
                        // Подсвечиваем активную кнопку
                         document.querySelectorAll('.payment-option-btn').forEach(btn => btn.classList.remove('active'));
                         fullPaymentButton.classList.add('active');
                    });
                    buttonsContainer.appendChild(fullPaymentButton);

                    // Кнопка Рассрочка (открывает опции 30/50/70)
                    const installmentButton = document.createElement("button");
                    installmentButton.textContent = "Рассрочка";
                    installmentButton.className = 'payment-option-btn';
                    installmentButton.addEventListener("click", () => {
                        resultContainer.innerHTML = ""; // Очищаем предыдущие результаты
                        const installmentOptions = document.createElement("div");
                        installmentOptions.className = "installment-options";
                        installmentOptions.style.display = "flex";
                        installmentOptions.style.gap = "5px";
                        installmentOptions.style.marginBottom = "10px";

                        [70, 50, 30].forEach((percentage) => {
                            const button = document.createElement("button");
                            button.textContent = `${percentage}%`;
                            button.className = 'installment-percent-btn'; // Класс для стилизации
                            button.style.marginRight = "5px";
                            button.addEventListener("click", () => {
                                updatePaymentChoice(percentage);
                                let pricePerM2;
                                switch (percentage) {
                                    case 70: pricePerM2 = pricePerM2_70; break;
                                    case 50: pricePerM2 = pricePerM2_50; break;
                                    case 30: pricePerM2 = pricePerM2_30; break;
                                    default: pricePerM2 = pricePerM2_30; // По умолчанию
                                }
                                const totalPrice_R = pricePerM2 * parseFloat(apartmentSize.replace(',', '.'));
                                const currentInitialPayment = totalPrice_R * (percentage / 100);
                                const remaining = totalPrice_R - currentInitialPayment;
                                const months = months_left > 0 ? months_left : 1; // Избегаем деления на 0
                                const monthlyPayment = remaining / months;
                                const economy = total_price - totalPrice_R; // Экономия от базовой цены
                                userSelection.totalPrice = totalPrice_R;
                                userSelection.pricePerM2 = pricePerM2;
                                updateInitialPayment(currentInitialPayment); // Обновляем первый взнос
                                resultContainer.innerHTML = `
                                    <p><strong>Рассрочка (${percentage}%):</strong></p>
                                    <p>Стоимость квартиры: ${totalPrice_R.toLocaleString('ru-RU')} сум</p>
                                    <p>Первоначальный взнос: ${currentInitialPayment.toLocaleString('ru-RU')} сум</p>
                                    ${months_left > 0 ? `<p>Ежемесячная оплата (${months} мес.): ${Math.round(monthlyPayment).toLocaleString('ru-RU')} сум</p>` : '<p>Срок рассрочки не указан.</p>'}
                                    ${economy > 0 ? `<p><strong>Экономия:</strong> ${economy.toLocaleString('ru-RU')} сум</p>` : ""}
                                `;
                                // Подсвечиваем активную кнопку
                                document.querySelectorAll('.installment-percent-btn').forEach(btn => btn.classList.remove('active'));
                                button.classList.add('active');
                            });
                            installmentOptions.appendChild(button);
                        });
                        resultContainer.appendChild(installmentOptions);

                        // Подсвечиваем кнопку "Рассрочка"
                         document.querySelectorAll('.payment-option-btn').forEach(btn => btn.classList.remove('active'));
                         installmentButton.classList.add('active');
                    });
                    buttonsContainer.appendChild(installmentButton);

                    // Кнопка Гибридная Рассрочка (если подходит площадь)
                     // Пример площадей, где доступна гибридная рассрочка
                    const allowedHybridSizes = [88.42]; // Замените на актуальные
                    if (allowedHybridSizes.includes(parseFloat(apartmentSize.replace(',', '.')))) {
                        const hybridButton = document.createElement("button");
                        hybridButton.textContent = "Гибридная";
                        hybridButton.className = 'payment-option-btn';
                        hybridButton.addEventListener("click", () => {
                            updatePaymentChoice('hybrid'); // Используем строку для гибридного варианта
                             const percentage = 30; // Гибрид базируется на 30% цене
                             const pricePerM2 = pricePerM2_30;
                             const totalPrice_Hybrid = pricePerM2 * parseFloat(apartmentSize.replace(',', '.'));
                             const currentInitialPayment = totalPrice_Hybrid * 0.3; // Первый взнос 30%
                             const middlePaymentTotal = totalPrice_Hybrid * 0.4; // Средняя часть 40%
                             const lastPayment = totalPrice_Hybrid * 0.3; // Последний платеж 30%
                             const months = months_left > 0 ? months_left : 1;
                             const monthlyPayment = middlePaymentTotal / months;

                             userSelection.totalPrice = totalPrice_Hybrid;
                             userSelection.pricePerM2 = pricePerM2;
                             // Для гибрида initialPayment тоже 30%
                             updateInitialPayment(currentInitialPayment);

                             resultContainer.innerHTML = `
                                <p><strong>Гибридная Рассрочка:</strong></p>
                                <p>Стоимость квартиры: ${totalPrice_Hybrid.toLocaleString('ru-RU')} сум</p>
                                <p>Первоначальный взнос (30%): ${Math.round(currentInitialPayment).toLocaleString('ru-RU')} сум</p>
                                ${months_left > 0 ? `<p>Ежемесячная оплата (${months} мес.): ${Math.round(monthlyPayment).toLocaleString('ru-RU')} сум</p>` : '<p>Срок рассрочки не указан.</p>'}
                                <p>Последний платеж (30%): ${Math.round(lastPayment).toLocaleString('ru-RU')} сум</p>
                            `;
                             // Подсвечиваем активную кнопку
                             document.querySelectorAll('.payment-option-btn').forEach(btn => btn.classList.remove('active'));
                             hybridButton.classList.add('active');
                        });
                        buttonsContainer.appendChild(hybridButton);
                    }

                    paymentActionsContainer.appendChild(buttonsContainer); // Добавляем контейнер с кнопками выбора
                    paymentActionsContainer.appendChild(resultContainer); // Добавляем контейнер для результатов

                     // --- Кнопки Бронирования и Договора ---
                     const actionButtonsContainer = document.createElement('div');
                     actionButtonsContainer.className = 'action-buttons-container';
                     actionButtonsContainer.style.marginTop = '1rem';
                     actionButtonsContainer.style.display = 'flex';
                     actionButtonsContainer.style.flexDirection = 'column'; // Кнопки друг под другом
                     actionButtonsContainer.style.gap = '10px';

                    // Кнопка "Забронировать" и форма
                    const reserveButton = document.createElement("button");
                    reserveButton.textContent = "Забронировать";
                    reserveButton.className = "reserve-button action-btn"; // Добавим общий класс action-btn

                    const reserveFormContainer = document.createElement("div");
                    reserveFormContainer.className = "reserve-form-container";
                    reserveFormContainer.style.display = "none";
                    reserveFormContainer.style.marginTop = "10px";
                    reserveFormContainer.style.padding = "10px";
                    reserveFormContainer.style.backgroundColor = "#fff";
                    reserveFormContainer.style.borderRadius = "8px";
                    reserveFormContainer.innerHTML = `
                        <form class="reserve-form">
                            <label for="reserve_name" style="display: block; margin-bottom: 5px;"><strong>Имя:</strong></label>
                            <input type="text" id="reserve_name" name="name" placeholder="Введите ваше имя" required style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <label for="reserve_phone" style="display: block; margin-bottom: 5px;"><strong>Телефон:</strong></label>
                            <input type="tel" id="reserve_phone" name="phone" placeholder="+998 XX XXX XX XX" required style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <button type="submit" class="submit-reserve-button action-btn">Отправить бронь</button>
                        </form>
                    `;

                    reserveButton.addEventListener("click", () => {
                        reserveFormContainer.style.display = reserveFormContainer.style.display === "none" ? "block" : "none";
                    });

                    reserveFormContainer.addEventListener("submit", async (event) => {
    event.preventDefault();
    const name = reserveFormContainer.querySelector("#reserve_name").value;
    const phone = reserveFormContainer.querySelector("#reserve_phone").value;

    if (!name || !phone) {
        alert("Имя и телефон обязательны для бронирования!");
        return;
    }

    // --- Проверка выбора способа оплаты (без изменений) ---
    if (!userSelection.paymentChoice) {
        alert("Пожалуйста, выберите способ оплаты (100%, Рассрочка или Гибридная) перед бронированием.");
        return;
    }
    if (userSelection.paymentChoice !== 100 && userSelection.paymentChoice !== 'hybrid' && !resultContainer.innerHTML.includes(`Рассрочка (${userSelection.paymentChoice}%)`)) {
         alert("Пожалуйста, кликните на конкретный процент рассрочки (30%, 50%, 70%) перед бронированием.");
         return;
     }

    // --- Подготовка данных для LeadCreate (без изменений в этой части) ---
    let paymentTypeString = '';
    let monthlyPaymentValue = null;
    let installmentPeriodValue = null;

    if (userSelection.paymentChoice === 100) {
        paymentTypeString = 'Единовременно';
    } else if (typeof userSelection.paymentChoice === 'number') {
        paymentTypeString = `Рассрочка ${userSelection.paymentChoice}%`;
        installmentPeriodValue = months_left > 0 ? months_left : null;
        const remaining = userSelection.totalPrice - initialPayment;
        monthlyPaymentValue = installmentPeriodValue ? Math.round(remaining / installmentPeriodValue) : null;
    }

    const leadData = {
        full_name: name,
        phone: phone,
        region: "Ташкент", // Или другое значение по умолчанию
        contact_source: "Website Form",
        // === ИЗМЕНЕНО ===
        status: "COLD", // Соответствует LeadStatus Enum
        state: "NEW",   // Соответствует LeadState Enum
        // ================
        square_meters: Math.round(parseFloat(apartmentSize.replace(',', '.'))),
        rooms: parseInt(rooms, 10),
        floor: parseInt(floor, 10),
        total_price: userSelection.totalPrice,
        payment_type: paymentTypeString,
        monthly_payment: monthlyPaymentValue,
        installment_period: installmentPeriodValue,
        notes: `Бронь с сайта. ЖК: ${jkName}, Блок: ${blockName}, Этаж: ${floor}, №${apartmentNumber}, ${apartmentSize} м²`,
        currency: "UZS"
    };

    console.log("Отправка данных лида (без user_id):", leadData);

    // --- Отправка запроса на создание лида (без изменений в этой части) ---
    try {
        const response = await fetch("/api/leads/", { // Убедитесь, что путь /api/leads/ правильный
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(leadData)
        });

        if (response.ok) {
            alert("Бронь успешно зарегистрирована! Обновляем статус квартиры...");
            reserveFormContainer.style.display = "none";

            // Вызов эндпоинта для обновления Excel (без изменений)
            await updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, "Бронь");

            // Обновление UI (без изменений)
            if (card) {
                 const statusElement = card.querySelector('.apartment-status');
                 if (statusElement) {
                     statusElement.textContent = 'Бронь';
                     statusElement.className = 'apartment-status reserved';
                 }
                 card.classList.add('reserved');
            }
             const statusBadgeDetailed = infoCardDiv.querySelector('.status-badge');
             if(statusBadgeDetailed) {
                 statusBadgeDetailed.textContent = 'Бронь';
                 statusBadgeDetailed.className = 'status-badge status-reserved';
             }
             if (paymentActionsContainer) paymentActionsContainer.style.display = 'none';
             if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';

        } else {
            // Обработка ошибок от API создания лида (без изменений)
            let errorMsg = `Ошибка регистрации лида: ${response.statusText}`;
            try {
                const errorResult = await response.json();
                if (errorResult.detail) {
                     if (Array.isArray(errorResult.detail)) {
                         errorMsg += "\nДетали:\n";
                         errorResult.detail.forEach(err => {
                             errorMsg += `- Поле '${err.loc.join('.')}' : ${err.msg}\n`;
                         });
                     } else {
                         errorMsg = `Ошибка регистрации лида: ${errorResult.detail}`;
                     }
                }
            } catch (e) { /* Не удалось распарсить JSON ошибки */ }
            alert(errorMsg);
            console.error("Ошибка от /api/leads/:", errorMsg);
        }
    } catch (error) {
        console.error("Сетевая ошибка при бронировании:", error);
        alert("Произошла ошибка сети при бронировании. Пожалуйста, проверьте соединение и попробуйте еще раз.");
    }
});

async function updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, newStatus) {
    try {
        const response = await fetch("/api/excel/update-status", { // Новый эндпоинт
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                jkName: jkName,
                blockName: blockName,
                floor: parseInt(floor, 10),
                // apartmentNumber может быть строкой или числом, бэкенд должен это учесть
                apartmentNumber: isNaN(parseInt(apartmentNumber)) ? apartmentNumber : parseInt(apartmentNumber, 10),
                newStatus: newStatus
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log("Результат обновления Excel:", result.message);
            if (result.status === 'warning') {
                console.warn("Предупреждение при обновлении Excel:", result.message);
                // Можно показать некритичное уведомление админу/менеджеру
            }
        } else {
            console.error(`Ошибка при обновлении статуса в Excel (${response.status}): ${response.statusText}`);
            // Не блокируем пользователя, т.к. лид создан, но логируем ошибку
            // Можно отправить лог ошибки на бэкенд
        }
    } catch (error) {
        console.error("Сетевая ошибка при обновлении статуса в Excel:", error);
        // Логируем ошибку
    }
}

                     actionButtonsContainer.appendChild(reserveButton);
                     actionButtonsContainer.appendChild(reserveFormContainer); // Форма добавляется сразу после кнопки

                    // Кнопка "Оформить договор"
                    const contractButton = document.createElement("button");
                    contractButton.textContent = "Оформить договор";
                    contractButton.className = "contract-button action-btn"; // Общий класс
                    contractButton.addEventListener("click", async () => {
                         // Проверка, выбран ли способ оплаты
                         if (!userSelection.paymentChoice) {
                             alert("Пожалуйста, выберите способ оплаты (100%, Рассрочка или Гибридная).");
                             return;
                         }
                         if (userSelection.paymentChoice !== 100 && !resultContainer.innerHTML.includes('Стоимость квартиры')) {
                             alert("Пожалуйста, выберите конкретный процент рассрочки (30%, 50%, 70%) или Гибридную.");
                             return;
                         }

                        console.log("jkName before passing to modal:", jkName);
                        async function fetchLastContractNumber(jkName) {
                            // ... (Ваша функция fetchLastContractNumber без изменений)
                             try {
                                const response = await fetch(`/api/last-contract-number?jkName=${encodeURIComponent(jkName)}`);
                                if (!response.ok) {
                                    // Если номер не найден (404), вернуть null или пустую строку
                                    if (response.status === 404) return null;
                                    throw new Error(`Ошибка получения номера договора: ${response.statusText}`);
                                }
                                const data = await response.json();
                                return data.lastContractNumber;
                            } catch (error) {
                                console.error('Ошибка при получении номера договора:', error);
                                return null; // Возвращаем null при ошибке
                            }
                        }
                        const nextContractNumber = await fetchLastContractNumber(jkName) || ''; // Используем пустую строку, если null
                        openContractModal({
                            jkName: jkName,
                            block: blockName,
                            floor: floor,
                            apartmentNumber: apartmentNumber,
                            rooms: rooms,
                            size: parseFloat(apartmentSize.replace(',', '.')),
                            totalPrice: userSelection.totalPrice,
                            pricePerM2: userSelection.pricePerM2,
                            // Передаем выбранный процент или 'hybrid'
                            paymentChoice: userSelection.paymentChoice,
                            initialPayment: initialPayment, // Передаем актуальный первый взнос
                            contractNumber: nextContractNumber // Передаем полученный номер
                        });
                    });
                     actionButtonsContainer.appendChild(contractButton);
                     infoCardDiv.appendChild(actionButtonsContainer); // Добавляем контейнер с кнопками действий


                     // --- Функция открытия модального окна (без изменений) ---
                    function openContractModal(prefilledData) {
                        // Закрываем существующее модальное окно, если оно есть
                        const existingModal = document.querySelector(".custom-modal");
                        if (existingModal) existingModal.remove();

                        const modal = document.createElement("div");
                        modal.className = "custom-modal";
                        // Добавляем стили для модального окна (можно вынести в CSS)
                        modal.style.position = 'fixed';
                        modal.style.left = '0';
                        modal.style.top = '0';
                        modal.style.width = '100%';
                        modal.style.height = '100%';
                        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '1000';

                        const modalContent = document.createElement('div');
                        modalContent.className = 'custom-modal-content';
                        modalContent.style.backgroundColor = '#fff';
                        modalContent.style.padding = '20px';
                        modalContent.style.borderRadius = '8px';
                        modalContent.style.maxHeight = '90vh';
                        modalContent.style.overflowY = 'auto';
                        modalContent.style.width = '90%';
                        modalContent.style.maxWidth = '600px';

                         // Форматируем paymentChoice для отображения
                         let displayPaymentChoice = '';
                         if (typeof prefilledData.paymentChoice === 'number') {
                             displayPaymentChoice = `${prefilledData.paymentChoice}%`;
                         } else if (prefilledData.paymentChoice === 'hybrid') {
                             displayPaymentChoice = 'Гибридная';
                         }

                        modalContent.innerHTML = `
                            <h3 style="margin-top: 0;">Оформление договора</h3>
                            <form id="contract-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="hidden" name="jkName" value="${prefilledData.jkName}">

                                <div style="grid-column: 1 / -1;"><label>Номер договора:</label><input type="text" name="contractNumber" value="${prefilledData.contractNumber || ''}" required></div>
                                <div style="grid-column: 1 / -1;"><label>Дата договора:</label><input type="date" name="contractDate" value="${new Date().toISOString().slice(0,10)}" required></div>

                                <div><label>Блок:</label><input type="text" name="block" value="${prefilledData.block}" readonly></div>
                                <div><label>Этаж:</label><input type="number" name="floor" value="${prefilledData.floor}" readonly></div>
                                <div><label>№ квартиры:</label><input type="number" name="apartmentNumber" value="${prefilledData.apartmentNumber}" readonly></div>
                                <div><label>Комнат:</label><input type="number" name="rooms" value="${prefilledData.rooms}" readonly></div>
                                <div><label>Площадь (м²):</label><input type="number" name="size" value="${prefilledData.size}" readonly></div>
                                <div><label>Выбор оплаты:</label><input type="text" name="paymentChoice" value="${displayPaymentChoice}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Общая стоимость:</label><input type="text" name="totalPrice" value="${Number(prefilledData.totalPrice).toLocaleString('ru-RU')}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Стоимость 1 м²:</label><input type="text" name="pricePerM2" value="${Number(prefilledData.pricePerM2).toLocaleString('ru-RU')}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Сумма перв. взноса:</label><input type="text" name="initialPayment" id="initialPayment" value="${Number(prefilledData.initialPayment).toLocaleString('ru-RU')}" readonly></div>

                                <hr style="grid-column: 1 / -1; border: none; border-top: 1px solid #eee; margin: 10px 0;">

                                <div style="grid-column: 1 / -1;"><label>Ф.И.О.:</label><input type="text" name="fullName" required></div>
                                <div><label>Серия паспорта:</label><input type="text" name="passportSeries" required></div>
                                <div><label>ПИНФЛ:</label><input type="text" name="pinfl" required></div>
                                <div style="grid-column: 1 / -1;"><label>Кем выдан:</label><input type="text" name="issuedBy" required></div>
                                <div style="grid-column: 1 / -1;"><label>Адрес прописки:</label><input type="text" name="registrationAddress" required></div>
                                <div><label>Номер телефона:</label><input type="tel" name="phone" required></div>
                                <div><label>Отдел продаж:</label><input type="text" name="salesDepartment" required></div>

                                <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; margin-top: 15px;">
                                     <button type="submit" class="action-btn">Сохранить договор</button>
                                     <button type="button" class="close-modal action-btn secondary">Закрыть</button>
                                </div>
                            </form>

                        `;
                        // Добавляем стили для инпутов и лейблов формы
                        modalContent.querySelectorAll('label').forEach(label => {
                            label.style.display = 'block';
                            label.style.marginBottom = '3px';
                            label.style.fontSize = '0.9em';
                            label.style.color = '#555';
                        });
                        modalContent.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="tel"]').forEach(input => {
                            input.style.width = '100%';
                            input.style.padding = '8px';
                            input.style.border = '1px solid #ccc';
                            input.style.borderRadius = '4px';
                            input.style.boxSizing = 'border-box';
                            if(input.readOnly) {
                                input.style.backgroundColor = '#e9ecef'; // Серый фон для readonly
                                input.style.cursor = 'not-allowed';
                            }
                        });
                         modalContent.querySelectorAll('.action-btn').forEach(button => {
                             button.style.padding = '10px 15px';
                             button.style.border = 'none';
                             button.style.borderRadius = '5px';
                             button.style.cursor = 'pointer';
                             button.style.fontWeight = 'bold';
                         });
                         modalContent.querySelector('.action-btn[type="submit"]').style.backgroundColor = '#007bff'; // Синий
                         modalContent.querySelector('.action-btn[type="submit"]').style.color = '#fff';
                         modalContent.querySelector('.close-modal').style.backgroundColor = '#6c757d'; // Серый
                         modalContent.querySelector('.close-modal').style.color = '#fff';

                        modal.appendChild(modalContent);
                        document.body.appendChild(modal);

                        // Закрытие модального окна
                        modal.querySelector(".close-modal").addEventListener("click", () => {
                            modal.remove();
                        });
                         // Закрытие по клику вне окна
                         modal.addEventListener('click', (event) => {
                             if (event.target === modal) {
                                 modal.remove();
                             }
                         });


                        const form = modal.querySelector("#contract-form");
                        form.addEventListener("submit", async (event) => {
                            event.preventDefault();
                            const formData = new FormData(form);
                             // Преобразуем числовые строки обратно в числа перед отправкой
                             const data = Object.fromEntries(formData.entries());
                             data.totalPrice = parseFloat(data.totalPrice.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                             data.pricePerM2 = parseFloat(data.pricePerM2.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                             data.initialPayment = parseFloat(data.initialPayment.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                             // paymentChoice уже строка (%), оставляем как есть

                            console.log('Отправляемые данные договора:', data);
                            try {
                                const response = await fetch("/api/reestr/register_or_update", { // Убедитесь, что URL правильный
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(data)
                                });
                                const result = await response.json();
                                if (result.status === "success" || response.ok) { // Проверяем статус или OK
                                    alert(result.message || "Договор успешно сохранен!");
                                    modal.remove();
                                    // Опционально: обновить статус квартиры на "Продана"
                                } else {
                                    alert(`Ошибка сохранения договора: ${result.message || response.statusText}`);
                                }
                            } catch (error) {
                                console.error("Ошибка при обработке договора:", error);
                                alert("Произошла ошибка при сохранении договора. Попробуйте снова.");
                            }
                        });
                    } // --- Конец openContractModal ---

                } else {
                    // Если квартира не свободна (продана, бронь и т.д.)
                    const statusMessage = document.createElement('p');
                    statusMessage.style.marginTop = '1rem';
                    statusMessage.style.fontWeight = 'bold';
                    if (statusLower === 'продана') {
                         statusMessage.textContent = 'Квартира продана.';
                         statusMessage.style.color = 'red';
                    } else if (statusLower === 'бронь') {
                         statusMessage.textContent = 'Квартира забронирована.';
                         statusMessage.style.color = 'orange';
                    } else {
                        statusMessage.textContent = `Статус: ${status}`;
                    }
                    infoCardDiv.appendChild(statusMessage); // Добавляем сообщение о статусе
                }


                // --- ОБЩИЕ КНОПКИ НАЗАД И ПЕЧАТЬ ---
                // Добавляем кнопку "Назад" (поверх всего)
                // const backButton = document.createElement('button');
                // backButton.textContent = BACK_BUTTON_TEXT;
                // // Добавляем классы для позиционирования (адаптируйте CSS)
                // backButton.className = 'back-button top-left action-btn secondary';
                // backButton.style.position = 'absolute'; // Пример позиционирования
                // backButton.style.top = '10px';
                // backButton.style.left = '10px';
                // backButton.style.zIndex = '5'; // Чтобы была над контентом

                // backButton.addEventListener('click', () => {
                //     clearContainer('jk-details-container');
                //      // Вызываем функцию для отображения предыдущего вида (шахматки),
                //      // предполагая, что у вас есть такая функция и нужные данные
                //      if (typeof filterBlockData === 'function' && typeof globalShaxmatkaData !== 'undefined') {
                //          filterBlockData(globalShaxmatkaData, blockName, globalRenderImage, jkName);
                //      } else {
                //          console.warn("Функция filterBlockData или globalShaxmatkaData не найдены для возврата к шахматке.");
                //          // Можно просто скрыть контейнер, если нет логики возврата
                //          jkDetailsContainer.style.display = 'none';
                //      }
                //     // Скрываем кнопку печати, которая была связана с этим видом
                //     const printButton = document.querySelector(".print-button");
                //     if (printButton) {
                //         printButton.style.display = "none";
                //     }
                // });
                //  jkDetailsContainer.insertBefore(backButton, jkDetailsContainer.firstChild); // Вставляем в начало контейнера

                 // Добавляем кнопку "Печать" (также поверх)
                const printButton = document.createElement("button");
                printButton.textContent = PRINT_BUTTON_TEXT;
                printButton.className = "print-button top-right action-btn secondary"; // Классы для стилей и позиционирования
                 printButton.style.position = 'absolute';
                 printButton.style.top = '10px';
                 printButton.style.right = '10px';
                 printButton.style.zIndex = '5';

                printButton.addEventListener("click", () => {
                    // Скрываем кнопки управления перед печатью
                     backButton.style.display = 'none';
                     printButton.style.display = 'none';
                     window.print(); // Печатаем страницу
                     // Возвращаем кнопки после печати (может сработать не идеально во всех браузерах)
                     setTimeout(() => {
                         backButton.style.display = '';
                         printButton.style.display = '';
                     }, 500);
                });
                 jkDetailsContainer.insertBefore(printButton, jkDetailsContainer.firstChild); // Вставляем в начало

                // --- Отображение созданной структуры ---
                jkDetailsContainer.appendChild(apartmentPlanSection); // Добавляем левую колонку
                jkDetailsContainer.appendChild(infoCardDiv);          // Добавляем правую колонку
                jkDetailsContainer.style.display = 'flex'; // Используем flex для layout (или grid, если настроено в CSS)
                jkDetailsContainer.style.position = 'relative'; // Для позиционирования кнопок Назад/Печать

            } else {
                alert(apartmentInfo.message || "Ошибка при получении информации о квартире.");
            }
        } catch (error) {
            // Ошибки из fetchData уже обработаны, здесь ловим ошибки самой логики
            console.error("Критическая ошибка обработки клика по карточке:", error);
            alert("Не удалось загрузить или отобразить данные. Пожалуйста, попробуйте еще раз.");
        }
    } // конец if (card)
}); // конец addEventListe
</script>
</body>
</html>
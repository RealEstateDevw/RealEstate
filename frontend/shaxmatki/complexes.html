
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/complexes-style.css">
    <link rel="stylesheet" href="/static/landing/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Контейнер для рендера, чтобы внутри нього можно было позиционировать кнопки */
        .jk-image-wrapper {
            position: relative;
            display: inline-block;
            /* чтобы по размеру подстраивался под img */
        }

        /* Сам рендер */
        .jk-image-wrapper img {
            display: block;
            width: 100%;
            /* если нужно, чтобы изображение было адаптивным */
            height: auto;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .demo-title {
            font-size: 28px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 10px 0;
        }

        .demo-subtitle {
            font-size: 16px;
            color: #64748b;
            margin: 0;
        }

        /* Класс для кнопок-блоков, которые накладываем на изображение */
        .overlay-block-btn {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            color: #216BF4;
            border: 2px solid #216BF4;
            border-radius: 50%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.15),
                0 2px 4px rgba(33, 107, 244, 0.2);
            z-index: 10;
        }

        .overlay-block-btn:hover {
            background: #216BF4;
            color: white;
            transform: scale(1.15);
            box-shadow:
                0 6px 20px rgba(33, 107, 244, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .overlay-block-btn:active {
            transform: scale(1.05);
            transition: transform 0.1s ease;
        }

        /* Анимация появления кнопок */
        .overlay-block-btn {
            animation: blockButtonAppear 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) both;
        }

        .overlay-block-btn:nth-child(2) {
            animation-delay: 0.1s;
        }

        .overlay-block-btn:nth-child(3) {
            animation-delay: 0.2s;
        }

        .overlay-block-btn:nth-child(4) {
            animation-delay: 0.3s;
        }

        .overlay-block-btn:nth-child(5) {
            animation-delay: 0.4s;
        }

        .overlay-block-btn:nth-child(6) {
            animation-delay: 0.5s;
        }

        .overlay-block-btn:nth-child(7) {
            animation-delay: 0.6s;
        }

        @keyframes blockButtonAppear {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(10px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Пульсация для привлечения внимания */
        .overlay-block-btn::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            border: 2px solid #216BF4;
            opacity: 0;
            transform: scale(1);
        }

        .overlay-block-btn:hover::after,
        .overlay-block-btn:focus-visible::after {
            animation: buttonPulse 1.2s ease-out 1;
        }

        @keyframes buttonPulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }



        /* Подсказки для кнопок */
        .overlay-block-btn[data-tooltip] {
            position: relative;
        }

        .overlay-block-btn[data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            z-index: 1000;
            opacity: 1;
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }

            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Мобильная адаптивность */
        @media (max-width: 768px) {
            .overlay-block-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }

        /* Progressive enhancement: apply light blur only if supported */
        @supports ((backdrop-filter: blur(4px)) or (-webkit-backdrop-filter: blur(4px))) {
            .overlay-block-btn {
                backdrop-filter: blur(4px);
            }
            .complex-status-badge {
                backdrop-filter: blur(4px);
            }
        }

        body {
            background-color: #f8f9fa;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .back-button {
            font-size: 20px;
            color: #333;
            margin-right: 15px;
            cursor: pointer;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-button {
            display: flex;
            align-items: center;
            background-color: #f0f2f5;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-button.active {
            background-color: #e6f0ff;
            color: #0066ff;
        }

        .view-mode-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(248, 250, 252, 0.9);
            border-radius: 999px;
            padding: 6px 12px;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.7);
            margin-right: 20px;
        }

        .view-mode-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: #1f2937;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
        }

        .view-mode-btn .view-mode-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #216BF4;
        }

        .view-mode-btn .view-mode-icon svg {
            width: 24px;
            height: 24px;
            display: block;
        }

        .view-mode-btn .view-mode-icon svg path {
            fill: currentColor !important;
        }

        .view-mode-btn.active {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
        }

        .view-mode-btn.active .view-mode-icon {
            color: #fff;
        }

        .filter-icon {
            margin-right: 8px;
            color: #0066ff;
        }

        .dropdown-icon {
            margin-left: 5px;
        }

        #complexes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            padding: 40px 20px;
            background: transparent;
            max-width: 1200px;
            margin: 0 auto;
        }

        .complex-card {
            width: 350px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.10);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease, opacity 0.3s ease;
            position: relative;
            will-change: transform;
        }

        .complex-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(33, 107, 244, 0.05) 0%, 
                rgba(59, 130, 246, 0.02) 50%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 1;
        }

        .complex-card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 14px 24px rgba(0, 0, 0, 0.14);
        }

        .complex-card:hover::before {
            opacity: 1;
        }

        .complex-card:active {
            transform: translateY(-8px) scale(1.01);
            transition: transform 0.2s ease;
        }

        .complex-image-container {
            width: 100%;
            height: 240px;
            overflow: hidden;
            position: relative;
            border-radius: 20px 20px 0 0;
        }

        .complex-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* remove static filters to reduce paint cost */
            will-change: transform;
        }

        .complex-card:hover .complex-image {
            transform: scale(1.08);
        }

        /* Градиентный оверлей на изображение */
        .complex-image-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top,
                    rgba(0, 0, 0, 0.8) 0%,
                    rgba(0, 0, 0, 0.4) 50%,
                    transparent 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .complex-card:hover .complex-image-container::after {
            opacity: 1;
        }

        /* Современный статус бейдж */
        .complex-status-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
            /* optional blur applied via @supports */
            border: 1px solid rgba(255, 255, 255, 0.3);
        }



        .complex-content {
            padding: 24px;
            position: relative;
            z-index: 2;
            height: calc(100% - 240px);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 12px;
            box-sizing: border-box;
        }

        .complex-title {
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 12px 0;
            line-height: 1.3;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .complex-description {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .complex-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .complex-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            color: #0369a1;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(14, 165, 233, 0.2);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease, background 0.3s ease, color 0.3s ease;
            position: relative;
            overflow: hidden;
            will-change: transform;
        }

        .complex-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .complex-tag:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .complex-tag:hover::before {
            transform: translateX(100%);
        }

        .select-apartment-btn {
            --btn-h: 44px;
            --btn-bg: linear-gradient(135deg, #216BF4 0%, #1d4ed8 100%);
            --btn-shadow: 0 10px 20px rgba(33, 107, 244, 0.28), 0 2px 6px rgba(0,0,0,0.08);
            --btn-shadow-hover: 0 16px 28px rgba(33, 107, 244, 0.38), 0 4px 12px rgba(0,0,0,0.10);
            background: var(--btn-bg);
            color: #fff;
            border: none;
            min-height: var(--btn-h);
            line-height: 1;
            padding: 0 18px 0 14px;
            border-radius: 999px;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.2px;
            cursor: pointer;
            width: 100%;
            margin-top: auto;
            margin-bottom: 6px;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease, opacity 0.25s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--btn-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-shrink: 0;
            align-self: stretch;
            will-change: transform;
            -webkit-tap-highlight-color: transparent;
        }

        .select-apartment-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 60% at 0% 0%, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0) 60%),
                        linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.24) 50%, rgba(255,255,255,0.0) 100%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            pointer-events: none;
        }

        .select-apartment-btn::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.35);
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.6s ease, opacity 0.6s ease;
            pointer-events: none;
        }

        .select-apartment-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #2669ff 0%, #1e40af 100%);
            box-shadow: var(--btn-shadow-hover);
        }

        .select-apartment-btn:hover::before {
            transform: translateX(100%);
        }

        .select-apartment-btn:active {
            transform: translateY(0);
        }

        .select-apartment-btn:active::after {
            transform: translate(-50%, -50%) scale(18);
            opacity: 0;
        }

        .select-apartment-btn svg {
            width: 18px;
            height: 18px;
            padding: 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.18);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25);
        }

        .select-apartment-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 107, 244, 0.25), var(--btn-shadow-hover);
        }

        @media (max-width: 640px) {
            .select-apartment-btn {
                --btn-h: 52px;
                font-size: 16px;
                border-radius: 16px;
                gap: 12px;
                padding: 0 18px;
            }
            .select-apartment-btn svg {
                width: 20px;
                height: 20px;
                padding: 7px;
                border-radius: 12px;
            }
        }

        .complex-info-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
            /* heavy blur removed for performance */
            animation: slideInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .complex-info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #216BF4 0%, #3b82f6 50%, #60a5fa 100%);
        }

        .complex-info-header {
            padding: 30px 40px;
            background: linear-gradient(135deg, #216BF4 0%, #1d4ed8 100%);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .complex-info-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
        }

        .complex-info-header:hover::before {
            animation: shimmer 1.2s ease-out 1;
        }

        .complex-info-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .complex-info-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .complex-info-image {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.4s ease;
        }

        .complex-info-image:hover {
            transform: scale(1.02);
        }

        .complex-detail-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .complex-info-details {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .info-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 12px;
            border-left: 4px solid #216BF4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            will-change: transform;
        }

        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(33, 107, 244, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .info-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 20px rgba(33, 107, 244, 0.1);
        }

        .info-item:hover::before {
            transform: translateX(100%);
        }

        .info-label {
            font-weight: 700;
            color: #374151;
            min-width: 140px;
            margin-right: 20px;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
        }

        .map-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                0 5px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            /* heavy blur removed for performance */
            animation: slideInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) 0.2s both;
        }

        .map-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 20px 0;
            text-align: center;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .map-container {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.4s ease;
        }

        .map-container:hover {
            transform: scale(1.01);
        }

        .map-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .hide-info-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            will-change: transform;
        }

        .hide-info-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .hide-info-btn:hover {
            transform: translateY(-3px);
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .hide-info-btn:hover::before {
            transform: translateX(100%);
        }

        .hide-info-btn:active {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        /* Оптимизация производительности */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Отключаем только тяжелые эффекты при скролле */
        body.scrolling .complex-card:hover,
        body.scrolling .complex-tag:hover,
        body.scrolling .select-apartment-btn:hover,
        body.scrolling .hide-info-btn:hover {
            transform: none !important;
            transition: none !important;
        }

        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* Оптимизация для мобильных устройств */
        @media (max-width: 768px) {
            .complex-card:hover {
                transform: translateY(-6px) scale(1.01);
            }
            
            .complex-card:hover .complex-image {
                transform: scale(1.04);
            }
        }

        /* Современные анимации */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(60px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Анимация появления карточек */
        .complex-card {
            animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) both;
        }

        .complex-card:nth-child(1) { animation-delay: 0.1s; }
        .complex-card:nth-child(2) { animation-delay: 0.2s; }
        .complex-card:nth-child(3) { animation-delay: 0.3s; }
        .complex-card:nth-child(4) { animation-delay: 0.4s; }

        /* Адаптивность */
        @media (max-width: 768px) {
            .complex-info-content {
                grid-template-columns: 1fr;
                gap: 30px;
                padding: 30px 20px;
            }

            .complex-info-header {
                padding: 24px 20px;
            }

            .complex-info-title {
                font-size: 24px;
            }

            .complex-detail-image {
                height: 250px;
            }

            .info-item {
                padding: 16px 20px;
            }

            .info-label {
                min-width: 100px;
                font-size: 14px;
            }

            .map-section {
                padding: 30px 20px;
            }

            .map-title {
                font-size: 24px;
            }
        }

        .hide-info-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }

        .hide-info-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .hide-info-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Стили для интерфейса выбора блоков */
        .blocks-interface {
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .blocks-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .blocks-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .blocks-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin: 0;
        }

        .blocks-content {
            display: flex;
            gap: 0;
            min-height: calc(100vh - 80px);
            position: relative; /* позволяет накрывать панелью */
        }

        .blocks-content.panel-open {
            gap: 0;
        }

        /* Левая часть - рендер */
        .building-section {
            position: relative;
            width: 100%;
            flex: 0 0 auto;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-width: 0;
            transition: width 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .building-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            max-height: 100%;
        }

        .building-image {
            width: 100%;
            height: auto;
            display: block;
            max-height: calc(100vh - 120px);
            object-fit: contain;
        }

        .block-buttons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .block-btn {
            position: absolute;
            min-width: 60px;
            height: 60px;
            border-radius: 30px;
            background: #216BF4;
            color: white;
            border: 4px solid white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: all;
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 20px rgba(33, 107, 244, 0.4);
            z-index: 10;
            padding: 0 12px;
            white-space: nowrap;
            will-change: transform;
        }

        .block-btn:hover {
            background: #1d4ed8;
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(33, 107, 244, 0.6);
        }

        .block-btn:active {
            transform: scale(1.05);
        }

        /* Правая часть - панель квартир */
        .apartments-panel {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 16px 0 0 16px;
            box-shadow: -12px 0 40px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            width: 0;
            opacity: 0;
            transform: translateX(32px);
            transition: width 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.35s ease, opacity 0.3s ease;
            border-left: 1px solid #e5e7eb;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .blocks-content.panel-open.panel-mode-overlay .apartments-panel {
            width: 50%;
            max-width: 760px;
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .blocks-content.panel-open.panel-mode-split .apartments-panel {
            position: relative;
            width: 38%;
            max-width: none;
            opacity: 1;
            transform: none;
            pointer-events: auto;
            border-radius: 0;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.12);
        }

        .blocks-content.panel-open.panel-mode-overlay .building-section {
            width: 100%;
        }

        .blocks-content.panel-open.panel-mode-split .building-section {
            width: 62%;
        }

        .apartments-panel .apartments-header { flex-shrink: 0; position: sticky; top: 0; background: #fff; z-index: 2; }
        .apartments-panel .floor-plan-container { flex-shrink: 0; }
        .apartments-panel .apartments-list { flex: 1; overflow-y: auto; }

        .apartments-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-align: center;
            color: #64748b;
            padding: 32px 20px;
        }

        .apartments-empty h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .apartments-empty p {
            font-size: 14px;
            line-height: 1.5;
            max-width: 260px;
        }

        @media (max-width: 1400px) {
            .blocks-content.panel-open.panel-mode-overlay .apartments-panel { width: 48%; max-width: 700px; }
        }

        @media (max-width: 1200px) {
            .blocks-content.panel-open.panel-mode-overlay .apartments-panel { width: 46%; max-width: 640px; }
        }

        @media (max-width: 1024px) {
            .blocks-content.panel-open.panel-mode-overlay .apartments-panel { width: 50%; max-width: none; }
        }

        @media (max-width: 768px) {
            .blocks-content { flex-direction: column; }
            .blocks-content.panel-open .building-section { width: 100%; }
            .apartments-panel {
                position: relative;
                right: auto;
                top: auto;
                bottom: auto;
                transform: none;
                width: 100%;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.08);
            }
        }

        .apartments-header {
            background: white;
            padding: 24px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .apartment-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            flex: 1;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .apartment-filters h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            margin-right: 16px;
        }

        .filter-group h3 {
            margin-right: 0;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #216BF4;
            box-shadow: 0 0 0 3px rgba(33, 107, 244, 0.1);
        }

        .close-filters-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }

        .close-filters-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* План этажа */
        .floor-plan-container {
            padding: 20px;
            background: white;
        }

        .floor-plan {
            position: relative;
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            overflow: hidden;
        }

        .floor-plan-image-placeholder {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
        }

        .floor-plan-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .placeholder-text {
            text-align: center;
            color: #9ca3af;
        }

        .placeholder-text p {
            margin: 12px 0 4px 0;
            font-size: 16px;
            font-weight: 500;
        }

        .placeholder-text small {
            font-size: 12px;
            color: #6b7280;
        }

        .zoom-button {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-button:hover {
            background: #f8f9fa;
            border-color: #216BF4;
            transform: scale(1.05);
        }

        .zoom-button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: none;
            box-shadow: none;
        }

        .zoom-button:disabled:hover {
            background: #f3f4f6;
            transform: none;
        }

        /* Список квартир */
        .apartments-list {
            padding: 20px 18px 28px;
            max-height: calc(100vh - 480px);
            overflow-y: auto;
        }

        .apt-item {
            margin-bottom: 14px;
            cursor: pointer;
        }

        .apt-card {
            display: flex;
            gap: 18px;
            padding: 18px;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid rgba(203, 213, 225, 0.55);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .apt-item:hover .apt-card {
            transform: translateY(-3px);
            border-color: rgba(33, 107, 244, 0.45);
            box-shadow: 0 18px 44px rgba(15, 23, 42, 0.12);
        }

        .apt-thumb {
            width: 92px;
            height: 92px;
            border-radius: 14px;
            background: #f8fafc;
            border: 1px solid rgba(148, 163, 184, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .apt-thumb img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .apt-thumb .thumb-placeholder {
            width: 68px;
            height: 32px;
            border-radius: 10px;
            border: 2px dashed rgba(148, 163, 184, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .apt-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .apt-heading {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .apt-title-main {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .apt-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        .apt-status-pill {
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .apt-status-pill.available {
            background: rgba(34, 197, 94, 0.16);
            color: #047857;
        }

        .apt-status-pill.sold {
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
        }

        .apt-status-pill.booked {
            background: rgba(253, 186, 116, 0.2);
            color: #c2410c;
        }

        .apt-status-pill.unknown {
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
        }

        .apt-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .apt-price-main {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.015em;
            color: #111827;
        }

        .apt-price-main.muted {
            color: #9ca3af;
        }

        .apt-meta-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 14px;
            min-width: 72px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }

        .chess-wrapper {
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 100%;
        }

        .chess-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chess-title {
            font-size: 26px;
            font-weight: 700;
            color: #111827;
        }

        .chess-block-switcher {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chess-block-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            background-color: #f0f2f5;
            color: #1f2937;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .chess-block-btn.active {
            background-color: #e6f0ff;
            color: #0066ff;
        }

        .chess-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chess-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: nowrap;
        }

        .chess-floor-label {
            flex-shrink: 0;
            width: 50px;
            font-weight: bold;
            font-size: 1rem;
            color: #424242;
            text-align: center;
            background-color: #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem;
        }

        .chess-row-cards {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 6px;
            flex: 1;
        }

        .chess-row-cards::-webkit-scrollbar {
            height: 8px;
        }

        .chess-row-cards::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chess-row-cards::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .chess-card {
            flex: 0 0 calc(14.28% - 0.5rem);
            box-sizing: border-box;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 12px;
            min-height: 100px;
            min-width: 170px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chess-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chess-card .card-title {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 500;
            text-transform: none;
            opacity: 1;
            color: #1f2937;
        }

        .chess-card .card-status {
            font-size: 24px;
            line-height: 1.2;
            font-weight: 600;
            color: inherit;
        }

        .chess-card .card-price {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 0;
            color: inherit;
        }

        .chess-card .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 500;
            opacity: 1;
            color: inherit;
        }

        .chess-card.status-available {
            background: #04E762;
            border: 1px solid #04E762;
            color: #fff;
        }

        .chess-card.status-booked {
            background: #F5B700;
            border: 1px solid #F5B700;
            color: #fff;
        }

        .chess-card.status-sold {
            background: #ccd0d2;
            border: 1px solid #ccd0d2;
            color: #111827;
        }

        .chess-card.status-unknown {
            background: #eeeeee;
            border: 1px solid #bdbdbd;
            color: #0f172a;
        }

        .chess-plus-strip {
            display: flex;
            gap: 24px;
            padding: 10px 0 6px;
            overflow-x: auto;
        }

        .chess-plus-strip::-webkit-scrollbar {
            height: 8px;
        }

        .chess-plus-strip::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 999px;
        }

        .chess-plus-strip::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.8);
        }

        .chess-plus-section {
            flex: 0 0 360px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 26px;
            padding: 18px 20px;
            box-shadow: 0 18px 34px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(226, 232, 240, 0.7);
        }

        .chess-plus-grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 10px 0;
        }

        .chess-plus-header {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            background: #fff;
            border-radius: 999px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
            font-weight: 700;
            color: #111827;
            font-size: 16px;
        }

        .chess-plus-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chess-plus-floor {
            width: 56px;
            height: 44px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid rgba(203, 213, 225, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .chess-plus-cells {
            display: flex;
            gap: 10px;
            flex: 1;
            overflow-x: auto;
        }

        .chess-plus-cells::-webkit-scrollbar {
            height: 5px;
        }

        .chess-plus-cell {
            min-width: 60px;
            height: 48px;
            padding: 8px 12px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.01em;
            color: #0f172a;
            text-align: center;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45), 0 4px 12px rgba(15, 23, 42, 0.12);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .chess-plus-cell .chess-plus-cell-size {
            display: block;
            font-size: 16px;
            font-weight: 700;
            line-height: 1;
            color: inherit;
            white-space: nowrap;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.45);
        }

        .chess-plus-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.18);
        }

        .chess-plus-cell.status-available {
            background: #04E762;
            color: #0f172a;
        }

        .chess-plus-cell.status-booked {
            background: #F5B700;
        }

        .chess-plus-cell.status-sold {
            background: #CCD0D2;
        }

        .chess-plus-cell.status-unknown {
            background: #f8fafc;
            border: 1px solid rgba(203, 213, 225, 0.8);
            color: #475569;
        }

        .chess-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chess-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .chess-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .chess-block-switcher {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chess-block-btn {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chess-block-btn.active {
            background: #2563eb;
            color: #fff;
            border-color: transparent;
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
        }

        .chess-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chess-row {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .chess-floor-label {
            min-width: 64px;
            max-width: 64px;
            padding: 16px 0;
            border-radius: 12px;
            background: #f1f5f9;
            color: #475569;
            font-weight: 700;
            text-align: center;
        }

        .chess-row-cards {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: thin;
            padding-bottom: 4px;
            flex: 1;
        }

        .chess-row-cards::-webkit-scrollbar {
            height: 6px;
        }

        .chess-row-cards::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 999px;
        }

        .chess-card {
            min-width: 190px;
            border-radius: 18px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #0f172a;
            box-shadow: 0 8px 26px rgba(15, 23, 42, 0.12);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .chess-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
        }

        .chess-card .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.85;
        }

        .chess-card .card-status {
            font-size: 15px;
            font-weight: 700;
        }

        .chess-card .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
            opacity: 0.85;
        }

        .chess-card.status-available {
            background: linear-gradient(135deg, #34d399 0%, #22c55e 100%);
            color: #0f172a;
        }

        .chess-card.status-booked {
            background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
            color: #0f172a;
        }

        .chess-card.status-sold {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            color: #111827;
        }

        .chess-card.status-unknown {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5f5 100%);
            color: #0f172a;
        }

        .chess-card .card-price {
            font-size: 16px;
            font-weight: 700;
        }

        body.mode-chess-plus .chess-card {
            min-width: 220px;
        }

        .apt-status {
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px;
            min-width: 92px;
            text-align: center;
        }

        .apt-status.available { background: #dcfce7; color: #166534; }
        .apt-status.booked { background: #fef3c7; color: #92400e; }
        .apt-status.sold { background: #e5e7eb; color: #374151; }

        .apartments-count {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        

        .apartment-card:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #216BF4;
        }

        .apartment-plan-thumbnail {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .plan-miniature {
            width: 40px;
            height: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
        }

        .mini-room {
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .mini-room:nth-child(1) {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
        }

        .mini-room:nth-child(2) {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
        }

        .mini-room:nth-child(3) {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
        }

        .mini-room:nth-child(4) {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
        }

        .apartment-info {
            flex: 1;
        }

        .apartment-id {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }

        .apartment-price {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 4px;
        }

        .apartment-area {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .apartment-status {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            min-width: 80px;
            text-align: center;
        }

        .apartment-status.available {
            background: #dcfce7;
            color: #166534;
        }

        .apartment-status.available:hover {
            background: #bbf7d0;
            transform: scale(1.05);
        }

        /* Адаптивность */
        @media (max-width: 1024px) {
            .blocks-content {
                flex-direction: column;
            }
            
            .blocks-content.panel-open .building-section {
                flex: 0 0 50%;
            }
            
            .apartments-panel {
                flex: 0 0 auto;
                transform: translateY(100%);
            }
            
            .blocks-content.panel-open .apartments-panel {
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .blocks-interface {
                padding: 10px;
            }
            
            .blocks-title {
                font-size: 24px;
            }
            
            .blocks-subtitle {
                font-size: 16px;
            }
            
            .block-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .apartment-filters {
                flex-wrap: wrap;
            }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .complex-info-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .complex-info-image {
                max-width: 100%;
            }
            
            .complex-detail-image {
                height: 200px;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .info-label {
                min-width: auto;
                margin-right: 0;
            }
        }

        /* Убрали все анимации для лучшей производительности */

        /* Мобильная адаптивность */
        @media (max-width: 768px) {
            #complexes-container {
                padding: 20px 10px;
                gap: 20px;
            }

            .complex-card {
                width: 100%;
                max-width: 320px;
                height: 380px;
            }

            .complex-image-container {
                height: 220px;
            }

            .complex-content {
                padding: 20px;
            }

            .complex-title {
                font-size: 20px;
            }
        }

        /* Дополнительные эффекты для премиум вида */
        .complex-card::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: #216BF4;
            border-radius: 18px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .complex-card:hover::after {
            opacity: 0.15;
        }



        /* Заголовок страницы */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 42px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .page-subtitle {
            font-size: 18px;
            color: #64748b;
            margin: 10px 0 0 0;
            font-weight: 400;
        }

        .status-reserved {
            background-color: #F5B700;
            color: #ffffff;
        }

        .status-sold {
            color: #000;
            background-color: #CCD0D2;
        }


        .hover-area {
            position: absolute;
            /* Задайте координаты и размеры нужной области */
            /* Например, top, left, width, height задаются inline или через класс */
            background-color: rgba(255, 255, 255, 0);
            /* изначально прозрачный */
            transition: transform 0.3s, background-color 0.3s;
            cursor: pointer;
        }

        /* Эффект при наведении */
        .hover-area:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.2);
            /* легкий светлый оверлей */
        }

        #jk-details-container {
            display: flex;
            /* flex-direction: column;
    align-items: center; */
            gap: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
        }

        /* Стили для изображения */
        .jk-render-image {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Контейнер кнопок */
        .blocks-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 1rem;
        }

        /* Стили для кнопок */
        .block-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .block-button:hover {
            background-color: #0056b3;
        }

        .blocks-container {
            text-align: center;
            /* Center the buttons */
            padding-bottom: 10px;
            /* Add space below buttons */
        }

        .block-button {
            margin: 0 5px;
            /* Add space between buttons */
            padding: 5px 10px;
            cursor: pointer;
        }

        .jk-render-image {
            display: block;
            /* Make it take its own line */
            width: 100%;
            /* Make it fill container width */
            height: auto;
            /* Maintain aspect ratio */
            max-width: 100%;
            border-radius: 30px;
            border: 5px solid rgba(255, 255, 255, 0.60);
            /* Prevent overflow if container is smaller */
        }

        .back-button.top-left {
            /* Adjust as needed */
            z-index: 10;
            /* Ensure it's above other elements if necessary */
            padding: 5px 10px;
            cursor: pointer;
        }

        .header-left-group {
            display: flex;
            /* Arrange back button and phone link horizontally */
            align-items: center;
            /* Vertically align items in the group */
            gap: 15px;
            /* Space between back button and phone link */
            flex-shrink: 0;
            /* Prevent this group from shrinking too much */
        }

        /* NEW: Styles for the static Back to Home button */
        .header-back-home {
            display: inline-flex;
            /* Align icon nicely */
            align-items: center;
            justify-content: center;
            padding: 8px;
            /* Adjust padding for size */
            color: #216BF4;
            /* Match phone icon color */
            background-color: #f0f0f0;
            /* Light background to differentiate */
            border-radius: 50%;
            /* Make it a circle */
            text-decoration: none;
            transition: background-color 0.2s ease;
            line-height: 1;
            /* Prevent extra space */
        }

        /* Каждый этаж (floor-container) идёт отдельным блоком */
        .floor-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            background-color: #ffffff;
            padding: 0.5rem;
            border-radius: 4px;
        }

        /* Метка этажа (цифра) */
        .floor-label {
            flex-shrink: 0;
            width: 50px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #424242;
            text-align: center;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            border-radius: 4px;
        }

        /* Сетка квартир на этаже */
        .apartment-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
        }

        /* Общий стиль карточки квартиры */
        .apartment-card {
            flex: 0 0 calc(14.28% - 0.5rem);
            /* 7 карточек в ряд, при необходимости подберите другое значение */
            box-sizing: border-box;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 0.5rem;
            min-height: 100px;
            min-width: 170px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px;
            box-sizing: border-box;

            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            contain: content;
            will-change: transform;
        }

        /* При наведении делаем карточку чуть «выше» */
        .apartment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 500;
        }

        /* Центральный элемент — крупная цена */
        .card-price {
            font-size: 24px;
            margin: 4px 0;
            /* Небольшие отступы сверху и снизу */
            line-height: 1.2;
        }

        /* Нижняя строка: площадь и дополнительные метки */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
            gap: 0.75rem;
        }

        .card-area {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .card-contract {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            color: #1f2937;
        }

        .apartment-card.available {
            background: #04E762;
            /* светло-зелёный */
            border: 1px solid #04E762;
            color: #fff;
        }

        .apartment-card.sold {
            background: #CCD0D2;
            /* светло-серый */
            border: 1px solid #CCD0D2;
        }

        .apartment-card.booked {
            background: #F5B700;
            /* светло-серый */
            border: 1px solid #F5B700;
            color: #fff;
        }

        .apartment-card.unavailable {
            background-color: #eeeeee;
            border: 1px solid #bdbdbd;
        }

        /* Unified floors layout */
        .floors-scroll-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 1rem;
            /* space for scrollbar */
        }

        .floors-scroll-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .floors-scroll-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .floors-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .floors-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .floor-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: nowrap;
        }

        .floor-label {
            flex-shrink: 0;
            width: 50px;
            font-weight: bold;
            font-size: 1rem;
            color: #424242;
            text-align: center;
            background-color: #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem;
        }

        /* Кнопка «Назад к выбору блоков» */
        .back-button {
            padding: 0.5rem 1rem;
            background-color: #2196f3;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 999;
            /* Чтобы кнопка была поверх остальных элементов */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .back-button:hover {
            background-color: #1976d2;
        }

        /* --- Apartment Detail Layout (Plan + Card) --- */
        .apartment-details-container {
            display: flex;
            gap: 32px;
            align-items: flex-start;
            background: #ffffff;
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 24px 80px rgba(15, 23, 42, 0.08);
            width: 100%;
        }

        .apartment-plan-section,
        .info-card {
            background: #ffffff;
            border-radius: 28px;
            padding: 28px;
            box-shadow: 0 18px 50px rgba(15, 23, 42, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .apartment-plan-section {
            flex: 1 1 55%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .plan-section-title {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .plan-title-main {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .plan-area-value {
            font-size: 48px;
            font-weight: 700;
            color: #1d4ed8;
            line-height: 1;
        }

        .plan-area-unit {
            font-size: 26px;
            font-weight: 600;
            color: #1d4ed8;
            margin-bottom: 4px;
        }

        .plan-room-label {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .plan-title-meta {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .plan-image-wrapper {
            background: #f8fafc;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            padding: 24px;
        }

        .plan-controls {
            margin-top: auto;
            padding-top: 12px;
        }

        .plan-nav-btn,
        .plan-action-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: #eff3fb;
            color: #1d4ed8;
            box-shadow: 0 12px 24px rgba(29, 78, 216, 0.18);
            border: none;
        }

        .plan-nav-btn:hover,
        .plan-action-btn:hover {
            background: #1d4ed8;
            color: #ffffff;
        }

        .info-card {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .info-card-header {
            align-items: flex-start;
        }

        .info-card-title {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .status-badge.status-available {
            background: #dcfce7;
            color: #047857;
        }

        .status-badge.status-reserved {
            background: #fef3c7;
            color: #b45309;
        }

        .status-badge.status-sold {
            background: #e2e8f0;
            color: #1f2937;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .info-block {
            background: #f8fafc;
            border-radius: 18px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 14px 16px;
        }

        .info-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .info-value {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .discount-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .discount-badge {
            border-radius: 14px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .discount-badge strong {
            font-weight: 700;
        }

        .discount-blue {
            background: rgba(33, 107, 244, 0.12);
            color: #1d4ed8;
            border: 1px solid rgba(33, 107, 244, 0.28);
        }

        .discount-green {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .discount-sand {
            background: rgba(217, 119, 6, 0.12);
            color: #92400e;
            border: 1px solid rgba(217, 119, 6, 0.25);
        }

        .price-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .total-price {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
        }

        .price-per-meter {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #eff1f5;
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        .payment-actions-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .payment-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .payment-option-btn {
            padding: 10px 18px;
            border-radius: 999px;
            border: 2px solid transparent;
            font-weight: 600;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .payment-option-btn:nth-child(1) {
            border-color: #1d4ed8;
            color: #1d4ed8;
        }

        .payment-option-btn:nth-child(1).active {
            background: #1d4ed8;
            color: #ffffff;
            box-shadow: 0 12px 28px rgba(29, 78, 216, 0.28);
        }

        .payment-option-btn:nth-child(2) {
            border-color: #16a34a;
            color: #047857;
        }

        .payment-option-btn:nth-child(2).active {
            background: #16a34a;
            color: #ffffff;
            box-shadow: 0 12px 28px rgba(22, 163, 74, 0.25);
        }

        .payment-option-btn:nth-child(3) {
            border-color: #b45309;
            color: #b45309;
        }

        .payment-option-btn:nth-child(3).active {
            background: #b45309;
            color: #ffffff;
            box-shadow: 0 12px 28px rgba(180, 83, 9, 0.25);
        }

        .installment-options,
        .hybrid-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .installment-percent-btn,
        .hybrid-percent-btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.15);
            background: #fff;
            font-weight: 600;
            font-size: 13px;
            color: #0f172a;
            transition: all 0.2s ease;
        }

        .installment-percent-btn.active,
        .hybrid-percent-btn.active {
            background: #1d4ed8;
            color: #fff;
            border-color: #1d4ed8;
        }

        .payment-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 18px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .summary-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .summary-title {
            font-size: 15px;
            font-weight: 700;
            color: #1d4ed8;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #0f172a;
        }

        .summary-row.muted {
            color: #64748b;
        }

        .summary-label {
            font-weight: 500;
        }

        .summary-value {
            font-weight: 700;
        }

        .action-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border-radius: 999px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
            color: #ffffff;
            box-shadow: 0 18px 35px rgba(37, 99, 235, 0.30);
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 22px 40px rgba(37, 99, 235, 0.35);
        }

        .action-btn.secondary {
            background: #ffffff;
            color: #1d4ed8;
            border: 1px solid rgba(29, 78, 216, 0.3);
        }

        .action-btn.secondary:hover {
            background: #f8fafc;
            border-color: #1d4ed8;
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .form-buttons .action-btn {
            flex: 1;
            padding: 12px 20px;
        }

        .reserve-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .reserve-form-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 16px;
        }

        .reserve-form input {
            border: 1px solid rgba(203, 213, 225, 0.9);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
        }

        .reserve-form label {
            font-size: 13px;
            color: #475569;
        }

        .status-message {
            margin-top: 16px;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: #f8fafc;
        }

        .status-message.is-sold {
            color: #b91c1c;
            background: #fee2e2;
            border-color: rgba(239, 68, 68, 0.35);
        }

        .status-message.is-booked {
            color: #b45309;
            background: #fef3c7;
            border-color: rgba(217, 119, 6, 0.35);
        }

        @media (max-width: 1200px) {
            .apartment-details-container {
                flex-direction: column;
                padding: 24px;
            }

            .apartment-plan-section,
            .info-card {
                width: 100%;
            }

            .plan-title-main {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .apartment-details-container {
                padding: 18px;
                gap: 20px;
            }

            .apartment-plan-section,
            .info-card {
                padding: 20px;
            }

            .plan-area-value {
                font-size: 36px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .payment-tabs {
                gap: 6px;
            }
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container header-container" id="headerContainer">

            <!-- Placeholder: Your DYNAMIC back button ('dynamic-back-button') will be added here by JavaScript -->

            <!-- Group for Static Back Home Button and Phone -->
            <div class="header-left-group">

                <!-- Static Back to Home Button -->
                <a href="/" class="header-back-home" id="controlled-back-button" aria-label="Вернуться на главную">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline> <!-- Simple Back Arrow -->
                    </svg>
                    <span class="back-button-text"></span> <!-- ADDED: Span for dynamic text -->
                </a>
                <!-- Existing Phone Link -->
                <a href="tel:+998971234567" class="header-phone">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <!-- Phone SVG paths -->
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M10.6866 6.4791L10.0376 5.31617C9.15317 3.73144 6.93076 3.54428 5.53781 4.93723C4.7008 5.77423 4.04952 6.7996 4.00655 7.93309C3.95086 9.40215 4.22428 11.6609 5.83644 14.1061L10.1147 9.8278C11.0372 8.90533 11.2723 7.52858 10.6866 6.4791ZM14.1722 13.8853L9.89393 18.1636C12.3391 19.7757 14.5979 20.0491 16.0669 19.9934C17.2004 19.9505 18.2258 19.2992 19.0628 18.4622C20.4557 17.0692 20.2686 14.8468 18.6838 13.9624L17.5209 13.3134C16.4714 12.7277 15.0947 12.9628 14.1722 13.8853Z"
                            fill="#216BF4" />
                        <path opacity="0.5"
                            d="M11.025 12.9758C8.99624 10.9471 10.1152 9.82812 10.1152 9.82812L5.83691 14.1064C6.31875 14.8372 6.92019 15.5846 7.66817 16.3326C8.41615 17.0806 9.16359 17.682 9.8944 18.1639L14.1727 13.8856C14.1727 13.8856 13.0537 15.0045 11.025 12.9758Z"
                            fill="#216BF4" />
                    </svg>
                    <span>+998 97 123 45 67</span> <!-- Замените на ваш номер -->
                </a>
            </div> <!-- End of header-left-group -->

            <div class="view-mode-switch" role="group" aria-label="Выбор режима отображения">
                <button type="button" class="view-mode-btn" data-view-mode="chess">
                    <span class="view-mode-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path opacity="0.5" d="M2 6.5C2 4.37868 2 3.31802 2.65901 2.65901C3.31802 2 4.37868 2 6.5 2C8.62132 2 9.68198 2 10.341 2.65901C11 3.31802 11 4.37868 11 6.5C11 8.62132 11 9.68198 10.341 10.341C9.68198 11 8.62132 11 6.5 11C4.37868 11 3.31802 11 2.65901 10.341C2 9.68198 2 8.62132 2 6.5Z" fill="currentColor"/>
                            <path opacity="0.5" d="M13 17.5C13 15.3787 13 14.318 13.659 13.659C14.318 13 15.3787 13 17.5 13C19.6213 13 20.682 13 21.341 13.659C22 14.318 22 15.3787 22 17.5C22 19.6213 22 20.682 21.341 21.341C20.682 22 19.6213 22 17.5 22C15.3787 22 14.318 22 13.659 21.341C13 20.682 13 19.6213 13 17.5Z" fill="currentColor"/>
                            <path d="M2 17.5C2 15.3787 2 14.318 2.65901 13.659C3.31802 13 4.37868 13 6.5 13C8.62132 13 9.68198 13 10.341 13.659C11 14.318 11 15.3787 11 17.5C11 19.6213 11 20.682 10.341 21.341C9.68198 22 8.62132 22 6.5 22C4.37868 22 3.31802 22 2.65901 21.341C2 20.682 2 19.6213 2 17.5Z" fill="currentColor"/>
                            <path d="M13 6.5C13 4.37868 13 3.31802 13.659 2.65901C14.318 2 15.3787 2 17.5 2C19.6213 2 20.682 2 21.341 2.65901C22 3.31802 22 4.37868 22 6.5C22 8.62132 22 9.68198 21.341 10.341C20.682 11 19.6213 11 17.5 11C15.3787 11 14.318 11 13.659 10.341C13 9.68198 13 8.62132 13 6.5Z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span>Шахматка</span>
                </button>
                <button type="button" class="view-mode-btn" data-view-mode="chessPlus">
                    <span class="view-mode-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path opacity="0.5" d="M13 15.4C13 13.3258 13 12.2887 13.659 11.6444C14.318 11 15.3787 11 17.5 11C19.6213 11 20.682 11 21.341 11.6444C22 12.2887 22 13.3258 22 15.4V17.6C22 19.6742 22 20.7113 21.341 21.3556C20.682 22 19.6213 22 17.5 22C15.3787 22 14.318 22 13.659 21.3556C13 20.7113 13 19.6742 13 17.6V15.4Z" fill="currentColor"/>
                            <path d="M2 8.6C2 10.6742 2 11.7113 2.65901 12.3556C3.31802 13 4.37868 13 6.5 13C8.62132 13 9.68198 13 10.341 12.3556C11 11.7113 11 10.6742 11 8.6V6.4C11 4.32582 11 3.28873 10.341 2.64437C9.68198 2 8.62132 2 6.5 2C4.37868 2 3.31802 2 2.65901 2.64437C2 3.28873 2 4.32582 2 6.4V8.6Z" fill="currentColor"/>
                            <path d="M13 5.5C13 4.4128 13 3.8692 13.1713 3.44041C13.3996 2.86867 13.8376 2.41443 14.389 2.17761C14.8024 2 15.3266 2 16.375 2H18.625C19.6734 2 20.1976 2 20.611 2.17761C21.1624 2.41443 21.6004 2.86867 21.8287 3.44041C22 3.8692 22 4.4128 22 5.5C22 6.5872 22 7.1308 21.8287 7.55959C21.6004 8.13133 21.1624 8.58557 20.611 8.82239C20.1976 9 19.6734 9 18.625 9H16.375C15.3266 9 14.8024 9 14.389 8.82239C13.8376 8.58557 13.3996 8.13133 13.1713 7.55959C13 7.1308 13 6.5872 13 5.5Z" fill="currentColor"/>
                            <path opacity="0.5" d="M2 18.5C2 19.5872 2 20.1308 2.17127 20.5596C2.39963 21.1313 2.83765 21.5856 3.38896 21.8224C3.80245 22 4.32663 22 5.375 22H7.625C8.67337 22 9.19755 22 9.61104 21.8224C10.1624 21.5856 10.6004 21.1313 10.8287 20.5596C11 20.1308 11 19.5872 11 18.5C11 17.4128 11 16.8692 10.8287 16.4404C10.6004 15.8687 10.1624 15.4144 9.61104 15.1776C9.19755 15 8.67337 15 7.625 15H5.375C4.32663 15 3.80245 15 3.38896 15.1776C2.83765 15.4144 2.39963 15.8687 2.17127 16.4404C2 16.8692 2 17.4128 2 18.5Z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span>Шахматка +</span>
                </button>
                <button type="button" class="view-mode-btn" data-view-mode="facades">
                    <span class="view-mode-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5H11C12.8856 5 13.8284 5 14.4142 5.58579C15 6.17157 15 7.11438 15 9V21.25H16.5H21H22C22.4142 21.25 22.75 21.5858 22.75 22C22.75 22.4142 22.4142 22.75 22 22.75H2C1.58579 22.75 1.25 22.4142 1.25 22C1.25 21.5858 1.58579 21.25 2 21.25H3V9C3 7.11438 3 6.17157 3.58579 5.58579C4.17157 5 5.11438 5 7 5ZM5.25 8C5.25 7.58579 5.58579 7.25 6 7.25H12C12.4142 7.25 12.75 7.58579 12.75 8C12.75 8.41421 12.4142 8.75 12 8.75H6C5.58579 8.75 5.25 8.41421 5.25 8ZM5.25 11C5.25 10.5858 5.58579 10.25 6 10.25H12C12.4142 10.25 12.75 10.5858 12.75 11C12.75 11.4142 12.4142 11.75 12 11.75H6C5.58579 11.75 5.25 11.4142 5.25 11ZM5.25 14C5.25 13.5858 5.58579 13.25 6 13.25H12C12.4142 13.25 12.75 13.5858 12.75 14C12.75 14.4142 12.4142 14.75 12 14.75H6C5.58579 14.75 5.25 14.4142 5.25 14ZM9 18.25C9.41421 18.25 9.75 18.5858 9.75 19V21.25H8.25V19C8.25 18.5858 8.58579 18.25 9 18.25Z" fill="currentColor"/>
                            <path opacity="0.5" d="M15.001 2H17.001C18.8866 2 19.8294 2 20.4152 2.58579C21.001 3.17157 21.001 4.11438 21.001 6V21.25H15.001V9C15.001 7.11438 15.001 6.17157 14.4152 5.58579C13.8426 5.01319 12.9289 5.0003 11.127 5.00001V3.49999C11.2113 3.11275 11.352 2.82059 11.5868 2.58579C12.1725 2 13.1154 2 15.001 2Z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span>Фасады</span>
                </button>
            </div>

            <!-- Existing "Выбрать ЖК" Button -->
            <button class="btn btn--primary header-button" onclick="showComplexes()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <!-- Building SVG paths -->
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M7 5H11C12.8856 5 13.8284 5 14.4142 5.58579C15 6.17157 15 7.11438 15 9V21.25H16.5H21H22C22.4142 21.25 22.75 21.5858 22.75 22C22.75 22.4142 22.4142 22.75 22 22.75H2C1.58579 22.75 1.25 22.4142 1.25 22C1.25 21.5858 1.58579 21.25 2 21.25H3V9C3 7.11438 3 6.17157 3.58579 5.58579C4.17157 5 5.11438 5 7 5ZM5.25 8C5.25 7.58579 5.58579 7.25 6 7.25H12C12.4142 7.25 12.75 7.58579 12.75 8C12.75 8.41421 12.4142 8.75 12 8.75H6C5.58579 8.75 5.25 8.41421 5.25 8ZM5.25 11C5.25 10.5858 5.58579 10.25 6 10.25H12C12.4142 10.25 12.75 10.5858 12.75 11C12.75 11.4142 12.4142 11.75 12 11.75H6C5.58579 11.75 5.25 11.4142 5.25 11ZM5.25 14C5.25 13.5858 5.58579 13.25 6 13.25H12C12.4142 13.25 12.75 13.5858 12.75 14C12.75 14.4142 12.4142 14.75 12 14.75H6C5.58579 14.75 5.25 14.4142 5.25 14ZM9 18.25C9.41421 18.25 9.75 18.5858 9.75 19V21.25H8.25V19C8.25 18.5858 8.58579 18.25 9 18.25Z"
                        fill="white" />
                    <path opacity="0.5"
                        d="M15 2H17C18.8856 2 19.8284 2 20.4142 2.58579C21 3.17157 21 4.11438 21 6V21.25H15V9C15 7.11438 15 6.17157 14.4142 5.58579C13.8416 5.01319 12.9279 5.0003 11.126 5.00001V3.49999C11.2103 3.11275 11.351 2.82059 11.5858 2.58579C12.1715 2 13.1144 2 15 2Z"
                        fill="white" />
                </svg>
                <span>Выбрать ЖК</span>
            </button>

        </div>
    </header>
    <div id="complexes-container" style="display: none;"></div>
    <div id="jk-details-container" style="display: none;">

    </div>

    <script>
        async function fetchData(url, errorMessage) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`${errorMessage}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`${errorMessage}:`, error);
                throw error;
            }
        }
        async function showComplexes() {
            try {
                currentBlockName = null;
                currentJKName = null;
                currentFloorFilter = null;
                chessViewContainer = null;
                chessBlockButtonsWrap = null;

                // Делаем запрос к серверу
                const response = await fetch('/api/complexes');
                const result = await response.json();
                console.log(result)

                if (result.status === "success") {
                    complexesContainer = document.getElementById("complexes-container")
                    // Очищаем контейнер ЖК и делаем его видимым
                    complexesContainer.innerHTML = "";
                    complexesContainer.style.display = "flex";

                    // Создаем карточки ЖК
                    result.complexes.forEach(complex => {
                        const card = document.createElement("div");
                        card.className = "complex-card";
                        card.setAttribute("data-jk-name", complex.name); // Указываем имя ЖК

                        card.innerHTML = `
                <div class="complex-image-container">
                    <img src="${complex.render}" alt="Рендер ${complex.name}" class="complex-image">
                       </div>
                        <div class="complex-content">
                <h3 class="complex-title">${complex.name}</h3>
                <p class="complex-description">Элегантный жилой комплекс в престижном районе с панорамными видами</p>
                <div class="complex-tags">
                    <span class="complex-tag">Консьерж</span>
                    <span class="complex-tag">Фитнес-зал</span>
                    <span class="complex-tag">Терраса</span>
                </div>
                <button class="select-apartment-btn" onclick="event.stopPropagation(); selectComplex('${complex.name}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Выбрать квартиру
                </button>
            </div>

                     
                `;

                        complexesContainer.appendChild(card);
                    });
                    const jkDetailsContainer = document.getElementById("jk-details-container");
                    if (jkDetailsContainer) jkDetailsContainer.style.display = "none";
                    // Or original display
                    resetBackButtonToDefault();
                } else {
                    console.error('Ошибка загрузки ЖК: ', result.message);
                    alert('Ошибка загрузки ЖК: ' + result.message);
                }
            } catch (error) {
                console.error("Ошибка загрузки ЖК:", error);
                alert('Ошибка загрузки ЖК: ' + error.message);
            }
        }

        const ViewModes = {
            CHESS: 'chess',
            CHESS_PLUS: 'chessPlus',
            FACADES: 'facades'
        };

        let currentViewMode = ViewModes.FACADES;
        let globalShaxmatkaData = null;
        let globalRenderImage = null;
        let currentBlockName = null;
        let currentJKName = null;
        let currentFloorFilter = null;
        let currentFloorPlanUrl = null;
        let lastFloorPlanObjectUrl = null;
        const apartmentPlanThumbnailCache = new Map();
        let chessViewContainer = null;
        let chessBlockButtonsWrap = null;
        const ALL_FLOORS_OPTION_VALUE = '__all';
        // Глобальная переменная для хранения выбора пользователя
        let userSelection = {
            totalPrice: null,
            pricePerM2: null
        };
        // Глобальная переменная для хранения выбора тип оплаты 30,50,70 или 100%
        let selectedPaymentOption = ''; // Явно задайте начальное значение
        // Глобальная переменная для хранения первоначального взноса
        let initialPayment = null;
        console.log('Initial Payment:', initialPayment); // Отладка
        let controlledBackButton = null;
        let originalBackButtonHref = '/';
        let currentBackListener = null;
        let globalRegistryContractsMap = {};

        const CONTRACT_CYR_TO_LAT = {
            "А": "A", "а": "a",
            "В": "V", "в": "v",
            "С": "S", "с": "s",
            "Е": "E", "е": "e",
            "К": "K", "к": "k",
            "М": "M", "м": "m",
            "Н": "N", "н": "n",
            "О": "O", "о": "o",
            "Р": "R", "р": "r",
            "Т": "T", "т": "t",
            "Х": "H", "х": "h",
            "У": "U", "у": "u"
        };

        function normalizeBlockNameForContracts(value) {
            if (value === undefined || value === null) return "";
            return value
                .toString()
                .trim()
                .split("")
                .map(char => CONTRACT_CYR_TO_LAT[char] || char)
                .join("")
                .toLowerCase()
                .replace(/[\s_–—-]+/g, "-");
        }

        function normalizeFloorValueForContracts(value) {
            if (value === undefined || value === null || value === "") return "";
            const numeric = Number(String(value).replace(",", "."));
            if (!Number.isNaN(numeric)) {
                return String(numeric);
            }
            return value.toString().trim();
        }

        function normalizeApartmentNumberForContracts(value) {
            if (value === undefined || value === null) return "";
            return value.toString().trim();
        }

        function buildContractLookupKey(block, floor, number) {
            const normalizedBlock = normalizeBlockNameForContracts(block);
            const normalizedFloor = normalizeFloorValueForContracts(floor);
            const normalizedNumber = normalizeApartmentNumberForContracts(number);
            if (!normalizedBlock || !normalizedFloor || !normalizedNumber) {
                return "";
            }
            return `${normalizedBlock}|${normalizedFloor}|${normalizedNumber}`;
        }

        function buildRegistryContractsMap(entries = []) {
            if (!Array.isArray(entries)) return {};
            return entries.reduce((acc, entry) => {
                const key = buildContractLookupKey(
                    entry.blockNormalized ?? entry.block,
                    entry.floor,
                    entry.apartmentNumber
                );
                if (!key || !entry.contractNumber) {
                    return acc;
                }
                acc[key] = entry.contractNumber;
                return acc;
            }, {});
        }

        function updateRegistryContracts(entries) {
            globalRegistryContractsMap = buildRegistryContractsMap(entries);
        }

        function getContractNumberForRow(row) {
            if (!globalRegistryContractsMap || !row) return null;
            const key = buildContractLookupKey(row[0], row[6], row[4]);
            if (!key) return null;
            return globalRegistryContractsMap[key] || null;
        }

        function extractApartmentOrder(value) {
            if (value === undefined || value === null || value === "") {
                return Number.POSITIVE_INFINITY;
            }
            const match = value.toString().match(/\d+/);
            if (!match) {
                return Number.POSITIVE_INFINITY;
            }
            const parsed = Number.parseInt(match[0], 10);
            return Number.isNaN(parsed) ? Number.POSITIVE_INFINITY : parsed;
        }

        function sortApartmentRows(rows) {
            if (!Array.isArray(rows)) return [];
            return [...rows].sort((a, b) => {
                const aOrder = extractApartmentOrder(a?.[4]);
                const bOrder = extractApartmentOrder(b?.[4]);
                if (aOrder !== bOrder) {
                    return aOrder - bOrder;
                }
                const aLabel = (a?.[4] ?? '').toString();
                const bLabel = (b?.[4] ?? '').toString();
                return aLabel.localeCompare(bLabel, 'ru');
            });
        }

        function setViewMode(mode) {
            if (!mode || !Object.values(ViewModes).includes(mode)) {
                mode = ViewModes.FACADES;
            }
            if (currentViewMode === mode) return;
            currentViewMode = mode;
            updateViewModeButtons();
            applyViewModeClasses();

            const savedBlock = currentBlockName;
            const savedJK = currentJKName;

            // if (mode === ViewModes.FACADES) {
            //     showComplexes();
            //     return;
            // }

            if (globalShaxmatkaData && savedJK) {
                const options = {};
                if (mode === ViewModes.CHESS && savedBlock) {
                    options.preserveBlock = savedBlock;
                }
                showJKDetails(globalShaxmatkaData, globalRenderImage, savedJK, options);
            } else {
                showComplexes();
            }
        }

        function updateViewModeButtons() {
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                const mode = btn.getAttribute('data-view-mode');
                const isActive = mode === currentViewMode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
        }

        function applyViewModeClasses() {
            document.body.classList.remove('mode-facades', 'mode-chess', 'mode-chess-plus');
            switch (currentViewMode) {
                case ViewModes.CHESS:
                    document.body.classList.add('mode-chess');
                    break;
                case ViewModes.CHESS_PLUS:
                    document.body.classList.add('mode-chess-plus');
                    break;
                default:
                    document.body.classList.add('mode-facades');
            }
        }

        // --- Initialization (keep as before) ---
        document.addEventListener('DOMContentLoaded', () => {
            controlledBackButton = document.getElementById('controlled-back-button');
            if (controlledBackButton) {
                originalBackButtonHref = controlledBackButton.href;
                console.log("Back button control initialized. Original href:", originalBackButtonHref);
            } else {
                console.error("Could not find element with id 'controlled-back-button' to control.");
            }

            const viewModeButtons = document.querySelectorAll('.view-mode-btn');
            viewModeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.getAttribute('data-view-mode');
                    if (mode) {
                        setViewMode(mode);
                    }
                });
            });

            updateViewModeButtons();
            applyViewModeClasses();
        });

        // --- REVISED: updateBackButton ---
        function updateBackButton(text, onClickHandler) {
            if (!controlledBackButton) {
                console.error("Cannot update back button: element not found.");
                return;
            }
            console.log(`Updating back button: Text='${text}'`);

            // 1. Update Text
            const textSpan = controlledBackButton.querySelector('.back-button-text');
            if (textSpan) {
                textSpan.textContent = text;
                textSpan.style.display = 'inline'; // Make text visible
            } else {
                console.warn("'.back-button-text' span not found inside the back button.");
            }

            // 2. Remove previous listener
            if (currentBackListener) {
                controlledBackButton.removeEventListener('click', currentBackListener);
            }

            // 3. Create and add the new listener
            currentBackListener = (event) => {
                event.preventDefault();
                console.log("Back button clicked (custom action)");
                onClickHandler();
            };
            controlledBackButton.addEventListener('click', currentBackListener);

            // 4. Change href
            controlledBackButton.href = 'javascript:void(0);';
            controlledBackButton.setAttribute('aria-label', text);

            // 5. ADD Styling Classes for Dynamic State
            controlledBackButton.classList.add('btn', 'btn--primary', 'header-button');
            controlledBackButton.classList.remove('header-back-home'); // Remove default class if specifically added below


            // 6. Ensure visibility
            controlledBackButton.style.display = 'inline-flex';
        }

        // --- REVISED: resetBackButtonToDefault ---
        async function resetBackButtonToDefault() {
            if (!controlledBackButton) {
                console.error("Cannot reset back button: element not found.");
                return;
            }
            console.log("Resetting back button to default.");

            // 1. Remove the custom click listener
            if (currentBackListener) {
                controlledBackButton.removeEventListener('click', currentBackListener);
                currentBackListener = null;
            }

            // 2. Restore the original href
            controlledBackButton.href = 'javascript:window.history.back();' || originalBackButtonHref;


            // 3. Clear the dynamic text
            const textSpan = controlledBackButton.querySelector('.back-button-text');
            if (textSpan) {
                textSpan.textContent = '';
                textSpan.style.display = 'none'; // Hide the span for default view
            }

            // 4. Restore original aria-label
            controlledBackButton.setAttribute('aria-label', 'Вернуться на главную');

            // 5. REMOVE Styling Classes from Dynamic State
            controlledBackButton.classList.remove('btn', 'btn--primary', 'header-button');
            controlledBackButton.classList.add('header-back-home'); // Re-add default class if needed

            // 6. Ensure visibility
            controlledBackButton.style.display = 'inline-flex';
        }

        // Функция для получения кнопок блоков в зависимости от ЖК
        function getBlockButtons(jkName) {
            if (jkName === 'ЖК_Бахор') {
                return `
                    <button class="block-btn" data-block="Блок 1,2" style="top: 20%; left: 15%;">Блок 1,2</button>
                    <button class="block-btn" data-block="Блок 3,4" style="top: 20%; left: 35%;">Блок 3,4</button>
                    <button class="block-btn" data-block="Блок 5,6" style="top: 20%; left: 55%;">Блок 5,6</button>
                    <button class="block-btn" data-block="Блок 7,8" style="top: 20%; left: 75%;">Блок 7,8</button>
                `;
            } else {
                // Для ЖК Рассвет и других
                return `
                    <button class="block-btn" data-block="А" style="top: 15%; left: 8%;">А</button>
                    <button class="block-btn" data-block="Б" style="top: 15%; left: 25%;">Б</button>
                    <button class="block-btn" data-block="В" style="top: 15%; left: 42%;">В</button>
                    <button class="block-btn" data-block="Г" style="top: 15%; left: 59%;">Г</button>
                    <button class="block-btn" data-block="Д" style="top: 15%; left: 76%;">Д</button>
                    <button class="block-btn" data-block="Е" style="top: 15%; left: 92%;">Е</button>
                `;
            }
        }

        // Функция для выбора ЖК (кнопка "Выбрать квартиру")
        async function selectComplex(complexName) {
            console.log(`Выбран ЖК: ${complexName}`);
            try {
                const response = await fetch(`/api/complexes/jk/${complexName}`);
                const result = await response.json();
                if (result.status === "success") {
                    updateRegistryContracts(result.registryContracts || []);
                    console.log("Данные ЖК:", result);
                    showJKDetails(result.shaxmatka, result.render, complexName);
                } else {
                    alert(`Ошибка: ${result.message}`);
                }
            } catch (error) {
                console.error("Ошибка при загрузке данных ЖК:", error);
                alert('Ошибка при загрузке данных ЖК: ' + error.message);
            }
        }

        // Функция для отображения информации о ЖК и карты
        function showComplexInfo(complexData, jkName) {
            const jkDetailsContainer = document.getElementById("jk-details-container");

            // Показываем информацию внизу страницы (не скрывая карточки)
            jkDetailsContainer.style.display = "block";
            jkDetailsContainer.style.opacity = "0";
            jkDetailsContainer.style.transform = "translateY(50px)";
            jkDetailsContainer.innerHTML = "";

            // Данные для ЖК (можно расширить)
            const complexInfo = {
                "ЖК_Рассвет": {
                    class: "комфорт +",
                    floors: 12,
                    address: "Ташкентская область, город Чирчик, Кимёгарлар МСГ улица Амир Темур дом №125",
                    completion: "IV 2026",
                    mapUrl: "https://yandex.uz/maps/114900/chirchiq/?ll=69.571266,41.466346&mode=whatshere&whatshere[point]=69.570498,41.467903&whatshere[zoom]=20&z=17.34"
                },
                "ЖК_Бахор": {
                    class: "комфорт",
                    floors: 6,
                    address: "Ташкентская область, город Чирчик, Хумо МСГ 8 микрорайон дом 36A",
                    completion: "II 2027",
                    mapUrl: "https://yandex.uz/maps/114900/chirchiq/?ll=69.548823%2C41.461406&mode=whatshere&whatshere[point]=69.549232%2C41.461742&whatshere[zoom]=18.22&z=17.6"
                }
            };

            const info = complexInfo[jkName] || {
                class: "комфорт",
                floors: 8,
                address: "Адрес не указан",
                completion: "2026",
                mapUrl: "https://yandex.uz/maps/"
            };

            // Создаем HTML для информации о ЖК
            jkDetailsContainer.innerHTML = `
                <div class="complex-info-section">
                    <div class="complex-info-header">
                        <h2 class="complex-info-title">${jkName}</h2>
                    </div>
                    
                    <div class="complex-info-content">
                        <div class="complex-info-image">
                            <img src="${complexData.render}" alt="Рендер ${jkName}" class="complex-detail-image">
                        </div>
                        
                        <div class="complex-info-details">
                            <div class="info-item">
                                <span class="info-label">Класс:</span>
                                <span class="info-value">${info.class}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Этажность:</span>
                                <span class="info-value">${info.floors}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Адрес:</span>
                                <span class="info-value">${info.address}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Сдача:</span>
                                <span class="info-value">${info.completion}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="map-section">
                    <h3 class="map-title">Расположение на карте</h3>
                    <div class="map-container">
                        <iframe 
                            src="${info.mapUrl}" 
                            width="100%" 
                            height="400" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                    <div class="map-actions">
                        <button class="hide-info-btn" onclick="closeComplexInfo()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Скрыть информацию
                        </button>
                    </div>
                </div>
            `;

            // Плавная анимация появления
            setTimeout(() => {
                jkDetailsContainer.style.transition = "transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.6s cubic-bezier(0.25, 0.8, 0.25, 1)";
                jkDetailsContainer.style.opacity = "1";
                jkDetailsContainer.style.transform = "translateY(0)";
            }, 50);

            // Плавная прокрутка к секции
            setTimeout(() => {
                jkDetailsContainer.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        // Функция для закрытия информации о ЖК
        function closeComplexInfo() {
            const jkDetailsContainer = document.getElementById("jk-details-container");
            
            // Анимация исчезновения
            jkDetailsContainer.style.transition = "transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)";
            jkDetailsContainer.style.opacity = "0";
            jkDetailsContainer.style.transform = "translateY(30px)";
            
            // Скрываем после анимации
            setTimeout(() => {
                jkDetailsContainer.style.display = "none";
            }, 400);
        }

        // Функция для отображения данных ЖК на сайте
        function showJKDetails(shaxmatkaData, renderImage, jkName, options = {}) {
            const preserveBlock = options.preserveBlock || null;

            globalShaxmatkaData = shaxmatkaData;
            globalRenderImage = renderImage;
            currentJKName = jkName;
            if (preserveBlock) {
                currentBlockName = preserveBlock;
            } else {
                currentBlockName = null;
                currentFloorFilter = null;
            }

            if (currentViewMode !== ViewModes.FACADES) {
                renderChessDetails(shaxmatkaData, jkName, preserveBlock, currentViewMode);
                return;
            }

            const complexesContainer = document.getElementById("complexes-container");
            const jkDetailsContainer = document.getElementById("jk-details-container");

            complexesContainer.style.display = "none";

            // Очищаем контейнер и строим двухколоночный лэйаут (рендер слева, панель справа)
            jkDetailsContainer.innerHTML = "";
            jkDetailsContainer.style.display = "block";
            jkDetailsContainer.style.position = "relative";
            jkDetailsContainer.style.maxWidth = "100%";

            const header = document.createElement('div');
            header.className = 'demo-header';
            header.innerHTML = `
                <h1 class="demo-title">${jkName} - Выбор блока</h1>
                <p class="demo-subtitle">Кликните на блок для просмотра доступных квартир</p>
            `;
            jkDetailsContainer.appendChild(header);

            const blocksContent = document.createElement('div');
            blocksContent.className = 'blocks-content';

            // Левая часть (рендер)
            const buildingSection = document.createElement('div');
            buildingSection.className = 'building-section';

            const buildingWrapper = document.createElement('div');
            buildingWrapper.className = 'building-wrapper';

            const image = document.createElement('img');
            image.src = renderImage;
            image.alt = `Рендер ЖК ${jkName}`;
            image.className = 'building-image';
            buildingWrapper.appendChild(image);

            // Кнопки блоков поверх картинки
            const coordsMap = {
                "Блок-1": { top: 34, left: 78 },
                "Блок-1,1": { top: 26, left: 56 },
                "Блок 2": { top: 20, left: 40 },
                "Блок 1,2": { top: 14, left: 27 },
                "Блок 1,3": { top: 10, left: 13 },
                "Блок 3": { top: 50, left: 61 },
                "Блок 3,1": { top: 33, left: 28 },
                "Блок 3,2": { top: 22, left: 7 },
                "А": { top: 15, left: 8 },
                "Б": { top: 15, left: 25 },
                "В": { top: 15, left: 42 },
                "Г": { top: 15, left: 59 },
                "Д": { top: 15, left: 76 },
                "Е": { top: 15, left: 92 },



                // Добавьте остальные блоки и скорректируйте координаты
            };

            let uniqueBlocks = [...new Set(shaxmatkaData.map(row => row[0]))];
            
            // Сортируем блоки для ЖК Бахор в правильном порядке
            if (jkName === 'ЖК_Бахор') {
                const blockOrder = ['Блок 1', 'Блок 1,1', 'Блок 1,2', 'Блок 1,3', 'Блок 2', 'Блок 3', 'Блок 3,1', 'Блок 3,2', 'Блок-1', 'Блок-1,1'];
                uniqueBlocks = uniqueBlocks.sort((a, b) => {
                    const indexA = blockOrder.indexOf(a);
                    const indexB = blockOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            }
            
            uniqueBlocks.forEach(blockName => {
                const btn = document.createElement('button');
                btn.className = 'overlay-block-btn';
                btn.textContent = blockName;
                const pos = coordsMap[blockName] || { top: 0, left: 0 };
                btn.style.top = pos.top + '%';
                btn.style.left = pos.left + '%';
                if (/\d/.test(blockName)) btn.style.fontSize = '10px';
                btn.addEventListener('click', () => {
                    filterBlockData(globalShaxmatkaData, blockName, globalRenderImage, jkName, currentFloorFilter || undefined);
                });
                buildingWrapper.appendChild(btn);
            });

            buildingSection.appendChild(buildingWrapper);

            // Правая часть (панель)
            const apartmentsPanel = document.createElement('div');
            apartmentsPanel.className = 'apartments-panel';

            // Собираем общий контейнер
            blocksContent.appendChild(buildingSection);
            blocksContent.appendChild(apartmentsPanel);
            jkDetailsContainer.appendChild(blocksContent);

            // Сбрасываем классы панели на случай возврата из предыдущего состояния
            blocksContent.classList.remove('panel-open', 'panel-mode-overlay', 'panel-mode-split');

            // Плейсхолдер до выбора блока
            apartmentsPanel.innerHTML = `
                <div class="apartments-empty">
                    <h3>Выберите блок</h3>
                    <p>Нажмите на маркер нужного блока на фасаде, чтобы увидеть список квартир.</p>
                </div>
            `;

            buildingWrapper.querySelectorAll('.overlay-block-btn').forEach(btn => {
                btn.style.visibility = '';
            });

            // const image = document.createElement("img");
            // console.log(`Проверка пути к изображению: ${renderImage}`);
            // image.src = renderImage;
            // image.alt = `Рендер ЖК ${jkName}`;
            // image.className = "jk-render-image";
            // jkDetailsContainer.appendChild(image);

            const shouldRestoreBlock = preserveBlock && uniqueBlocks.includes(preserveBlock);
            if (shouldRestoreBlock) {
                filterBlockData(shaxmatkaData, preserveBlock, renderImage, jkName, currentFloorFilter || undefined);
            }

            // --- Use the helper function to update the back button ---
            updateBackButton("Назад к ЖК", () => { // Pass the TEXT and the ACTION
                const complexesContainer = document.getElementById("complexes-container");
                const jkDetailsContainer = document.getElementById("jk-details-container");
                if (jkDetailsContainer) jkDetailsContainer.style.display = "none";
                if (complexesContainer) complexesContainer.style.display = "flex"; // Or original display
                resetBackButtonToDefault(); // RESET button when back on the main list
            });
            // --- No need to add button manually here ---

            // jkDetailsContainer.style.display = "inline-block"; // Already set
        }

        document.addEventListener('DOMContentLoaded', function () {
            const complexesContainer = document.getElementById("complexes-container");

            complexesContainer.addEventListener('click', async function (event) {
                const card = event.target.closest(".complex-card");
                const button = event.target.closest(".select-apartment-btn");
                
                // Если клик по кнопке "Выбрать квартиру", переходим к выбору блоков
                if (button) {
                    const jkName = card.getAttribute("data-jk-name");
                    console.log(`Выбран ЖК для выбора квартир: ${jkName}`);
                    await selectComplex(jkName);
                }
                // Если клик по карточке (но не по кнопке), показываем информацию снизу
                else if (card) {
                    const jkName = card.getAttribute("data-jk-name");
                    console.log(`Выбран ЖК для показа информации: ${jkName}`);

                    try {
                        const response = await fetch(`/api/complexes/jk/${jkName}`);
                        const result = await response.json();

                        if (result.status === "success") {
                            updateRegistryContracts(result.registryContracts || []);
                            console.log("Данные ЖК:", result);
                            // Показываем информацию о ЖК снизу
                            showComplexInfo(result, jkName);
                        } else {
                            alert(`Ошибка: ${result.message}`);
                        }
                    } catch (error) {
                        console.error("Ошибка при загрузке данных ЖК:", error);
                    }
                }
            });
        });

        // Helper: hide overlay buttons that are covered by the side panel (pixel precise)
        function updateOverlayButtonsVisibility(blocksContent, sidePanel, useOverlay) {
            const buttons = blocksContent.querySelectorAll('.overlay-block-btn');
            if (!buttons.length) return;
            if (!useOverlay) { buttons.forEach(b => b.style.visibility = ''); return; }
            const panelRect = sidePanel.getBoundingClientRect();
            buttons.forEach(btn => {
                const r = btn.getBoundingClientRect();
                const intersects = !(r.right <= panelRect.left || r.left >= panelRect.right || r.bottom <= panelRect.top || r.top >= panelRect.bottom);
                btn.style.visibility = intersects ? 'hidden' : '';
            });
        }

        function renderChessDetails(shaxmatkaData, jkName, preservedBlock, mode) {
            const complexesContainer = document.getElementById("complexes-container");
            const jkDetailsContainer = document.getElementById("jk-details-container");

            complexesContainer.style.display = "none";
            jkDetailsContainer.style.display = "block";
            jkDetailsContainer.style.position = "relative";
            jkDetailsContainer.style.maxWidth = "100%";
            jkDetailsContainer.innerHTML = "";

            currentFloorFilter = null;

            const wrapper = document.createElement('div');
            wrapper.className = 'chess-wrapper';

            const header = document.createElement('div');
            header.className = 'chess-header';
            const title = document.createElement('div');
            title.className = 'chess-title';
            if (mode === ViewModes.CHESS_PLUS) {
                title.textContent = `${jkName} — Шахматка+`;
            } else {
                title.textContent = `${jkName} — Шахматка`;
            }
            header.appendChild(title);

            if (mode === ViewModes.CHESS) {
                chessBlockButtonsWrap = document.createElement('div');
                chessBlockButtonsWrap.className = 'chess-block-switcher';
                header.appendChild(chessBlockButtonsWrap);
            } else {
                chessBlockButtonsWrap = null;
            }

            wrapper.appendChild(header);

            chessViewContainer = document.createElement('div');
            chessViewContainer.className = 'chess-grid';
            wrapper.appendChild(chessViewContainer);

            jkDetailsContainer.appendChild(wrapper);

            let blockNames = Array.from(new Set(shaxmatkaData
                .map(row => (row[0] || '').toString().trim())
                .filter(Boolean)));
            
            // Сортируем блоки для ЖК Бахор в правильном порядке
            if (jkName === 'ЖК_Бахор') {
                const blockOrder = ['Блок-1', 'Блок-1,1', 'Блок 1,2', 'Блок 1,3', 'Блок 2', 'Блок 3', 'Блок 3,1', 'Блок 3,2', 'Блок-1', 'Блок-1,1'];
                blockNames = blockNames.sort((a, b) => {
                    const indexA = blockOrder.indexOf(a);
                    const indexB = blockOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            }

            if (chessBlockButtonsWrap) {
                chessBlockButtonsWrap.innerHTML = '';
                blockNames.forEach(name => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'chess-block-btn';
                    btn.dataset.block = name;
                    btn.textContent = name;
                    btn.addEventListener('click', () => {
                        renderChessBlock(shaxmatkaData, name, jkName, mode);
                    });
                    chessBlockButtonsWrap.appendChild(btn);
                });
            }

            if (mode === ViewModes.CHESS_PLUS) {
                renderChessPlusAll(shaxmatkaData, jkName);
            } else {
                const defaultBlock = preservedBlock && blockNames.includes(preservedBlock)
                    ? preservedBlock
                    : (blockNames[0] || null);

                if (defaultBlock) {
                    renderChessBlock(shaxmatkaData, defaultBlock, jkName, mode);
                } else {
                    chessViewContainer.innerHTML = '<p style="text-align:center;color:#64748b;">Нет данных по выбранному ЖК.</p>';
                }
            }

            updateBackButton("Назад к выбору ЖК", () => {
                chessViewContainer = null;
                chessBlockButtonsWrap = null;
                currentBlockName = null;
                const jkDetailsContainer = document.getElementById("jk-details-container");
                jkDetailsContainer.style.display = "none";
                const complexesContainer = document.getElementById("complexes-container");
                complexesContainer.style.display = "flex";
                resetBackButtonToDefault();
            });
        }

        function renderChessBlock(shaxmatkaData, blockName, jkName, mode) {
            if (!chessViewContainer) return;

            if (mode === ViewModes.CHESS_PLUS) {
                currentBlockName = null;
                renderChessPlusAll(shaxmatkaData, jkName);
                return;
            }

            currentBlockName = blockName;

            if (chessBlockButtonsWrap) {
                chessBlockButtonsWrap.querySelectorAll('.chess-block-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.block === blockName);
                });
            }

            const filteredData = shaxmatkaData.filter(row => (row[0] || '').toString().trim() === blockName);

            const floors = filteredData.reduce((acc, row) => {
                const rawFloor = row[6];
                let key = rawFloor;
                if (key !== undefined && key !== null) {
                    key = (typeof key === 'number') ? key : parseFloat(String(key).replace(',', '.'));
                }
                if (Number.isNaN(key) || key === undefined || key === null) {
                    key = '—';
                }
                if (!acc[key]) acc[key] = [];
                acc[key].push(row);
                return acc;
            }, {});
            Object.keys(floors).forEach(key => {
                floors[key] = sortApartmentRows(floors[key]);
            });

            const sortedFloors = Object.keys(floors).sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                if (!Number.isNaN(numA) && !Number.isNaN(numB)) {
                    return numB - numA;
                }
                return String(b).localeCompare(String(a), 'ru');
            });

            chessViewContainer.innerHTML = '';

            const floorsWrapper = document.createElement('div');
            floorsWrapper.className = 'floors-scroll-wrapper';

            sortedFloors.forEach(floorKey => {
                const floorRow = document.createElement('div');
                floorRow.className = 'floor-row';

                const floorLabel = document.createElement('div');
                floorLabel.className = 'floor-label';
                floorLabel.textContent = floorKey === '—' ? '-' : floorKey;
                floorRow.appendChild(floorLabel);

                const apartmentGrid = document.createElement('div');
                apartmentGrid.className = 'apartment-grid';

                floors[floorKey].forEach(row => {
                    const statusMap = {
                        'свободна': 'available',
                        'продана': 'sold',
                        'бронь': 'booked'
                    };
                    const statusRaw = (row[2] || '').toString().trim().toLowerCase();
                    const mappedStatus = statusMap[statusRaw] || 'unavailable';

                    const card = document.createElement('div');
                    card.className = `apartment-card ${mappedStatus}`;
                    card.setAttribute('data-jk-name', jkName);
                    card.setAttribute('data-block', blockName);
                    if (row[5]) card.setAttribute('data-size', row[5]);
                    if (row[6] !== undefined && row[6] !== null) card.setAttribute('data-floor', row[6]);
                    card.setAttribute('data-unitType', row[1]);
                    card.setAttribute('data-number', row[4]);
                    card.setAttribute('data-rooms', row[3] || '');
                    const contractNumber = getContractNumberForRow(row);
                    const showContractTag = contractNumber && mappedStatus === 'sold';
                    if (showContractTag) {
                        card.setAttribute('data-contract-number', contractNumber);
                    }

                    const price = statusRaw === 'свободна' && row.length > 7 && row[7]
                        ? `от ${Number(String(row[7]).replace(/\s/g, '')).toLocaleString('ru-RU')}`
                        : '';
                    const cleanedPrice = price.replace(/от\s*/gi, '').trim();
                    const areaLabel = row[5] ? `${row[5]} м²` : '— м²';
                    const contractFooter = showContractTag ? `<span class="card-contract">Договор ${contractNumber}</span>` : '';
                    const footerRight = (!showContractTag && cleanedPrice) ? '<span>сум</span>' : '';

                    card.innerHTML = `
                        <div class="card-header">
                            <span>${row[1] || 'Тип'}</span>
                            <span>№${row[4] || '-'}</span>
                        </div>
                        <div class="card-price">${cleanedPrice || (row[2] || 'Неизвестно')}</div>
                        <div class="card-footer">
                            <div class="card-area">
                                <span>${areaLabel}</span>
                                ${contractFooter}
                            </div>
                            ${footerRight}
                        </div>
                    `;

                    apartmentGrid.appendChild(card);
                });

                floorRow.appendChild(apartmentGrid);
                floorsWrapper.appendChild(floorRow);
            });

            if (!sortedFloors.length) {
                const empty = document.createElement('p');
                empty.style.textAlign = 'center';
                empty.style.color = '#64748b';
                empty.textContent = 'Нет квартир для выбранного блока.';
                floorsWrapper.appendChild(empty);
            }

            chessViewContainer.appendChild(floorsWrapper);

            requestAnimationFrame(() => {
                const grids = floorsWrapper.querySelectorAll('.apartment-grid');
                let maxWidth = 0;
                grids.forEach(grid => {
                    maxWidth = Math.max(maxWidth, grid.scrollWidth);
                });
                grids.forEach(grid => {
                    grid.style.minWidth = maxWidth + 'px';
                });
            });
        }

        function renderChessPlusAll(shaxmatkaData, jkName) {
            if (!chessViewContainer) return;

            const groupedByBlock = shaxmatkaData.reduce((acc, row) => {
                const block = (row[0] || '').toString().trim();
                if (!block) return acc;
                if (!acc[block]) acc[block] = [];
                acc[block].push(row);
                return acc;
            }, {});

            const blockNames = Object.keys(groupedByBlock).sort((a, b) => a.localeCompare(b, 'ru'));
            chessViewContainer.innerHTML = '';

            if (!blockNames.length) {
                chessViewContainer.innerHTML = '<p style="text-align:center;color:#64748b;">Нет данных по выбранному ЖК.</p>';
                return;
            }

            const strip = document.createElement('div');
            strip.className = 'chess-plus-strip';

            blockNames.forEach(blockName => {
                const section = document.createElement('div');
                section.className = 'chess-plus-section';

                const headerPill = document.createElement('div');
                headerPill.className = 'chess-plus-header';
                headerPill.textContent = blockName;
                section.appendChild(headerPill);

                const grid = document.createElement('div');
                grid.className = 'chess-plus-grid';

                const floors = groupedByBlock[blockName].reduce((acc, row) => {
                    const rawFloor = row[6];
                    let key = rawFloor;
                    if (key !== undefined && key !== null) {
                        key = (typeof key === 'number') ? key : parseFloat(String(key).replace(',', '.'));
                    }
                    if (Number.isNaN(key) || key === undefined || key === null) {
                        key = '—';
                    }
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(row);
                    return acc;
                }, {});
                Object.keys(floors).forEach(key => {
                    floors[key] = sortApartmentRows(floors[key]);
                });

                const sortedFloors = Object.keys(floors).sort((a, b) => {
                    const numA = parseFloat(a);
                    const numB = parseFloat(b);
                    if (!Number.isNaN(numA) && !Number.isNaN(numB)) {
                        return numB - numA;
                    }
                    return String(b).localeCompare(String(a), 'ru');
                });

                if (!sortedFloors.length) {
                    const emptyState = document.createElement('p');
                    emptyState.style.textAlign = 'center';
                    emptyState.style.color = '#64748b';
                    emptyState.textContent = 'Нет квартир в этом блоке.';
                    grid.appendChild(emptyState);
                } else {
                    sortedFloors.forEach(floorKey => {
                        const rowEl = document.createElement('div');
                        rowEl.className = 'chess-plus-row';

                        const floorPill = document.createElement('div');
                        floorPill.className = 'chess-plus-floor';
                        floorPill.textContent = floorKey === '—' ? '-' : floorKey;
                        rowEl.appendChild(floorPill);

                        const cellsWrap = document.createElement('div');
                        cellsWrap.className = 'chess-plus-cells';

                        floors[floorKey].forEach(row => {
                            const statusRaw = (row[2] || '').toString();
                            const statusLower = statusRaw.toLowerCase();
                            let statusClass = 'status-unknown';
                            let shortLabel = row[1] ? String(row[1]) : '—';

                            if (statusLower.includes('свобод')) {
                                statusClass = 'status-available';
                                shortLabel = 'Ст';
                            } else if (statusLower.includes('брон') || statusLower.includes('резерв')) {
                                statusClass = 'status-booked';
                                shortLabel = 'Бр';
                            } else if (statusLower.includes('недоступ')) {
                                statusClass = 'status-unknown';
                                shortLabel = 'Нд';
                            } else if (statusLower.includes('прод')) {
                                statusClass = 'status-sold';
                                shortLabel = row[1] ? String(row[1]) : 'Пр';
                            }

                            const cell = document.createElement('div');
                            cell.className = `chess-plus-cell ${statusClass}`;

                            const rawSize = row[5];
                            let formattedSize = '';
                            if (rawSize !== undefined && rawSize !== null) {
                                const trimmedSize = String(rawSize).trim();
                                if (trimmedSize) {
                                    const normalizedNumeric = trimmedSize
                                        .replace(/\s+/g, '')
                                        .replace(/,/g, '.')
                                        .replace(/[^0-9.]/g, '');
                                    const numericValue = normalizedNumeric ? Number.parseFloat(normalizedNumeric) : Number.NaN;
                                    if (Number.isFinite(numericValue) && numericValue > 0) {
                                        const hasFraction = !Number.isInteger(numericValue);
                                        const formatter = new Intl.NumberFormat('ru-RU', {
                                            minimumFractionDigits: hasFraction ? 1 : 0,
                                            maximumFractionDigits: 1
                                        });
                                        formattedSize = `${formatter.format(numericValue)} м²`;
                                    } else {
                                        formattedSize = trimmedSize;
                                    }
                                }
                            }

                            const sizeValueForDisplay = formattedSize || '—';
                            const sizeEl = document.createElement('span');
                            sizeEl.className = 'chess-plus-cell-size';
                            sizeEl.textContent = sizeValueForDisplay;
                            cell.appendChild(sizeEl);

                            if (statusRaw) {
                                cell.title = statusRaw;
                            }
                            cell.setAttribute('data-jk-name', jkName);
                            cell.setAttribute('data-block', blockName);
                            if (row[5]) cell.setAttribute('data-size', row[5]);
                            if (row[6] !== undefined && row[6] !== null) cell.setAttribute('data-floor', row[6]);
                            cell.setAttribute('data-unitType', row[1]);
                            cell.setAttribute('data-number', row[4]);
                            cell.setAttribute('data-rooms', row[3] || '');
                            const contractNumber = getContractNumberForRow(row);
                            if (contractNumber && statusClass === 'status-sold') {
                                cell.setAttribute('data-contract-number', contractNumber);
                            }

                            cellsWrap.appendChild(cell);
                        });

                        rowEl.appendChild(cellsWrap);
                        grid.appendChild(rowEl);
                    });
                }

                section.appendChild(grid);
                strip.appendChild(section);
            });

            chessViewContainer.appendChild(strip);
        }

        function filterBlockData(shaxmatkaData, block, renderImage, jkName, selectedFloor = null) {
            console.log("Проверка данных shaxmatkaData в filterBlockData:", shaxmatkaData);

            if (currentViewMode !== ViewModes.FACADES) {
                renderChessBlock(shaxmatkaData, block, jkName, currentViewMode);
                return;
            }

            const previousBlock = currentBlockName;
            currentBlockName = block;
            currentJKName = jkName;

            const jkDetailsContainer = document.getElementById("jk-details-container");
            jkDetailsContainer.style.maxWidth = "100%";

            const filteredData = shaxmatkaData.filter(row => row[0] === block);
            const floors = filteredData.reduce((acc, row) => {
                const rawFloor = row[6];
                const floorKey = rawFloor === undefined || rawFloor === null ? '' : String(rawFloor);
                if (!acc[floorKey]) acc[floorKey] = [];
                acc[floorKey].push(row);
                return acc;
            }, {});
            Object.keys(floors).forEach(key => {
                floors[key] = sortApartmentRows(floors[key]);
            });

            const availableFloors = Object.keys(floors).filter(key => key && key.toLowerCase() !== 'none');
            const sortedFloors = [...availableFloors].sort((a, b) => {
                const numA = Number(a);
                const numB = Number(b);
                const bothNumbers = !Number.isNaN(numA) && !Number.isNaN(numB);
                if (bothNumbers) {
                    return numB - numA;
                }
                return String(b).localeCompare(String(a), 'ru');
            });

            const reuseFloorFilter = previousBlock === block ? currentFloorFilter : null;
            let floorSelection = selectedFloor ?? reuseFloorFilter ?? null;
            if (!floorSelection || (floorSelection !== ALL_FLOORS_OPTION_VALUE && !floors[floorSelection])) {
                floorSelection = sortedFloors.length ? sortedFloors[0] : ALL_FLOORS_OPTION_VALUE;
            }
            currentFloorFilter = floorSelection;

            let blockSelect = null;
            let floorSelect = null;
            let planPlaceholder = null;
            let planZoomButton = null;

            const blocksContent = jkDetailsContainer.querySelector('.blocks-content');
            const sidePanel = jkDetailsContainer.querySelector('.apartments-panel');

            if (blocksContent && sidePanel) {
                const buildingWrapperEl = blocksContent.querySelector('.building-wrapper');
                const containerRect = blocksContent.getBoundingClientRect();
                const renderRect = buildingWrapperEl ? buildingWrapperEl.getBoundingClientRect() : { width: 0 };
                const horizontalFree = containerRect.width - renderRect.width;
                const useOverlay = horizontalFree <= 80;

                blocksContent.classList.add('panel-open');
                blocksContent.classList.toggle('panel-mode-overlay', useOverlay);
                blocksContent.classList.toggle('panel-mode-split', !useOverlay);

                sidePanel.innerHTML = '';
                const header = document.createElement('div');
                header.className = 'apartments-header';

                const filtersWrap = document.createElement('div');
                filtersWrap.className = 'apartment-filters';

                const blockGroup = document.createElement('div');
                blockGroup.className = 'filter-group';
                const blockLabel = document.createElement('h3');
                blockLabel.textContent = 'Блок:';
                blockSelect = document.createElement('select');
                blockSelect.className = 'filter-select';
                const blocksSet = new Set(shaxmatkaData.map(r => r[0]).filter(Boolean));
                [...blocksSet].forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === block) opt.selected = true;
                    blockSelect.appendChild(opt);
                });
                blockGroup.appendChild(blockLabel);
                blockGroup.appendChild(blockSelect);

                const floorGroup = document.createElement('div');
                floorGroup.className = 'filter-group';
                const floorLabel = document.createElement('h3');
                floorLabel.textContent = 'Этаж:';
                floorSelect = document.createElement('select');
                floorSelect.className = 'filter-select';
                const allOption = document.createElement('option');
                allOption.value = ALL_FLOORS_OPTION_VALUE;
                allOption.textContent = 'Все этажи';
                if (floorSelection === ALL_FLOORS_OPTION_VALUE) {
                    allOption.selected = true;
                }
                floorSelect.appendChild(allOption);
                sortedFloors.forEach(floorKey => {
                    const option = document.createElement('option');
                    option.value = floorKey;
                    option.textContent = `Этаж ${floorKey}`;
                    if (floorSelection === floorKey) {
                        option.selected = true;
                    }
                    floorSelect.appendChild(option);
                });
                floorGroup.appendChild(floorLabel);
                floorGroup.appendChild(floorSelect);

                filtersWrap.appendChild(blockGroup);
                filtersWrap.appendChild(floorGroup);

                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-filters-btn';
                closeBtn.title = 'Закрыть';
                closeBtn.textContent = '×';

                header.appendChild(filtersWrap);
                header.appendChild(closeBtn);
                sidePanel.appendChild(header);

                const cleanup = () => {
                    blocksContent.classList.remove('panel-open', 'panel-mode-overlay', 'panel-mode-split');
                    blocksContent.querySelectorAll('.overlay-block-btn').forEach(b => b.style.visibility = '');
                    if (sidePanel.__resizeHandler) {
                        window.removeEventListener('resize', sidePanel.__resizeHandler);
                        sidePanel.__resizeHandler = null;
                    }
                    if (lastFloorPlanObjectUrl) {
                        URL.revokeObjectURL(lastFloorPlanObjectUrl);
                        lastFloorPlanObjectUrl = null;
                    }
                    currentFloorPlanUrl = null;
                };

                closeBtn.addEventListener('click', cleanup);
                blockSelect.addEventListener('change', () => {
                    const nextBlock = blockSelect.value;
                    filterBlockData(shaxmatkaData, nextBlock, renderImage, jkName);
                });
                floorSelect.addEventListener('change', () => {
                    filterBlockData(shaxmatkaData, blockSelect.value, renderImage, jkName, floorSelect.value);
                });

                const planContainer = document.createElement('div');
                planContainer.className = 'floor-plan-container';
                planContainer.innerHTML = `
                    <div class="floor-plan">
                        <div class="floor-plan-image-placeholder">
                            <div class="placeholder-text">
                                <p>План этажа</p>
                                <small>Выберите этаж в списке выше</small>
                            </div>
                        </div>
                        <button class="zoom-button" title="Открыть план"><i class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
                    </div>
                `;
                sidePanel.appendChild(planContainer);

                planPlaceholder = planContainer.querySelector('.floor-plan-image-placeholder');
                planZoomButton = planContainer.querySelector('.zoom-button');
                if (planZoomButton) {
                    planZoomButton.disabled = true;
                    planZoomButton.addEventListener('click', () => {
                        if (currentFloorPlanUrl) {
                            window.open(currentFloorPlanUrl, '_blank');
                        }
                    });
                }

                if (sidePanel.__resizeHandler) {
                    window.removeEventListener('resize', sidePanel.__resizeHandler);
                    sidePanel.__resizeHandler = null;
                }

                updateOverlayButtonsVisibility(blocksContent, sidePanel, useOverlay);
                const onResize = () => updateOverlayButtonsVisibility(blocksContent, sidePanel, useOverlay);
                window.addEventListener('resize', onResize, { passive: true });
                sidePanel.__resizeHandler = onResize;
            } else {
                jkDetailsContainer.innerHTML = "";
            }

            const apartmentsListWrap = document.createElement('div');
            apartmentsListWrap.className = 'apartments-list';

            const fallbackFloors = Object.keys(floors);
            const floorsToRender = (floorSelection && floorSelection !== ALL_FLOORS_OPTION_VALUE)
                ? [floorSelection]
                : (sortedFloors.length ? sortedFloors : fallbackFloors);
            const items = [];
            floorsToRender.forEach(floorKey => {
                if (!floors[floorKey]) return;
                floors[floorKey].forEach(row => items.push(row));
            });
            if (floorSelection === ALL_FLOORS_OPTION_VALUE) {
                fallbackFloors
                    .filter(key => !floorsToRender.includes(key))
                    .forEach(key => {
                        if (!floors[key]) return;
                        floors[key].forEach(row => items.push(row));
                    });
            }

            items.forEach(row => {
                const statusMap = {
                    "свободна": "available",
                    "продана": "sold",
                    "бронь": "booked"
                };
                const statusRaw = (row[2] || '').trim();
                const mappedStatus = statusMap[statusRaw.toLowerCase()] || 'unknown';
                const statusLabel = statusRaw ? statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1) : 'Неизвестно';

                if (!jkName || !block) {
                    console.warn("Некорректные данные для квартиры:", { jkName, block, row });
                    return;
                }

                const item = document.createElement('div');
                item.className = 'apt-item';

                const rooms = row[3] || 'Не указано';
                const size = row[5];
                const floorLabel = row[6] ? `Этаж ${row[6]}` : '';
                const unitType = row[1] ? `${row[1]} ` : '';
                const aptNumber = row[4] || '-';

                item.setAttribute('data-jk-name', jkName);
                item.setAttribute('data-block', block);
                if (size) item.setAttribute('data-size', size);
                if (row[6]) item.setAttribute('data-floor', row[6]);
                item.setAttribute('data-unitType', row[1]);
                item.setAttribute('data-number', row[4]);
                item.setAttribute('data-rooms', rooms);
                const contractNumber = getContractNumberForRow(row);
                if (contractNumber && mappedStatus === 'sold') {
                    item.setAttribute('data-contract-number', contractNumber);
                }

                const priceRaw = row.length > 7 ? row[7] : null;
                const numericPrice = priceRaw ? Number(String(priceRaw).replace(/\s/g, '').replace(/,/g, '.')) : null;
                const priceVal = Number.isFinite(numericPrice) ? numericPrice : null;
                const priceText = priceVal ? priceVal.toLocaleString('ru-RU') + ' сум' : 'Цена по запросу';
                const priceClass = priceVal ? 'apt-price-main' : 'apt-price-main muted';
                const areaText = size ? `${size} м²` : '';

                item.innerHTML = `
                    <div class="apt-card">
                        <div class="apt-thumb">
                            <div class="thumb-placeholder">План</div>
                            <img alt="План квартиры ${aptNumber}">
                        </div>
                        <div class="apt-body">
                            <div class="apt-heading">
                                <div>
                                    <div class="apt-title-main">${unitType}Квартира №${aptNumber}</div>
                                    <div class="apt-subtitle">${rooms}-комн ${floorLabel ? '• ' + floorLabel : ''}</div>
                                </div>
                                <div class="apt-status-pill ${mappedStatus}">${statusLabel}</div>
                            </div>
                            <div class="apt-details-row">
                                <div class="${priceClass}">${priceText}</div>
                                <div class="apt-meta-pill">${areaText || '—'}</div>
                            </div>
                        </div>
                    </div>
                `;

                const thumbImg = item.querySelector('.apt-thumb img');
                const thumbPlaceholder = item.querySelector('.apt-thumb .thumb-placeholder');
                if (thumbImg && size) {
                    loadApartmentPlanThumbnail(thumbImg, thumbPlaceholder, jkName, block, size, statusRaw || '');
                }

                apartmentsListWrap.appendChild(item);
            });

            if (sidePanel) {
                sidePanel.appendChild(apartmentsListWrap);
            } else {
                jkDetailsContainer.appendChild(apartmentsListWrap);
            }

            if (planPlaceholder) {
                const showPlanPlaceholder = (message) => {
                    planPlaceholder.innerHTML = `
                        <div class="placeholder-text">
                            <p>План этажа</p>
                            <small>${message}</small>
                        </div>
                    `;
                };

                if (lastFloorPlanObjectUrl) {
                    URL.revokeObjectURL(lastFloorPlanObjectUrl);
                    lastFloorPlanObjectUrl = null;
                }

                const effectiveFloor = floorSelection && floorSelection !== ALL_FLOORS_OPTION_VALUE ? floorSelection : null;
                currentFloorPlanUrl = null;

                if (!effectiveFloor) {
                    showPlanPlaceholder('Выберите этаж в списке выше');
                    if (planZoomButton) planZoomButton.disabled = true;
                } else {
                    showPlanPlaceholder('Загружаем план этажа...');
                    if (planZoomButton) planZoomButton.disabled = true;

                    const planRequestToken = Symbol('floorPlan');
                    planPlaceholder.__planRequestToken = planRequestToken;

                    fetchFloorPlanImage(jkName, effectiveFloor, blockSelect ? blockSelect.value : block)
                        .then(data => {
                            if (planPlaceholder.__planRequestToken !== planRequestToken) {
                                if (data && data.objectUrl) {
                                    URL.revokeObjectURL(data.objectUrl);
                                }
                                return;
                            }

                            if (!data) {
                                showPlanPlaceholder('План для этого этажа отсутствует');
                                return;
                            }

                            planPlaceholder.innerHTML = '';
                            const img = document.createElement('img');
                            img.className = 'floor-plan-image';
                            img.src = data.imageUrl || data.sourceUrl || data.objectUrl;
                            img.alt = `План этажа ${effectiveFloor}`;
                            img.addEventListener('click', () => {
                                if (planZoomButton && !planZoomButton.disabled) {
                                    planZoomButton.click();
                                }
                            });
                            planPlaceholder.appendChild(img);

                            if (data.objectUrl && (!data.imageUrl || data.imageUrl === data.objectUrl)) {
                                if (lastFloorPlanObjectUrl) {
                                    URL.revokeObjectURL(lastFloorPlanObjectUrl);
                                }
                                lastFloorPlanObjectUrl = data.objectUrl;
                            }
                            currentFloorPlanUrl = data.sourceUrl || data.imageUrl || data.objectUrl;
                            if (planZoomButton) planZoomButton.disabled = false;
                        })
                        .catch(error => {
                            console.error('Ошибка загрузки плана этажа:', error);
                            if (planPlaceholder.__planRequestToken === planRequestToken) {
                                showPlanPlaceholder('Не удалось загрузить план этажа');
                            }
                        });
                }
        }

// Списки отрисованы — дополнительных вычислений ширины не требуется

            updateBackButton("Назад к выбору блоков", () => {
                if (!globalShaxmatkaData || !globalRenderImage || !jkName) {
                    const complexesContainer = document.getElementById("complexes-container");
                    const jkDetailsContainer = document.getElementById("jk-details-container");
                    if (jkDetailsContainer) jkDetailsContainer.style.display = "none";
                    if (complexesContainer) complexesContainer.style.display = "flex";
                    resetBackButtonToDefault();
                    return;
                }
                showJKDetails(globalShaxmatkaData, globalRenderImage, jkName);
            });
            jkDetailsContainer.style.display = "block";
        }

        // Раньше тут был drag-scroll для шахматки, он больше не нужен

        async function loadApartmentPlanThumbnail(imgEl, placeholderEl, jkName, blockName, apartmentSize, statusRaw) {
            if (!jkName || !blockName || !apartmentSize) return;
            const cacheKey = `${jkName}|${blockName}|${apartmentSize}`;

            const showImage = (url) => {
                if (!url) {
                    if (placeholderEl) {
                        placeholderEl.textContent = statusRaw && statusRaw.toLowerCase() === 'свободна' ? 'План' : 'Нет плана';
                    }
                    return;
                }
                if (imgEl) {
                    imgEl.src = url;
                    imgEl.style.display = 'block';
                }
                if (placeholderEl) placeholderEl.style.display = 'none';
            };

            if (apartmentPlanThumbnailCache.has(cacheKey)) {
                const cached = apartmentPlanThumbnailCache.get(cacheKey);
                if (cached && typeof cached.then === 'function') {
                    try {
                        const url = await cached;
                        showImage(url);
                    } catch (_) {
                        showImage(null);
                    }
                } else {
                    showImage(cached);
                }
                return;
            }

            const requestPromise = (async () => {
                try {
                    const url = await fetchPlanImage(jkName, blockName, apartmentSize);
                    return url;
                } catch (error) {
                    console.warn('Не удалось загрузить план квартиры', { jkName, blockName, apartmentSize, error });
                    return null;
                }
            })();

            apartmentPlanThumbnailCache.set(cacheKey, requestPromise);

            const resultUrl = await requestPromise;
            apartmentPlanThumbnailCache.set(cacheKey, resultUrl);
            showImage(resultUrl);
        }

        async function fetchFloorPlanImage(jkName, floorValue, blockName) {
            if (!jkName || !floorValue || floorValue === ALL_FLOORS_OPTION_VALUE) {
                return null;
            }

            const params = new URLSearchParams({
                jkName,
                floor: floorValue
            });

            if (blockName) {
                params.append('blockName', blockName);
            }

            const url = `/api/complexes/floor-plan?${params.toString()}`;
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 404) {
                    return null;
                }

                let detailMessage = '';
                try {
                    const payload = await response.json();
                    detailMessage = payload.detail || payload.message || '';
                } catch (_) {
                    // игнорируем ошибки парсинга
                }
                throw new Error(detailMessage || `Ошибка загрузки плана этажа (${response.status})`);
            }

            const contentType = response.headers.get('content-type') || '';
            if (contentType.startsWith('image/')) {
                await response.blob(); // дренируем поток
                return {
                    objectUrl: null,
                    sourceUrl: url,
                    imageUrl: url
                };
            }

            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);

            return {
                objectUrl,
                sourceUrl: url,
                imageUrl: objectUrl
            };
        }

        async function fetchPlanImage(jkName, blockName, apartmentSize) {
            const tryOnce = async (sizeStr) => {
                const url = `/api/complexes/plan-image?jkName=${encodeURIComponent(jkName)}&blockName=${encodeURIComponent(blockName)}&apartmentSize=${encodeURIComponent(sizeStr)}`;
                const resp = await fetch(url, { method: 'GET' });
                if (resp.ok) return url; // вернём прямую ссылку API, без blob:
                // пропускаем 404 и пробуем другие варианты, остальные ошибки бросаем
                try {
                    const err = await resp.json();
                    if (resp.status !== 404) throw new Error(err.detail || err.message || resp.statusText);
                } catch (_) {}
                return null;
            };

            const raw = String(apartmentSize || '').trim();
            const sDot = raw.replace(',', '.');
            const variants = new Set([raw, sDot, sDot.replace('.', ',')]);
            const val = parseFloat(sDot);
            if (!Number.isNaN(val)) {
                variants.add(val.toFixed(1));
                variants.add(String(Math.round(val)));
                variants.add(val.toFixed(1).replace('.', ','));
            }

            for (const v of variants) {
                const okUrl = await tryOnce(v);
                if (okUrl) return okUrl;
            }
            throw new Error('Планировка не найдена');
        }

        // Функция для очистки контейнера
        function clearContainer(containerId) {
            const container = document.getElementById(containerId);
            if (container) container.innerHTML = '';
        }

        // Функция для обновления поля выбора оплаты (30, 50, 70 или 100% оплаты)
        function updatePaymentChoice(paymentPercentage) {
            selectedPaymentOption = paymentPercentage; // Устанавливаем текущий выбор
            const paymentChoiceInput = document.querySelector('input[name="paymentChoice"]');
            if (paymentChoiceInput) {
                if (typeof paymentPercentage === 'number') {
                    paymentChoiceInput.value = `${paymentPercentage}%`;
                } else if (paymentPercentage === 'hybrid') {
                    paymentChoiceInput.value = 'Гибридная';
                } else {
                    paymentChoiceInput.value = String(paymentPercentage ?? '');
                }
            }
        }

        // Функция для обработки клика по карточке квартиры
        document.body.addEventListener('click', async function (event) {
            // Ищем ближайший элемент карточки квартиры (новый список .apt-item или старая .apartment-card)
            const card = event.target.closest('.apt-item, .apartment-card, .chess-card, .chess-plus-cell');

            // --- No need to add button manually here ---
            if (card) {
                // Получаем данные из атрибутов карточки
                const jkName = card.getAttribute("data-jk-name");
                const blockName = card.getAttribute("data-block");
                const apartmentSize = card.getAttribute("data-size");
                const floor = card.getAttribute("data-floor");
                const apartmentNumber = card.getAttribute("data-number");
                const rooms = card.getAttribute("data-rooms"); // Получаем кол-во комнат
                const unitType = card.getAttribute("data-unitType")

                updateBackButton("Назад к выбору блоков", () => {
                    if (!globalShaxmatkaData || !globalRenderImage || !jkName) {
                        const complexesContainer = document.getElementById("complexes-container");
                        const jkDetailsContainer = document.getElementById("jk-details-container");
                        if (jkDetailsContainer) jkDetailsContainer.style.display = "none";
                        if (complexesContainer) complexesContainer.style.display = "flex";
                        resetBackButtonToDefault();
                        return;
                    }

                    if (currentViewMode === ViewModes.FACADES) {
                        showJKDetails(globalShaxmatkaData, globalRenderImage, jkName);
                    } else if (currentViewMode === ViewModes.CHESS_PLUS) {
                        renderChessDetails(globalShaxmatkaData, jkName, null, ViewModes.CHESS_PLUS);
                    } else {
                        renderChessDetails(globalShaxmatkaData, jkName, blockName, ViewModes.CHESS);
                    }
                });

                // --- Глобальные переменные для хранения выбора пользователя ---
                // (Лучше определить их вне обработчика, если они нужны глобально,
                // но для примера оставим здесь с возможностью обновления)
                let userSelection = {
                    totalPrice: 0,
                    pricePerM2: 0,
                    paymentChoice: null,
                    monthlyPayment: null,
                    finalPayment: null,
                    hybridInitial: null
                };
                let initialPayment = 0; // Хранит сумму первого взноса
                let selectedPaymentOption = null; // Хранит выбранный процент (число)
                // --- Конец глобальных переменных ---

                function updatePaymentChoice(percentage) {
                    selectedPaymentOption = percentage;
                    userSelection.paymentChoice = percentage;
                }

                function updateInitialPayment(amount) {
                    initialPayment = amount;
                    // Обновляем поле в модальном окне, если оно открыто
                    const initialPaymentInputModal = document.querySelector(".custom-modal #initialPayment");
                    if (initialPaymentInputModal) {
                        initialPaymentInputModal.value = Number(amount).toLocaleString('ru-RU');
                    }
                }

                // --- Вспомогательные функции для запросов (предполагаем, что они существуют) ---


                async function fetchData(url, errorMessage) {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`${errorMessage}: ${response.statusText}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(error);
                        alert(error.message);
                        throw error; // Пробрасываем ошибку дальше
                    }
                }

                function clearContainer(containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                        container.style.display = 'none'; // Скрываем контейнер при очистке
                    }
                }
                // --- Конец вспомогательных функций ---


                if (!jkName || !blockName || !apartmentSize || !floor || !apartmentNumber || !rooms) {
                    console.error("Отсутствуют данные для запроса:", { jkName, blockName, apartmentSize, floor, apartmentNumber, rooms });
                    alert("Не хватает данных для выполнения запроса. Проверьте data-атрибуты карточки.");
                    return;
                }

                try {
                    // 1. Получаем изображение планировки
                    const planImagePath = await fetchPlanImage(jkName, blockName, apartmentSize);
                    console.log(`Путь к изображению: ${planImagePath}`);

                    // 2. Получаем данные о квартире
                    const apiUrl = `/api/complexes/apartment-info?jkName=${encodeURIComponent(jkName)}&blockName=${encodeURIComponent(blockName)}&apartmentSize=${encodeURIComponent(apartmentSize)}&floor=${encodeURIComponent(floor)}&apartmentNumber=${encodeURIComponent(apartmentNumber)}`;
                    const apartmentInfo = await fetchData(apiUrl, "Ошибка получения информации о квартире");
                    if (apartmentInfo.status !== "success") {
                        alert(apartmentInfo.message || "Ошибка при получении информации о квартире.");
                        return;
                    }

                        const {
                            pricePerM2_100 = 0, // Предоставляем значения по умолчанию
                            pricePerM2_70 = 0,
                            pricePerM2_50 = 0,
                            pricePerM2_30 = 0,
                            total_price = 0, // Используем это как базовую цену "от"
                            status = "неизвестно",
                            months_left = 23
                        } = apartmentInfo.data;


                        // --- Константы для текстов (лучше вынести наружу, если много) ---
                        const AREA_LABEL = "Площадь";
                        const ENTRANCE_LABEL = "Блоки"; // Или Блок? Уточнить по данным
                        const DEADLINE_LABEL = "Срок сдачи";

                        // 3. Очищаем контейнер перед отображением данных
                        const jkDetailsContainer = document.getElementById('jk-details-container');
                        clearContainer('jk-details-container'); // Очищаем и скрываем

                        // --- СОЗДАНИЕ НОВОЙ HTML СТРУКТУРЫ ---

                        // --- Левая колонка: План ---
                        const apartmentPlanSection = document.createElement('div');
                        apartmentPlanSection.className = 'apartment-plan-section';

                        const normalizedSize = Number(apartmentSize.replace(',', '.')) || 0;
                        const planTitle = document.createElement('div');
                        planTitle.className = 'plan-section-title';
                        const roomsLabel = rooms ? `${rooms}-комнатные апартаменты` : 'Квартира';
                        planTitle.innerHTML = `
                            <div class="plan-title-main">
                                <span class="plan-area-highlight">
                                    <span class="plan-area-value">${normalizedSize.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                    <span class="plan-area-unit">м²</span>
                                </span>
                                <span class="plan-room-label">${roomsLabel}</span>
                            </div>
                            <div class="plan-title-meta">Блок ${blockName} · Этаж ${floor}</div>
                        `;
                        apartmentPlanSection.appendChild(planTitle);

                        const planImageWrapper = document.createElement('div');
                        planImageWrapper.className = 'plan-image-wrapper';
                        const planImage = document.createElement('img');
                        planImage.className = 'plan-image';
                        planImage.src = planImagePath;
                        planImage.alt = `План ${rooms}-комнатной квартиры, ${apartmentSize} м²`;
                        planImageWrapper.appendChild(planImage);
                        apartmentPlanSection.appendChild(planImageWrapper);

                        // Добавляем статичные кнопки управления под планом (как в примере HTML)
                        const planControls = document.createElement('div');
                        planControls.className = 'plan-controls';
                        planControls.innerHTML = `
                     <button class="plan-nav-btn" aria-label="Предыдущий план">
                         <i class="fa-solid fa-arrow-left"></i>
                     </button>
                     <button class="plan-nav-btn" aria-label="Следующий план">
                         <i class="fa-solid fa-arrow-right"></i>
                     </button>
                     <div class="plan-actions">
                         <button class="plan-action-btn" aria-label="Печать плана">
                             <i class="fa-solid fa-print"></i>
                         </button>
                         <button class="plan-action-btn" aria-label="Скачать план">
                              <i class="fa-solid fa-download"></i> <!-- Заменил share на download -->
                         </button>
                         <button class="plan-action-btn" aria-label="Добавить в избранное">
                             <i class="fa-regular fa-thumbs-up"></i>
                         </button>
                     </div>`;
                        apartmentPlanSection.appendChild(planControls);


                        // --- Правая колонка: Инфо-карточка ---
                        const infoCardDiv = document.createElement('div');
                        infoCardDiv.className = 'info-card';

                        // Шапка карточки
                        const infoCardHeader = document.createElement('div');
                        infoCardHeader.className = 'info-card-header';

                        const infoCardTitle = document.createElement('h3');
                        infoCardTitle.className = 'info-card-title';
                        infoCardTitle.textContent = rooms ? `${rooms}-комнатная квартира` : 'Квартира';
                        infoCardHeader.appendChild(infoCardTitle);

                        const statusBadge = document.createElement('span');
                        statusBadge.className = 'status-badge';
                        statusBadge.textContent = status;
                        // Добавляем класс в зависимости от статуса
                        const statusLower = status.toLowerCase().trim();
                        if (statusLower === 'свободна') {
                            statusBadge.classList.add('status-available');
                        } else if (statusLower === 'продана') {
                            statusBadge.classList.add('status-sold'); // Добавьте стиль для .status-sold в CSS
                        } else if (statusLower === 'бронь') {
                            statusBadge.classList.add('status-reserved'); // Добавьте стиль для .status-reserved в CSS
                        }
                        infoCardHeader.appendChild(statusBadge);


                        infoCardDiv.appendChild(infoCardHeader);

                        // Сетка информации
                        const infoGrid = document.createElement('div');
                        infoGrid.className = 'info-grid';

                        // -- Блок Площадь --
                        const areaBlock = document.createElement('div');
                        areaBlock.className = 'info-block';
                        areaBlock.innerHTML = `
                    <span class="info-label">${AREA_LABEL}</span>
                    <span class="info-value area">${apartmentSize} м²</span>`; // Используем кв² или м²? На картинке кв²
                        infoGrid.appendChild(areaBlock);

                        // -- Блок Подъезд/Блок -- (Используем blockName)
                        const entranceBlock = document.createElement('div');
                        entranceBlock.className = 'info-block';
                        entranceBlock.innerHTML = `
                    <span class="info-label">${ENTRANCE_LABEL}</span>
                    <span class="info-value">${blockName}</span>`; // Используем blockName, как наиболее релевантное
                        infoGrid.appendChild(entranceBlock);

                        // -- Блок Срок Сдачи -- (Заглушка, т.к. данных нет в API)
                        const deadlineBlock = document.createElement('div');
                        deadlineBlock.className = 'info-block';
                        deadlineBlock.innerHTML = `
                    <span class="info-label">${DEADLINE_LABEL}</span>
                    <span class="info-value">Уточняется</span>`; // Placeholder
                        infoGrid.appendChild(deadlineBlock);

                        // -- Блок Подробнее -- (Ссылка-заглушка)
                        // const detailsLinkBlock = document.createElement('a');
                        // detailsLinkBlock.href = '#'; // Заглушка
                        // detailsLinkBlock.className = 'info-block details-link-block';
                        //  detailsLinkBlock.innerHTML = `
                        //      <span class="info-label">${DETAILS_LABEL}</span>
                        //      <i class="fa-solid fa-arrow-right"></i>`;
                        //  detailsLinkBlock.addEventListener('click', (e) => e.preventDefault()); // Предотвращаем переход по ссылке
                        //  infoGrid.appendChild(detailsLinkBlock);

                        infoCardDiv.appendChild(infoGrid);

                        const discountStack = document.createElement('div');
                        discountStack.className = 'discount-stack';
                        discountStack.innerHTML = `
                            <div class="discount-badge discount-blue">
                                При 100% оплате действует скидка до <strong>11%</strong>
                            </div>
                            <div class="discount-badge discount-green">
                                При рассрочке на ${months_left > 0 ? months_left : 21} месяцев скидка до <strong>8%</strong>
                            </div>
                            <div class="discount-badge discount-sand">
                                При гибридной рассрочке до <strong>30%</strong> суммы можно отложить на удобный момент
                            </div>
                        `;
                        infoCardDiv.appendChild(discountStack);


                        // Секция цены
                        const priceSection = document.createElement('div');
                        priceSection.className = 'price-section';

                        const totalPriceP = document.createElement('p');
                        totalPriceP.className = 'total-price';
                        // Отображаем базовую цену "от" (pricePerM2_30 * apartmentSquare)
                        const squareMeters = parseFloat(String(apartmentSize).replace(',', '.')) || 0;
                        const basePrice = pricePerM2_30 * squareMeters;
                        totalPriceP.textContent = `${Number(basePrice).toLocaleString('ru-RU')} сум`;
                        priceSection.appendChild(totalPriceP);

                        const pricePerMeterP = document.createElement('p');
                        pricePerMeterP.className = 'price-per-meter';
                        // Отображаем цену за м² "от" (pricePerM2_30)
                        pricePerMeterP.innerHTML = `
                    <span class="currency-icon"><i class="fa-solid fa-dollar-sign"></i></span>
                    ${Number(pricePerM2_30).toLocaleString('ru-RU')} сум за м²`;
                        priceSection.appendChild(pricePerMeterP);
                        infoCardDiv.appendChild(priceSection);

                        // --- ДИНАМИЧЕСКИЕ КНОПКИ И ЛОГИКА ---
                        // Контейнер для кнопок выбора оплаты и результатов расчета
                        const paymentActionsContainer = document.createElement('div');
                        paymentActionsContainer.className = 'payment-actions-container';
                        infoCardDiv.appendChild(paymentActionsContainer); // Добавляем в карточку

                        const buttonsContainer = document.createElement("div");
                        buttonsContainer.className = "payment-tabs";

                        const resultContainer = document.createElement("div");
                        resultContainer.className = "payment-summary";
                        const summaryContent = document.createElement('div');
                        summaryContent.className = 'summary-content';
                        resultContainer.appendChild(summaryContent);

                        const paymentButtons = [];
                        const setActivePaymentButton = (button) => {
                            paymentButtons.forEach(btn => btn.classList.remove('active'));
                            if (button) {
                                button.classList.add('active');
                            }
                        };

                        let subOptionsContainer = null;
                        const clearSubOptions = () => {
                            if (subOptionsContainer) {
                                subOptionsContainer.remove();
                                subOptionsContainer = null;
                            }
                        };

                        const appendPaymentButton = (label, onSelect) => {
                            const button = document.createElement('button');
                            button.className = 'payment-option-btn';
                            button.textContent = label;
                            button.addEventListener('click', () => {
                                onSelect();
                                setActivePaymentButton(button);
                            });
                            paymentButtons.push(button);
                            buttonsContainer.appendChild(button);
                            return button;
                        };

                        const apartmentSquare = parseFloat(String(apartmentSize).replace(',', '.')) || 0;

                        if (statusLower === "свободна") {
                            const renderFullPayment = () => {
                                clearSubOptions();
                                updatePaymentChoice(100);
                                const fullPrice = pricePerM2_30 * apartmentSquare;
                                const economy = fullPrice - total_price;
                                userSelection.totalPrice = fullPrice;
                                userSelection.pricePerM2 = pricePerM2_100;
                                updateInitialPayment(fullPrice);
                                userSelection.monthlyPayment = null;
                                userSelection.finalPayment = null;
                                userSelection.hybridInitial = null;
                                summaryContent.innerHTML = `
                                    <div class="summary-title">100% оплата</div>
                                    <div class="summary-row">
                                        <span class="summary-label">Стоимость квартиры</span>
                                        <span class="summary-value">${total_price.toLocaleString('ru-RU')} сум</span>
                                    </div>
                                    ${economy > 0 ? `<div class=\"summary-row muted\"><span class=\"summary-label\">Экономия</span><span class=\"summary-value\">${economy.toLocaleString('ru-RU')} сум</span></div>` : ''}
                                `;
                            };

                            const renderInstallmentOption = (percentage) => {
                                updatePaymentChoice(percentage);
                                let pricePerM2 = pricePerM2_30;
                                if (percentage === 70) pricePerM2 = pricePerM2_70;
                                if (percentage === 50) pricePerM2 = pricePerM2_50;
                                const totalPriceInstallment = pricePerM2 * apartmentSquare;
                                const initialPaymentValue = totalPriceInstallment * (percentage / 100);
                                const months = months_left > 0 ? months_left : 1;
                                const remaining = totalPriceInstallment - initialPaymentValue;
                                const monthlyPayment = remaining / months;
                                const economy = basePrice - totalPriceInstallment;
                                console.log(total_price);
                                userSelection.totalPrice = totalPriceInstallment;
                                userSelection.pricePerM2 = pricePerM2;
                                updateInitialPayment(initialPaymentValue);
                                userSelection.monthlyPayment = Math.round(monthlyPayment);
                                userSelection.finalPayment = null;
                                userSelection.hybridInitial = null;
                                summaryContent.innerHTML = `
                                    <div class="summary-title">Рассрочка ${percentage}%</div>
                                    <div class="summary-row">
                                        <span class="summary-label">Стоимость квартиры</span>
                                        <span class="summary-value">${totalPriceInstallment.toLocaleString('ru-RU')} сум</span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Первоначальный взнос (${percentage}%)</span>
                                        <span class="summary-value">${initialPaymentValue.toLocaleString('ru-RU')} сум</span>
                                    </div>
                                    ${months_left > 0 ? `<div class=\"summary-row\"><span class=\"summary-label\">Ежемесячный платеж (${months} мес.)</span><span class=\"summary-value\">${Math.round(monthlyPayment).toLocaleString('ru-RU')} сум</span></div>` : '<div class="summary-row"><span class="summary-label">Срок рассрочки</span><span class="summary-value">не указан</span></div>'}
                                    ${economy > 0 ? `<div class=\"summary-row muted\"><span class=\"summary-label\">Экономия</span><span class=\"summary-value\">${economy.toLocaleString('ru-RU')} сум</span></div>` : ''}
                                `;
                            };

                            const renderHybridOption = (initialPct) => {
                                updatePaymentChoice('hybrid');
                                userSelection.hybridInitial = initialPct;
                                const pricePerM2 = pricePerM2_30;
                                const totalPrice = pricePerM2 * apartmentSquare;
                                const initialPayment = totalPrice * (initialPct / 100);
                                const finalPayment = totalPrice * 0.30;
                                const months = months_left > 0 ? months_left : 1;
                                const middleMonths = months > 1 ? (months - 1) : 1;
                                const middleTotal = totalPrice - initialPayment - finalPayment;
                                const monthlyPayment = middleTotal / middleMonths;
                                userSelection.totalPrice = totalPrice;
                                userSelection.pricePerM2 = pricePerM2;
                                updateInitialPayment(initialPayment);
                                userSelection.monthlyPayment = Math.round(monthlyPayment);
                                userSelection.finalPayment = Math.round(finalPayment);
                                summaryContent.innerHTML = `
                                    <div class="summary-title">Гибридная рассрочка ${initialPct}%</div>
                                    <div class="summary-row">
                                        <span class="summary-label">Стоимость квартиры</span>
                                        <span class="summary-value">${Math.round(totalPrice).toLocaleString('ru-RU')} сум</span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Первоначальный взнос (${initialPct}%)</span>
                                        <span class="summary-value">${Math.round(initialPayment).toLocaleString('ru-RU')} сум</span>
                                    </div>
                                    ${months_left > 0 ? `<div class=\"summary-row\"><span class=\"summary-label\">Ежемесячный платеж (первые ${middleMonths} мес.)</span><span class=\"summary-value\">${Math.round(monthlyPayment).toLocaleString('ru-RU')} сум</span></div>` : '<div class="summary-row"><span class="summary-label">Срок рассрочки</span><span class="summary-value">не указан</span></div>'}
                                    <div class="summary-row">
                                        <span class="summary-label">Финальный платеж (30%)</span>
                                        <span class="summary-value">${Math.round(finalPayment).toLocaleString('ru-RU')} сум</span>
                                    </div>
                                `;
                            };

                            appendPaymentButton('100% оплата', renderFullPayment);

                            appendPaymentButton('Рассрочка', () => {
                                clearSubOptions();
                                const options = document.createElement('div');
                                options.className = 'installment-options';
                                const subButtons = [];
                                const setActiveSub = (btn) => {
                                    subButtons.forEach(b => b.classList.remove('active'));
                                    btn.classList.add('active');
                                };

                                [70, 50, 30].forEach((percentage) => {
                                    const optionBtn = document.createElement('button');
                                    optionBtn.className = 'installment-percent-btn';
                                    optionBtn.textContent = `${percentage}%`;
                                    optionBtn.addEventListener('click', () => {
                                        renderInstallmentOption(percentage);
                                        setActiveSub(optionBtn);
                                    });
                                    subButtons.push(optionBtn);
                                    options.appendChild(optionBtn);
                                });

                                resultContainer.insertBefore(options, summaryContent);
                                subOptionsContainer = options;
                                if (subButtons.length) {
                                    subButtons[0].click();
                                }
                            });

                            const allowedHybrid = ["ЖК_Рассвет", "ЖК_Бахор"];
                            if (allowedHybrid.includes(jkName)) {
                                appendPaymentButton('Гибридная рассрочка', () => {
                                    clearSubOptions();
                                    const options = document.createElement('div');
                                    options.className = 'hybrid-options';
                                    const subButtons = [];
                                    const setActiveSub = (btn) => {
                                        subButtons.forEach(b => b.classList.remove('active'));
                                        btn.classList.add('active');
                                    };

                                    [30, 20].forEach((initialPct) => {
                                        const optionBtn = document.createElement('button');
                                        optionBtn.className = 'hybrid-percent-btn';
                                        optionBtn.textContent = `${initialPct}%`;
                                        optionBtn.addEventListener('click', () => {
                                            renderHybridOption(initialPct);
                                            setActiveSub(optionBtn);
                                        });
                                        subButtons.push(optionBtn);
                                        options.appendChild(optionBtn);
                                    });

                                    resultContainer.insertBefore(options, summaryContent);
                                    subOptionsContainer = options;
                                    if (subButtons.length) {
                                        subButtons[0].click();
                                    }
                                });
                            }

                            if (paymentButtons.length) {
                                paymentButtons[0].click();
                            }

                            paymentActionsContainer.appendChild(buttonsContainer); // Добавляем контейнер с кнопками выбора
                            paymentActionsContainer.appendChild(resultContainer); // Добавляем контейнер для результатов

                        // --- Кнопки Бронирования и Договора ---
                        const actionButtonsContainer = document.createElement('div');
                        actionButtonsContainer.className = 'action-buttons-container';

                        // Кнопка подачи заявки и форма
                        const requestButton = document.createElement("button");
                        requestButton.type = 'button';
                        requestButton.textContent = "Оставить заявку";
                        requestButton.className = "action-btn primary";

                        const reserveFormContainer = document.createElement("div");
                        reserveFormContainer.className = "reserve-form-container";
                        reserveFormContainer.style.display = "none";
                        reserveFormContainer.innerHTML = `
                        <form class="reserve-form">
                            <label for="reserve_name"><strong>Имя</strong></label>
                            <input type="text" id="reserve_name" name="name" placeholder="Введите ваше имя" required>
                            <label for="reserve_phone"><strong>Телефон</strong></label>
                            <input type="tel" id="reserve_phone" name="phone" placeholder="+998 XX XXX XX XX" required>
                            <div class="form-buttons">
                                <button type="button" class="action-btn secondary cancel-form-btn">Отмена</button>
                                <button type="submit" class="action-btn primary">Отправить заявку</button>
                            </div>
                        </form>
                    `;

                            requestButton.addEventListener("click", () => {
                                reserveFormContainer.style.display = "block";
                                requestButton.style.display = "none"; // Скрываем кнопку "Оставить заявку"
                            });

                            // Обработчик кнопки "Отмена"
                            const cancelButton = reserveFormContainer.querySelector('.cancel-form-btn');
                            cancelButton.addEventListener("click", () => {
                                reserveFormContainer.style.display = "none";
                                requestButton.style.display = "block"; // Показываем кнопку "Оставить заявку" обратно
                                // Очищаем форму
                                reserveFormContainer.querySelector("#reserve_name").value = "";
                                reserveFormContainer.querySelector("#reserve_phone").value = "";
                            });

                            const reserveForm = reserveFormContainer.querySelector('.reserve-form');
                            reserveForm.addEventListener("submit", async (event) => {
                                event.preventDefault();
                                const name = reserveFormContainer.querySelector("#reserve_name").value;
                                const phone = reserveFormContainer.querySelector("#reserve_phone").value;

                                if (!name || !phone) {
                                    alert("Имя и телефон обязательны для бронирования!");
                                    return;
                                }

                                // --- Проверка выбора способа оплаты (без изменений) ---
                                if (!userSelection.paymentChoice) {
                                    alert("Пожалуйста, выберите способ оплаты (100%, Рассрочка или Гибридная) перед бронированием.");
                                    return;
                                }
                                // --- Подготовка данных для LeadCreate (без изменений в этой части) ---
                                let paymentTypeString = '';
                                let monthlyPaymentValue = null;
                                let installmentPeriodValue = null;

                                if (userSelection.paymentChoice === 100) {
                                    paymentTypeString = 'Единовременно';
                                    monthlyPaymentValue = null;
                                    installmentPeriodValue = null;
                                } else if (typeof userSelection.paymentChoice === 'number') {
                                    paymentTypeString = `Рассрочка`;
                                    installmentPeriodValue = months_left > 0 ? months_left : null;
                                    const remaining = userSelection.totalPrice - initialPayment;
                                    monthlyPaymentValue = installmentPeriodValue ? Math.round(remaining / installmentPeriodValue) : null;
                                } else if (userSelection.paymentChoice === 'hybrid') {
                                    paymentTypeString = 'Гибридная рассрочка';
                                    installmentPeriodValue = months_left > 0 ? months_left : null;
                                    monthlyPaymentValue = userSelection.monthlyPayment || null;
                                }

                                const leadData = {
                                    full_name: name,
                                    phone: phone,
                                    region: "Ташкент", // Или другое значение по умолчанию
                                    contact_source: "Website Form",
                                    // === ИЗМЕНЕНО ===
                                    status: "COLD", // Соответствует LeadStatus Enum
                                    state: "NEW",   // Соответствует LeadState Enum
                                    // ================
                                    square_meters: parseFloat(apartmentSize.replace(',', '.')),
                                    rooms: parseInt(rooms, 10),
                                    floor: parseInt(floor, 10),
                                    total_price: userSelection.totalPrice,
                                    payment_type: paymentTypeString,
                                    monthly_payment: monthlyPaymentValue,
                                    installment_period: installmentPeriodValue,
                                    notes: `Бронь с сайта. ЖК: ${jkName}, Блок: ${blockName}, Этаж: ${floor}, №${apartmentNumber}, ${apartmentSize} м²`,
                                    currency: "UZS"
                                };


                                updateBackButton("Назад к выбору блоков", () => {
                                    if (!globalShaxmatkaData || !globalRenderImage || !currentJKName) {
                                        const complexesContainer = document.getElementById("complexes-container");
                                        const jkDetailsContainer = document.getElementById("jk-details-container");
                                        if (jkDetailsContainer) jkDetailsContainer.style.display = "none";
                                        if (complexesContainer) complexesContainer.style.display = "flex";
                                        resetBackButtonToDefault();
                                        return;
                                    }

                                    if (currentViewMode === ViewModes.FACADES) {
                                        showJKDetails(globalShaxmatkaData, globalRenderImage, currentJKName);
                                    } else if (currentViewMode === ViewModes.CHESS_PLUS) {
                                        renderChessDetails(globalShaxmatkaData, currentJKName, null, ViewModes.CHESS_PLUS);
                                    } else {
                                        const blockToRestore = currentBlockName || blockName;
                                        renderChessDetails(globalShaxmatkaData, currentJKName, blockToRestore, ViewModes.CHESS);
                                    }
                                });

                                console.log("Отправка данных лида (без user_id):", leadData);

                                // --- Отправка запроса на создание лида (без изменений в этой части) ---
                                try {
                                    const response = await fetch("/api/leads/", { // Убедитесь, что путь /api/leads/ правильный
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify(leadData)
                                    });

                                    if (response.ok) {
                                        alert("Бронь успешно зарегистрирована! Обновляем статус квартиры...");
                                        reserveFormContainer.style.display = "none";

                                        // Вызов эндпоинта для обновления Excel (без изменений)
                                        await updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, "бронь");

                                        // Обновление UI (без изменений)
                                        if (card) {
                                            const statusElement = card.querySelector('.apartment-status, .apt-status');
                                            if (statusElement) {
                                                statusElement.textContent = 'бронь';
                                                // Сохраняем исходный класс + добавляем модификатор
                                                if (statusElement.classList.contains('apartment-status')) {
                                                    statusElement.className = 'apartment-status reserved';
                                                } else {
                                                    statusElement.className = 'apt-status booked';
                                                }
                                            }
                                            card.classList.add('reserved');
                                        }
                                        const statusBadgeDetailed = infoCardDiv.querySelector('.status-badge');
                                        if (statusBadgeDetailed) {
                                            statusBadgeDetailed.textContent = 'бронь';
                                            statusBadgeDetailed.className = 'status-badge status-reserved';
                                        }
                                        if (paymentActionsContainer) paymentActionsContainer.style.display = 'none';
                                        if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';

                                            setTimeout(() => window.location.reload(), 300);

                                    } else {
                                        // Обработка ошибок от API создания лида (без изменений)
                                        let errorMsg = `Ошибка регистрации лида: ${response.statusText}`;
                                        try {
                                            const errorResult = await response.json();
                                            if (errorResult.detail) {
                                                if (Array.isArray(errorResult.detail)) {
                                                    errorMsg += "\nДетали:\n";
                                                    errorResult.detail.forEach(err => {
                                                        errorMsg += `- Поле '${err.loc.join('.')}' : ${err.msg}\n`;
                                                    });
                                                } else {
                                                    errorMsg = `Ошибка регистрации лида: ${errorResult.detail}`;
                                                }
                                            }
                                        } catch (e) { /* Не удалось распарсить JSON ошибки */ }
                                        alert(errorMsg);
                                        console.error("Ошибка от /api/leads/:", errorMsg);
                                    }
                                } catch (error) {
                                    console.error("Сетевая ошибка при бронировании:", error);
                                    alert("Произошла ошибка сети при бронировании. Пожалуйста, проверьте соединение и попробуйте еще раз.");
                                }
                            });

                            async function updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, newStatus) {
                                try {
                                    const response = await fetch("/excel/update-status", { // Новый эндпоинт
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({
                                            jkName: jkName,
                                            blockName: blockName,
                                            floor: parseInt(floor, 10),
                                            // apartmentNumber может быть строкой или числом, бэкенд должен это учесть
                                            apartmentNumber: isNaN(parseInt(apartmentNumber)) ? apartmentNumber : parseInt(apartmentNumber, 10),
                                            newStatus: newStatus
                                        })
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        console.log("Результат обновления Excel:", result.message);
                                        if (result.status === 'warning') {
                                            console.warn("Предупреждение при обновлении Excel:", result.message);
                                            // Можно показать некритичное уведомление админу/менеджеру
                                        }
                                    } else {
                                        console.error(`Ошибка при обновлении статуса в Excel (${response.status}): ${response.statusText}`);
                                        // Не блокируем пользователя, т.к. лид создан, но логируем ошибку
                                        // Можно отправить лог ошибки на бэкенд
                                    }
                                } catch (error) {
                                    console.error("Сетевая ошибка при обновлении статуса в Excel:", error);
                                    // Логируем ошибку
                                }
                            }

                            actionButtonsContainer.appendChild(requestButton);
                            actionButtonsContainer.appendChild(reserveFormContainer); // Форма добавляется сразу после кнопки

                            infoCardDiv.appendChild(actionButtonsContainer); // Добавляем контейнер с кнопкой действий


                            // --- Функция открытия модального окна (без изменений) ---
                            function openContractModal(prefilledData) {
                                // Закрываем существующее модальное окно, если оно есть
                                const existingModal = document.querySelector(".custom-modal");
                                if (existingModal) existingModal.remove();

                                const modal = document.createElement("div");
                                modal.className = "custom-modal";
                                // Добавляем стили для модального окна (можно вынести в CSS)
                                modal.style.position = 'fixed';
                                modal.style.left = '0';
                                modal.style.top = '0';
                                modal.style.width = '100%';
                                modal.style.height = '100%';
                                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                                modal.style.display = 'flex';
                                modal.style.justifyContent = 'center';
                                modal.style.alignItems = 'center';
                                modal.style.zIndex = '1000';

                                const modalContent = document.createElement('div');
                                modalContent.className = 'custom-modal-content';
                                modalContent.style.backgroundColor = '#fff';
                                modalContent.style.padding = '20px';
                                modalContent.style.borderRadius = '8px';
                                modalContent.style.maxHeight = '90vh';
                                modalContent.style.overflowY = 'auto';
                                modalContent.style.width = '90%';
                                modalContent.style.maxWidth = '600px';

                                // Форматируем paymentChoice для отображения
                                let displayPaymentChoice = '';
                                if (typeof prefilledData.paymentChoice === 'number') {
                                    displayPaymentChoice = `${prefilledData.paymentChoice}%`;
                                } else if (prefilledData.paymentChoice === 'hybrid') {
                                    displayPaymentChoice = 'Гибридная';
                                }
                                console.log(rooms);
                                modalContent.innerHTML = `
                            <h3 style="margin-top: 0;">Оформление договора</h3>
                            <form id="contract-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="hidden" name="jkName" value="${prefilledData.jkName}">

                                <div style="grid-column: 1 / -1;"><label>Номер договора:</label><input type="text" name="contractNumber" value="${prefilledData.contractNumber || '1'}" required></div>
                                <div style="grid-column: 1 / -1;"><label>Дата договора:</label><input type="date" name="contractDate" value="${new Date().toISOString().slice(0, 10)}" required></div>

                                <div><label>Блок:</label><input type="text" name="block" value="${prefilledData.block}" readonly></div>
                                <div><label>Этаж:</label><input type="number" name="floor" value="${prefilledData.floor}" readonly></div>
                                <div><label>№ квартиры:</label><input type="number" name="apartmentNumber" value="${prefilledData.apartmentNumber}" readonly></div>
                                <div><label>Комнат:</label><input type="number" name="rooms" value="${rooms}" readonly></div>
                                <div><label>Площадь (м²):</label><input type="number" name="size" value="${prefilledData.size}" readonly></div>
                                <div><label>Выбор оплаты:</label><input type="text" name="paymentChoice" value="${displayPaymentChoice}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Общая стоимость:</label><input type="text" name="totalPrice" value="${Number(prefilledData.totalPrice).toLocaleString('ru-RU')}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Стоимость 1 м²:</label><input type="text" name="pricePerM2" value="${Number(prefilledData.pricePerM2).toLocaleString('ru-RU')}" readonly></div>
                                <div style="grid-column: 1 / -1;"><label>Сумма перв. взноса:</label><input type="text" name="initialPayment" id="initialPayment" value="${Number(prefilledData.initialPayment).toLocaleString('ru-RU')}" readonly></div>

                                <hr style="grid-column: 1 / -1; border: none; border-top: 1px solid #eee; margin: 10px 0;">

                                <div style="grid-column: 1 / -1;"><label>Ф.И.О.:</label><input type="text" name="fullName" required></div>
                                <div><label>Серия паспорта:</label><input type="text" name="passportSeries" required></div>
                                <div><label>ПИНФЛ:</label><input type="text" name="pinfl" required></div>
                                <div style="grid-column: 1 / -1;"><label>Кем выдан:</label><input type="text" name="issuedBy" required></div>
                                <div style="grid-column: 1 / -1;"><label>Адрес прописки:</label><input type="text" name="registrationAddress" required></div>
                                <div><label>Номер телефона:</label><input type="tel" name="phone" required></div>
                                <div><label>Имя сотрудника:</label><input type="text"  name="salesDepartment" required></div>

                                <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; margin-top: 15px;">
                                     <button type="submit" class="action-btn">Сохранить договор</button>
                                     <button type="button" class="close-modal action-btn secondary">Закрыть</button>   
                                </div>
                            </form>

                        `;


                                // Добавляем стили для инпутов и лейблов формы
                                modalContent.querySelectorAll('label').forEach(label => {
                                    label.style.display = 'block';
                                    label.style.marginBottom = '3px';
                                    label.style.fontSize = '0.9em';
                                    label.style.color = '#555';
                                });
                                modalContent.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="tel"]').forEach(input => {
                                    input.style.width = '100%';
                                    input.style.padding = '8px';
                                    input.style.border = '1px solid #ccc';
                                    input.style.borderRadius = '4px';
                                    input.style.boxSizing = 'border-box';
                                    if (input.readOnly) {
                                        input.style.backgroundColor = '#e9ecef'; // Серый фон для readonly
                                        input.style.cursor = 'not-allowed';
                                    }
                                });
                                modalContent.querySelectorAll('.action-btn').forEach(button => {
                                    button.style.padding = '10px 15px';
                                    button.style.border = 'none';
                                    button.style.borderRadius = '5px';
                                    button.style.cursor = 'pointer';
                                    button.style.fontWeight = 'bold';
                                });
                                modalContent.querySelector('.action-btn[type="submit"]').style.backgroundColor = '#007bff'; // Синий
                                modalContent.querySelector('.action-btn[type="submit"]').style.color = '#fff';
                                modalContent.querySelector('.close-modal').style.backgroundColor = '#6c757d'; // Серый
                                modalContent.querySelector('.close-modal').style.color = '#fff';

                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);

                                // Закрытие модального окнам
                                modal.querySelector(".close-modal").addEventListener("click", () => {
                                    modal.remove();
                                });
                                // Закрытие по клику вне окна
                                modal.addEventListener('click', (event) => {
                                    if (event.target === modal) {
                                        modal.remove();
                                    }
                                });


                                const form = modalContent.querySelector("#contract-form");
                                form.addEventListener("submit", async (e) => {
                                    e.preventDefault();

                                    const formData = new FormData(form);
                                    const contractData = Object.fromEntries(formData.entries());
                                    contractData.unitType = unitType
                                    const enteredContractNumber = parseInt(contractData.contractNumber, 10);
                                    const lastContractNumber = parseInt(prefilledData.contractNumber, 10);
                                    if (enteredContractNumber < lastContractNumber) {
                                        alert(`Номер договора ${enteredContractNumber} уже занят. Используйте номер не меньше ${lastContractNumber}.`);
                                        return;
                                    }
                                   

                                    try {

                                        const response = await fetch("/excel/generate-contract", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json" },
                                            body: JSON.stringify(contractData),
                                        });

                                        if (!response.ok) {
                                            throw new Error("Ошибка при генерации договора");
                                        }

                                        const blob = await response.blob();
                                        const contentDisposition = response.headers.get("Content-Disposition");
                                        const filename = contentDisposition
                                            ? contentDisposition.split("filename=")[1].replace(/"/g, "")
                                            : "contract_and_registry.zip";

                                        // Скачивание файла
                                        const url = window.URL.createObjectURL(blob);
                                        const link = document.createElement("a");
                                        link.href = url;
                                        link.download = filename;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                        window.URL.revokeObjectURL(url);

                                        alert("Договор и реестр успешно сгенерированы и скачаны!");
                                          
                                        modal.remove();
                                        await updateApartmentStatusInExcel(jkName, blockName, floor, apartmentNumber, "продана");

                                        // Обновление UI (без изменений)
                                        if (card) {
                                            const statusElement = card.querySelector('.apartment-status, .apt-status');
                                            if (statusElement) {
                                                statusElement.textContent = 'продана';
                                                if (statusElement.classList.contains('apartment-status')) {
                                                    statusElement.className = 'apartment-status sold';
                                                } else {
                                                    statusElement.className = 'apt-status sold';
                                                }
                                            }
                                            card.classList.add('reserved');
                                        }
                                        const statusBadgeDetailed = infoCardDiv.querySelector('.status-badge');
                                        if (statusBadgeDetailed) {
                                            statusBadgeDetailed.textContent = 'продана';
                                            statusBadgeDetailed.className = 'status-badge status-sold';
                                        }
                                    } catch (error) {
                                        console.error("Ошибка:", error);
                                        alert("Произошла ошибка при генерации договора.");
                                    }
                                });
                            } // --- Конец openContractModal ---

                        }
                        if (statusLower !== 'свободна') {
                            // Если квартира не свободна (продана, бронь и т.д.)
                            paymentActionsContainer.style.display = 'none';
                            const statusMessage = document.createElement('div');
                            statusMessage.className = 'status-message';
                            if (statusLower === 'продана') {
                                statusMessage.textContent = 'Квартира продана.';
                                statusMessage.classList.add('is-sold');
                            } else if (statusLower === 'бронь') {
                                statusMessage.textContent = 'Квартира забронирована.';
                                statusMessage.classList.add('is-booked');
                            } else {
                                statusMessage.textContent = `Статус: ${status}`;
                            }
                            infoCardDiv.appendChild(statusMessage);
                        }


                        // --- ОБЩИЕ КНОПКИ НАЗАД И ПЕЧАТЬ ---
                        // Добавляем кнопку "Назад" (поверх всего)
                        // const backButton = document.createElement('button');
                        // backButton.textContent = BACK_BUTTON_TEXT;
                        // // Добавляем классы для позиционирования (адаптируйте CSS)
                        // backButton.className = 'back-button top-left action-btn secondary';
                        // backButton.style.position = 'absolute'; // Пример позиционирования
                        // backButton.style.top = '10px';
                        // backButton.style.left = '10px';
                        // backButton.style.zIndex = '5'; // Чтобы была над контентом

                        // backButton.addEventListener('click', () => {
                        //     clearContainer('jk-details-container');
                        //      // Вызываем функцию для отображения предыдущего вида (шахматки),
                        //      // предполагая, что у вас есть такая функция и нужные данные
                        //      if (typeof filterBlockData === 'function' && typeof globalShaxmatkaData !== 'undefined') {
                        //          filterBlockData(globalShaxmatkaData, blockName, globalRenderImage, jkName);
                        //      } else {
                        //          console.warn("Функция filterBlockData или globalShaxmatkaData не найдены для возврата к шахматке.");
                        //          // Можно просто скрыть контейнер, если нет логики возврата
                        //          jkDetailsContainer.style.display = 'none';
                        //      }
                        //     // Скрываем кнопку печати, которая была связана с этим видом
                        //     const printButton = document.querySelector(".print-button");
                        //     if (printButton) {
                        //         printButton.style.display = "none";
                        //     }
                        // });
                        //  jkDetailsContainer.insertBefore(backButton, jkDetailsContainer.firstChild); // Вставляем в начало контейнера

                        // Добавляем кнопку "Печать" (также поверх)
                        // Вставляем в начало

                        // --- Отображение созданной структуры ---
                        const detailLayout = document.createElement('div');
                        detailLayout.className = 'apartment-details-container';
                        detailLayout.appendChild(apartmentPlanSection);
                        detailLayout.appendChild(infoCardDiv);

                        jkDetailsContainer.innerHTML = '';
                        jkDetailsContainer.appendChild(detailLayout);
                        jkDetailsContainer.style.display = 'block';
                        jkDetailsContainer.style.position = 'relative';

                } catch (error) {
                    // Ошибки из fetchData уже обработаны, здесь ловим ошибки самой логики
                    console.error("Критическая ошибка обработки клика по карточке:", error);
                    alert("Не удалось загрузить или отобразить данные. Пожалуйста, попробуйте еще раз.");
                }
            } // конец if (card)
        }); // конец addEventListe

        // Оптимизация производительности при скролле
        let isScrolling = false;
        let scrollTimeout;
        
        window.addEventListener('scroll', function() {
            if (!isScrolling) {
                isScrolling = true;
                document.body.classList.add('scrolling');
            }
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function() {
                document.body.classList.remove('scrolling');
                isScrolling = false;
            }, 150);
        });

        window.addEventListener('beforeunload', () => {
            if (lastFloorPlanObjectUrl) {
                URL.revokeObjectURL(lastFloorPlanObjectUrl);
                lastFloorPlanObjectUrl = null;
            }
        });

        document.addEventListener('DOMContentLoaded', showComplexes);
    </script>
</body>

</html>

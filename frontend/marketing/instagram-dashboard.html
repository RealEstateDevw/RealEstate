<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram дашборд</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f7f8fb;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --border: #e2e8f0;
            --success: #16a34a;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body {
            position: relative;
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: {% if user and user.background_theme %} url('{{ user.background_theme }}') lightgray 50% / cover no-repeat {% else %} var(--bg) {% endif %};
            color: var(--text);
        }

        .page {
            max-width: 1280px;
            margin: 0 auto;
            padding: 28px 20px 48px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }
        .title {
            font-size: 22px;
            font-weight: 700;
        }
        .subtitle {
            color: var(--muted);
            font-size: 14px;
            margin-top: 6px;
        }
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
        }
        .btn-outline {
            background: #eef2ff;
            color: #1e3a8a;
            border: 1px solid #c7d2fe;
        }
        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px dashed var(--border);
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .status-strip {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .badge {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }
        .badge.error { background: rgba(239, 68, 68, 0.12); color: var(--danger); }
        .grid {
            display: grid;
            gap: 12px;
        }
        .grid.metrics {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin-bottom: 16px;
        }
        .metric {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f8fafc;
        }
        .metric-label {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 4px;
        }
        .metric-value {
            font-weight: 700;
            font-size: 18px;
        }
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-top: 12px;
        }
        .media-card {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            background: #0f172a;
            color: #fff;
            min-height: 240px;
            display: flex;
            flex-direction: column;
        }
        .media-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .media-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(15,23,42,0.85) 100%);
            flex: 1;
        }
        .media-caption {
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #e2e8f0;
        }
        .media-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #cbd5e1;
        }
        .media-type {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .empty {
            padding: 24px;
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 14px;
            background: #f8fafc;
        }
        .alert {
            padding: 12px 14px;
            border-radius: 12px;
            margin-bottom: 14px;
            border: 1px solid #fecdd3;
            background: #fff1f2;
            color: #b91c1c;
            display: none;
        }
        .alert.show { display: block; }
    </style>
</head>
<body>
    <div class="page">
        <div class="topbar">
            <div>
                <div class="title">Instagram дашборд</div>
                <div class="subtitle">Лента медиа и статус подключения бизнес-аккаунта.</div>
            </div>
            <div class="actions">
                <button class="btn btn-outline" id="refreshBtn">Обновить</button>
                <button class="btn btn-ghost" id="disconnectBtn">Отключить</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="card" id="statusCard">
            <div class="status-strip">
                <span id="statusBadge" class="badge">Подключено</span>
                <span id="statusText">Данные загружаются...</span>
            </div>
            <div class="subtitle" id="statusDescription">Получаем профиль и ленту.</div>
            <div class="grid metrics" id="profileGrid"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
            <div class="status-strip" style="margin-bottom: 8px;">
                <span class="badge">Медиа</span>
                <span id="mediaCount" class="subtitle">—</span>
            </div>
            <div id="mediaContainer" class="media-grid"></div>
            <div id="mediaEmpty" class="empty" style="display: none;">Посты не найдены. Добавьте медиа в Instagram и обновите страницу.</div>
        </div>
    </div>

    <script>
        const connectPage = '/dashboard/admin/marketing/instagram/connect';
        const alertBox = document.getElementById('alert');
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        const statusDescription = document.getElementById('statusDescription');
        const profileGrid = document.getElementById('profileGrid');
        const mediaContainer = document.getElementById('mediaContainer');
        const mediaEmpty = document.getElementById('mediaEmpty');
        const mediaCountLabel = document.getElementById('mediaCount');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const refreshBtn = document.getElementById('refreshBtn');

        function showAlert(message) {
            if (!message) {
                alertBox.classList.remove('show');
                alertBox.textContent = '';
                return;
            }
            alertBox.textContent = message;
            alertBox.classList.add('show');
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                ...options,
            });
            if (!response.ok) {
                let detail = 'Не удалось выполнить запрос.';
                try {
                    const errorData = await response.json();
                    detail = errorData.detail || detail;
                } catch (_) {
                    // ignore
                }
                throw new Error(detail);
            }
            return response.json();
        }

        function setStatus(variant, title, description) {
            const variants = {
                success: { class: 'badge', label: 'Подключено' },
                error: { class: 'badge error', label: 'Ошибка' },
                warning: { class: 'badge', label: 'Обновление' },
            };
            const preset = variants[variant] || variants.warning;
            statusBadge.className = preset.class;
            statusBadge.textContent = preset.label;
            statusText.textContent = title;
            statusDescription.textContent = description;
        }

        function formatDate(value) {
            if (!value) return '—';
            const parsed = new Date(value);
            return parsed.toLocaleString('ru-RU', { dateStyle: 'medium', timeStyle: 'short' });
        }

        function renderProfile(profile) {
            profileGrid.innerHTML = '';
            if (!profile) return;
            const items = [
                { label: 'Аккаунт', value: profile.username || '—' },
                { label: 'ID', value: profile.id || profile.instagram_user_id || '—' },
                { label: 'Тип', value: profile.account_type || '—' },
                { label: 'Медиа', value: profile.media_count ?? '—' },
                { label: 'Подключено', value: formatDate(profile.connected_at) },
                { label: 'Токен истекает', value: formatDate(profile.token_expires_at) },
            ];
            items.forEach(({ label, value }) => {
                const block = document.createElement('div');
                block.className = 'metric';
                block.innerHTML = `
                    <div class="metric-label">${label}</div>
                    <div class="metric-value">${value}</div>
                `;
                profileGrid.appendChild(block);
            });
        }

        function renderMedia(items) {
            mediaContainer.innerHTML = '';
            if (!items || items.length === 0) {
                mediaEmpty.style.display = 'block';
                mediaCountLabel.textContent = '0 постов';
                return;
            }
            mediaEmpty.style.display = 'none';
            mediaCountLabel.textContent = `${items.length} постов`;

            items.forEach((item) => {
                const card = document.createElement('a');
                card.className = 'media-card';
                card.href = item.permalink;
                card.target = '_blank';
                card.rel = 'noreferrer';

                const img = document.createElement('img');
                img.src = item.thumbnail_url || item.media_url;
                img.alt = item.caption || 'Публикация Instagram';
                card.appendChild(img);

                const body = document.createElement('div');
                body.className = 'media-body';
                const caption = document.createElement('div');
                caption.className = 'media-caption';
                caption.textContent = item.caption || 'Без подписи';
                const meta = document.createElement('div');
                meta.className = 'media-meta';
                const type = document.createElement('span');
                type.className = 'media-type';
                type.textContent = item.media_type || 'MEDIA';
                const ts = document.createElement('span');
                ts.textContent = formatDate(item.timestamp);
                meta.append(type, ts);
                body.append(caption, meta);

                card.appendChild(body);
                mediaContainer.appendChild(card);
            });
        }

        async function ensureConnected() {
            try {
                const status = await fetchJson('/api/instagram/status');
                if (!status.connected) {
                    window.location.href = connectPage;
                    return null;
                }
                return status.profile;
            } catch (error) {
                showAlert(error.message);
                window.location.href = connectPage;
                return null;
            }
        }

        async function loadProfileAndMedia() {
            setStatus('warning', 'Обновляем данные...', 'Синхронизируем профиль и ленту.');
            try {
                const [profile, media] = await Promise.all([
                    fetchJson('/api/instagram/profile'),
                    fetchJson('/api/instagram/media?limit=18'),
                ]);
                renderProfile(profile);
                renderMedia(media.items);
                setStatus('success', 'Интеграция активна', 'Данные успешно получены.');
            } catch (error) {
                showAlert(error.message || 'Не удалось загрузить данные Instagram.');
                setStatus('error', 'Ошибка получения данных', error.message || 'Попробуйте переподключить аккаунт.');
            }
        }

        async function disconnect() {
            try {
                await fetchJson('/api/instagram/connection', { method: 'DELETE' });
                window.location.href = connectPage;
            } catch (error) {
                showAlert(error.message || 'Не удалось отключить Instagram.');
            }
        }

        disconnectBtn.addEventListener('click', disconnect);
        refreshBtn.addEventListener('click', loadProfileAndMedia);

        document.addEventListener('DOMContentLoaded', async () => {
            const profile = await ensureConnected();
            if (!profile) return;
            renderProfile(profile);
            await loadProfileAndMedia();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram integration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #216BF4;
            --primary-dark: #1b58c4;
            --danger: #e53935;
            --border: #e5e7eb;
            --success: #16a34a;
        }
        * { box-sizing: border-box; }
        body {
            position: relative;
            margin: 0;
            min-height: 100vh;
            background: {% if user and user.background_theme %} url('{{ user.background_theme }}') lightgray 50% / cover no-repeat {% else %} var(--bg) {% endif %};
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--text);
        }
       
        .page {
            position: relative;
            z-index: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 20px 48px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 18px;
        }
        .title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }
        .subtitle {
            color: var(--muted);
            margin-top: 6px;
            font-size: 14px;
        }
        .card {
            position: relative;
            background: var(--card);
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .card::after {
            content: '';
            position: absolute;
            inset: 1px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.0);
            pointer-events: none;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
            background: rgba(33, 107, 244, 0.08);
            color: var(--primary);
            border: 1px solid rgba(33, 107, 244, 0.2);
        }
        .badge.success { color: #16a34a; background: rgba(22,163,74,0.08); border-color: rgba(22,163,74,0.2); }
        .badge.error { color: #e53935; background: rgba(229,57,53,0.08); border-color: rgba(229,57,53,0.2); }
        .badge.warning { color: #d97706; background: rgba(217,119,6,0.08); border-color: rgba(217,119,6,0.2); }
        .muted { color: var(--muted); font-size: 14px; margin: 4px 0 0; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        @media (min-width: 840px) {
            .form-grid.two-cols {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--muted);
            font-weight: 700;
        }
        .input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: #f8fafc;
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }
        .input:focus {
            border-color: rgba(33, 107, 244, 0.6);
            box-shadow: 0 0 0 3px rgba(33,107,244,0.15);
            background: #fff;
        }
        .input::placeholder { color: #9ca3af; }
        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 18px;
        }
        .btn {
            border: none;
            border-radius: 14px;
            padding: 12px 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: 0 10px 24px rgba(33, 107, 244, 0.3);
        }
        .btn-secondary {
            background: #eef2ff;
            color: #1e3a8a;
            border: 1px solid #c7d2fe;
        }
        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px dashed var(--border);
        }
        .alert {
            padding: 12px 14px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(229,57,53,0.18);
            background: rgba(229,57,53,0.08);
            color: #b91c1c;
            display: none;
        }
        .alert.show { display: block; }
    </style>
</head>
<body>
    <div class="page">
        <div class="topbar">
            <div>
                <div class="title">Instagram integration</div>
                <div class="subtitle">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –ª–∏–¥–∞–º–∏ –ø—Ä—è–º–æ –∏–∑ CRM.</div>
            </div>
            <div class="actions">
                <a href="/dashboard/admin/marketing/instagram/settings" class="btn btn-ghost" style="text-decoration: none;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</a>
                <button class="btn btn-secondary" id="openDashboard" disabled>–û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥</button>
                <button class="btn btn-ghost" id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="card">
            <div class="badge warning" id="statusBadge">–ü—Ä–æ–≤–µ—Ä–∫–∞</div>
            <p class="subtitle" id="statusText" style="margin: 10px 0 2px;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
            <p class="muted" id="statusDescription" style="margin-bottom: 12px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>

            <div class="form-grid">
                <div class="field">
                    <label for="usernameInput">Username</label>
                    <input class="input" id="usernameInput" type="text" placeholder="@company-account">
                </div>
                <div class="form-grid two-cols">
                    <div class="field">
                        <label for="businessIdInput">Business account ID</label>
                        <input class="input" id="businessIdInput" type="text" placeholder="1784...">
                    </div>
                    <div class="field">
                        <label for="tokenInput">Access token</label>
                        <input class="input" id="tokenInput" type="text" placeholder="EAAG...">
                    </div>
                </div>
                <div class="form-grid two-cols">
                    <div class="field">
                        <label for="accountTypeInput">–¢–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                        <input class="input" id="accountTypeInput" type="text" placeholder="business / creator">
                    </div>
                    <div class="field">
                        <label for="mediaCountInput">–ú–µ–¥–∏–∞ / –∏—Å—Ç–µ–∫–∞–µ—Ç</label>
                        <input class="input" id="mediaCountInput" type="text" placeholder="‚Äî">
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="connectBtn">
                    <span style="margin-right:8px;">üì∑</span>–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
                <button class="btn btn-secondary" id="retryBtn" style="display: none;">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
        </div>
    </div>

    <script>
        const alertBox = document.getElementById('alert');
        const connectBtn = document.getElementById('connectBtn');
        const retryBtn = document.getElementById('retryBtn');
        const openDashboardBtn = document.getElementById('openDashboard');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        const statusDescription = document.getElementById('statusDescription');
        const usernameInput = document.getElementById('usernameInput');
        const businessIdInput = document.getElementById('businessIdInput');
        const tokenInput = document.getElementById('tokenInput');
        const accountTypeInput = document.getElementById('accountTypeInput');
        const mediaCountInput = document.getElementById('mediaCountInput');
        const serverError = "{{ error or '' }}";

        const connectUrl = '/dashboard/admin/marketing';
        const connectPage = '/dashboard/admin/marketing/instagram/connect';
        const settingsPage = '/dashboard/admin/marketing/instagram/settings';

        function showAlert(message) {
            if (!message) {
                alertBox.classList.remove('show');
                alertBox.textContent = '';
                return;
            }
            alertBox.textContent = message;
            alertBox.classList.add('show');
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                ...options,
            });
            if (!response.ok) {
                let detail = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.';
                try {
                    const errorData = await response.json();
                    detail = errorData.detail || detail;
                } catch (_) {
                    // ignore parse errors
                }
                throw new Error(detail);
            }
            return response.json();
        }

        function setStatus(variant, title, description) {
            const variants = {
                success: { class: 'badge success', label: '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' },
                error: { class: 'badge error', label: '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ' },
                warning: { class: 'badge warning', label: '–ü—Ä–æ–≤–µ—Ä–∫–∞' },
                config: { class: 'badge warning', label: '–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞' },
            };
            const preset = variants[variant] || variants.warning;
            statusBadge.className = preset.class;
            statusBadge.textContent = preset.label;
            statusText.textContent = title;
            statusDescription.textContent = description;
        }

        function formatDate(value) {
            if (!value) return '‚Äî';
            const parsed = new Date(value);
            return parsed.toLocaleString('ru-RU', { dateStyle: 'medium', timeStyle: 'short' });
        }

        function renderProfile(profile) {
            if (!profile) {
                usernameInput.value = '';
                businessIdInput.value = '';
                tokenInput.value = '';
                accountTypeInput.value = '';
                mediaCountInput.value = '';
                return;
            }
            usernameInput.value = profile.username || '';
            businessIdInput.value = profile.id || profile.instagram_user_id || '';
            accountTypeInput.value = profile.account_type || '';
            mediaCountInput.value = `${profile.media_count ?? '‚Äî'} ‚Ä¢ –∏—Å—Ç–µ–∫–∞–µ—Ç ${formatDate(profile.token_expires_at)}`;
            tokenInput.value = '********';
        }

        async function checkSettings() {
            try {
                const settingsStatus = await fetchJson('/api/instagram/settings/status');
                return settingsStatus.is_configured;
            } catch (error) {
                return false;
            }
        }

        async function loadStatus() {
            setStatus('warning', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.');
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏ API –∫–ª—é—á–∏
            const isConfigured = await checkSettings();
            if (!isConfigured) {
                setStatus('config', 'Instagram API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', '–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ App ID –∏ App Secret –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
                statusDescription.innerHTML = '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="' + settingsPage + '" style="color: var(--primary); text-decoration: underline;">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Instagram API</a> –∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Meta.';
                connectBtn.disabled = true;
                connectBtn.textContent = '–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API';
                openDashboardBtn.disabled = true;
                disconnectBtn.disabled = true;
                renderProfile(null);
                retryBtn.style.display = 'inline-flex';
                return;
            }
            
            connectBtn.disabled = false;
            connectBtn.innerHTML = '<span style="margin-right:8px;">üì∑</span>–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
            
            try {
                const status = await fetchJson('/api/instagram/status');
                if (!status.connected) {
                    openDashboardBtn.disabled = true;
                    disconnectBtn.disabled = true;
                    renderProfile(null);
                    setStatus('error', 'Instagram –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', '–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç¬ª –∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.');
                    retryBtn.style.display = 'inline-flex';
                    return;
                }
                openDashboardBtn.disabled = false;
                disconnectBtn.disabled = false;
                renderProfile(status.profile);
                setStatus('success', '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞', '–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç.');
                retryBtn.style.display = 'none';
            } catch (error) {
                openDashboardBtn.disabled = true;
                disconnectBtn.disabled = true;
                renderProfile(null);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                if (error.message.includes('–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω') || error.message.includes('App ID')) {
                    setStatus('config', 'Instagram API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', '');
                    statusDescription.innerHTML = '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="' + settingsPage + '" style="color: var(--primary); text-decoration: underline;">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Instagram API</a> –∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Meta.';
                    connectBtn.disabled = true;
                } else {
                    setStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
                    showAlert(error.message);
                }
                retryBtn.style.display = 'inline-flex';
            }
        }

        async function startOAuth() {
            try {
                const data = await fetchJson('/api/instagram/auth-url');
                window.location.href = data.url;
            } catch (error) {
                if (error.message.includes('–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω')) {
                    showAlert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Instagram API: ' + settingsPage);
                } else {
                    showAlert(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.');
                }
            }
        }

        async function disconnect() {
            try {
                await fetchJson('/api/instagram/connection', { method: 'DELETE' });
                await loadStatus();
                showAlert('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.');
            } catch (error) {
                showAlert(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª—é—á–∏—Ç—å Instagram.');
            }
        }

        connectBtn.addEventListener('click', startOAuth);
        retryBtn.addEventListener('click', loadStatus);
        openDashboardBtn.addEventListener('click', () => window.location.href = connectUrl);
        disconnectBtn.addEventListener('click', disconnect);

        document.addEventListener('DOMContentLoaded', () => {
            if (serverError) {
                showAlert(serverError);
                setStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
            }
            loadStatus();
        });
    </script>
</body>
</html>

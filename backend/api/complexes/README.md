# üè¢ Complexes API ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–ª—ã–º–∏ –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–ª—ã–º–∏ –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏ (–ñ–ö): —à–∞—Ö–º–∞—Ç–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ —ç—Ç–∞–∂–µ–π, —Ü–µ–Ω—ã, —Ä–µ–Ω–¥–µ—Ä—ã, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –®–∞—Ö–º–∞—Ç–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä
–í–∏–∑—É–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ñ–ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- –ë–ª–æ–∫ (—Å–µ–∫—Ü–∏—è)
- –ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã
- –≠—Ç–∞–∂
- –ü–ª–æ—â–∞–¥—å
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
- –°—Ç–∞—Ç—É—Å (—Å–≤–æ–±–æ–¥–Ω–∞, –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞, –ø—Ä–æ–¥–∞–Ω–∞)
- –¶–µ–Ω–∞

### –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
- –ü–ª–∞–Ω —ç—Ç–∞–∂–∞ (–æ–±—â–∏–π)
- –ü–ª–∞–Ω –∫–≤–∞—Ä—Ç–∏—Ä—ã (–¥–µ—Ç–∞–ª—å–Ω—ã–π)
- –†–µ–Ω–¥–µ—Ä—ã –ñ–ö (3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –°–ø–∏—Å–æ–∫ –ñ–ö

#### `GET /api/complexes/`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤.

**Response:**
```json
{
  "status": "success",
  "complexes": [
    {
      "id": 1,
      "name": "–ñ–ö_–†–∞—Å—Å–≤–µ—Ç",
      "slug": "–∂–∫-—Ä–∞—Å—Å–≤–µ—Ç",
      "render": "/static/–ñ–∏–ª—ã–µ_–ö–æ–º–ø–ª–µ–∫—Å—ã/–ñ–ö_–†–∞—Å—Å–≤–µ—Ç/render/main.png"
    },
    ...
  ]
}
```

### –î–∞–Ω–Ω—ã–µ –ñ–ö

#### `GET /api/complexes/jk/{jk_name}`
–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ñ–ö: —à–∞—Ö–º–∞—Ç–∫—É, –±–ª–æ–∫–∏, —ç—Ç–∞–∂–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `jk_name` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ñ–ö_–†–∞—Å—Å–≤–µ—Ç")

**Response:**
```json
{
  "status": "success",
  "shaxmatka": [
    ["–ë–ª–æ–∫", "–¢–∏–ø", "–°—Ç–∞—Ç—É—Å", "–ö–æ–º–Ω–∞—Ç—ã", "‚Ññ", "–ü–ª–æ—â–∞–¥—å", "–≠—Ç–∞–∂"],
    ["A", "–∂–∏–ª–æ–π", "—Å–≤–æ–±–æ–¥–Ω–∞", 2, "45", 55.5, 5],
    ...
  ],
  "blocks": ["A", "B", "C"],
  "floors": [1, 2, 3, 4, 5, 6, 7, 8, 9],
  "render": "/static/–ñ–∏–ª—ã–µ_–ö–æ–º–ø–ª–µ–∫—Å—ã/–ñ–ö_–†–∞—Å—Å–≤–µ—Ç/render/complex.png",
  "registryContracts": [...]
}
```

### –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

#### `GET /api/complexes/aggregate`
–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –ñ–ö –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ (–¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤).

**Response:**
```json
{
  "status": "success",
  "updatedAt": "2025-12-03T10:00:00Z",
  "complexes": [
    {
      "id": 1,
      "name": "–ñ–ö_–†–∞—Å—Å–≤–µ—Ç",
      "blocks": ["A", "B"],
      "floors": [1, 2, 3, 4, 5],
      "shaxmatka": [...],
      "renders": [...]
    },
    ...
  ]
}
```

### –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏

#### `GET /api/complexes/floor-plan`
–ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞–Ω —ç—Ç–∞–∂–∞.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `jkName` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö
- `floor` ‚Äî –Ω–æ–º–µ—Ä —ç—Ç–∞–∂–∞
- `blockName` (optional) ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞

**Response:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (PNG/JPG)

**–ü—Ä–∏–º–µ—Ä—ã:**
```
GET /api/complexes/floor-plan?jkName=–ñ–ö_–†–∞—Å—Å–≤–µ—Ç&floor=5
GET /api/complexes/floor-plan?jkName=–ñ–ö_–ë–∞—Ö–æ—Ä&floor=3&blockName=A
```

#### `GET /api/complexes/plan-image`
–ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `jkName` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö
- `blockName` ‚Äî –±–ª–æ–∫
- `apartmentSize` ‚Äî –ø–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã

**Response:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (PNG/JPG)

**–ü—Ä–∏–º–µ—Ä:**
```
GET /api/complexes/plan-image?jkName=–ñ–ö_–†–∞—Å—Å–≤–µ—Ç&blockName=A&apartmentSize=55.5
```

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ

#### `GET /api/complexes/apartment-info`
–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ: —Ü–µ–Ω—ã, —Å—Ç–∞—Ç—É—Å, —Å—Ä–æ–∫ —Å–¥–∞—á–∏.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `jkName` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö
- `blockName` ‚Äî –±–ª–æ–∫
- `floor` ‚Äî —ç—Ç–∞–∂
- `apartmentSize` ‚Äî –ø–ª–æ—â–∞–¥—å
- `apartmentNumber` ‚Äî –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã

**Response:**
```json
{
  "status": "success",
  "data": {
    "pricePerM2_100": 1500,    // –¶–µ–Ω–∞ 100% –æ–ø–ª–∞—Ç–∞
    "pricePerM2_70": 1600,     // –¶–µ–Ω–∞ 70% –æ–ø–ª–∞—Ç–∞
    "pricePerM2_50": 1700,     // –¶–µ–Ω–∞ 50% –æ–ø–ª–∞—Ç–∞
    "pricePerM2_30": 1800,     // –¶–µ–Ω–∞ 30% –æ–ø–ª–∞—Ç–∞
    "total_price": 83250,      // –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
    "status": "—Å–≤–æ–±–æ–¥–Ω–∞",
    "floor": "5",
    "size": "55.5",
    "apartment_number": "45",
    "months_left": 18,         // –ú–µ—Å—è—Ü–µ–≤ –¥–æ —Å–¥–∞—á–∏
    "roomsCount": 2,           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
    "unitType": "–∂–∏–ª–æ–π"        // –¢–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è
  }
}
```

### –ë–ª–æ–∫–∏ –ñ–ö

#### `GET /api/complexes/blocks/{jk_name}`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫–æ–≤ (—Å–µ–∫—Ü–∏–π) –ñ–ö.

**Response:**
```json
{
  "status": "success",
  "blocks": ["A", "B", "C"]
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ñ–ö

#### `POST /api/complexes/add-complex`
–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∂–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤).

**Form Data:**
- `name` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ (—Ñ–æ—Ä–º–∞—Ç: "–ñ–ö_–ù–∞–∑–≤–∞–Ω–∏–µ")
- `jk_file` ‚Äî Excel —Ñ–∞–π–ª —Å —à–∞—Ö–º–∞—Ç–∫–æ–π (jk_data.xlsx)
- `price_file` ‚Äî Excel —Ñ–∞–π–ª —Å —Ü–µ–Ω–∞–º–∏ (price_shaxamtka.xlsx)
- `template_file` ‚Äî Word —à–∞–±–ª–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞ (contract_template.docx)

**Response:**
```json
{
  "message": "–ñ–ö —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω",
  "complex_name": "–ñ–ö_–ù–æ–≤—ã–π",
  "saved_files": [
    {"filename": "jk_data.xlsx", "size": 45678},
    {"filename": "price_shaxamtka.xlsx", "size": 12345},
    {"filename": "contract_template.docx", "size": 98765}
  ],
  "imported": {
    "apartments": 120,  // –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–≤–∞—Ä—Ç–∏—Ä
    "prices": 9         // –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ü–µ–Ω
  }
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

```
static/–ñ–∏–ª—ã–µ_–ö–æ–º–ø–ª–µ–∫—Å—ã/
‚îî‚îÄ‚îÄ –ñ–ö_–†–∞—Å—Å–≤–µ—Ç/
    ‚îú‚îÄ‚îÄ jk_data.xlsx              # –®–∞—Ö–º–∞—Ç–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä
    ‚îú‚îÄ‚îÄ price_shaxamtka.xlsx      # –¶–µ–Ω—ã
    ‚îú‚îÄ‚îÄ contract_template.docx    # –®–∞–±–ª–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞
    ‚îú‚îÄ‚îÄ render/                   # –†–µ–Ω–¥–µ—Ä—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ main.png
    ‚îÇ   ‚îú‚îÄ‚îÄ complex.png
    ‚îÇ   ‚îî‚îÄ‚îÄ aerial.png
    ‚îú‚îÄ‚îÄ plan_roof.pdf             # –ü–ª–∞–Ω—ã —ç—Ç–∞–∂–µ–π (PDF)
    ‚îú‚îÄ‚îÄ plan_A_5.png              # –ü–ª–∞–Ω –±–ª–æ–∫–∞ A, —ç—Ç–∞–∂ 5
    ‚îî‚îÄ‚îÄ plan_55.5.png             # –ü–ª–∞–Ω –∫–≤–∞—Ä—Ç–∏—Ä—ã 55.5 –º¬≤
```

### Excel —Ñ–∞–π–ª —à–∞—Ö–º–∞—Ç–∫–∏ (jk_data.xlsx)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫:

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| 0 | –ë–ª–æ–∫ | A, B, C, –∏ —Ç.–¥. |
| 1 | –¢–∏–ø | "–∂–∏–ª–æ–π" –∏–ª–∏ "–Ω–µ–∂–∏–ª–æ–π" |
| 2 | –°—Ç–∞—Ç—É—Å | "—Å–≤–æ–±–æ–¥–Ω–∞", "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞", "–ø—Ä–æ–¥–∞–Ω–∞" |
| 3 | –ö–æ–º–Ω–∞—Ç—ã | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (1, 2, 3, –∏ —Ç.–¥.) |
| 4 | ‚Ññ | –ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã |
| 5 | –ü–ª–æ—â–∞–¥—å | –ü–ª–æ—â–∞–¥—å –≤ –º¬≤ |
| 6 | –≠—Ç–∞–∂ | –ù–æ–º–µ—Ä —ç—Ç–∞–∂–∞ |

–ü—Ä–∏–º–µ—Ä:
```
–ë–ª–æ–∫ | –¢–∏–ø    | –°—Ç–∞—Ç—É—Å     | –ö–æ–º–Ω–∞—Ç—ã | ‚Ññ | –ü–ª–æ—â–∞–¥—å | –≠—Ç–∞–∂
A    | –∂–∏–ª–æ–π  | —Å–≤–æ–±–æ–¥–Ω–∞   | 2       | 45| 55.5    | 5
A    | –∂–∏–ª–æ–π  | –ø—Ä–æ–¥–∞–Ω–∞    | 3       | 46| 75.2    | 5
B    | –Ω–µ–∂–∏–ª–æ–π| —Å–≤–æ–±–æ–¥–Ω–∞   | -       | 1 | 120.0   | 1
```

### Excel —Ñ–∞–π–ª —Ü–µ–Ω (price_shaxamtka.xlsx)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:

| –≠—Ç–∞–∂ | 100% | 70% | 50% | 30% |
|------|------|-----|-----|-----|
| 1    | 1400 | 1500| 1600| 1700|
| 2    | 1450 | 1550| 1650| 1750|
| 5    | 1500 | 1600| 1700| 1800|

–°—Ö–µ–º—ã –æ–ø–ª–∞—Ç—ã:
- **100%** ‚Äî –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É
- **70%** ‚Äî 70% —Å–µ–π—á–∞—Å, 30% –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É
- **50%** ‚Äî 50% —Å–µ–π—á–∞—Å, 50% –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É
- **30%** ‚Äî 30% —Å–µ–π—á–∞—Å, 70% –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É

## –ú–æ–¥–µ–ª–∏ –ë–î

### ResidentialComplex
```python
- id: int (PK)
- name: str (UNIQUE)  # "–ñ–ö_–†–∞—Å—Å–≤–µ—Ç"
- slug: str           # "–∂–∫-—Ä–∞—Å—Å–≤–µ—Ç"
- created_at: datetime
```

### ApartmentUnit
```python
- id: int (PK)
- complex_id: int (FK -> ResidentialComplex)
- block_name: str     # "A"
- unit_number: str    # "45"
- floor: int          # 5
- rooms_count: int    # 2
- size: float         # 55.5
- unit_type: str      # "–∂–∏–ª–æ–π"
- status: str         # "—Å–≤–æ–±–æ–¥–Ω–∞"
- price: float (optional)
```

### PriceEntry
```python
- id: int (PK)
- complex_id: int (FK -> ResidentialComplex)
- floor: int
- price_100: float
- price_70: float
- price_50: float
- price_30: float
```

### ContractRegistryEntry
```python
- id: int (PK)
- complex_id: int (FK -> ResidentialComplex)
- apartment_id: int (FK -> ApartmentUnit, optional)
- block_name: str
- floor: int
- apartment_number: str
- contract_number: str
- contract_date: date
- extra_data: JSON
```

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ **15 –º–∏–Ω—É—Ç** (`CACHE_TTL_SECONDS = 900`).

–ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ñ–ö
- –ò–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

–§—É–Ω–∫—Ü–∏—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:
```python
from backend.core.cache_utils import invalidate_complex_cache

await invalidate_complex_cache()
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets

–î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ Google Sheets:

```python
from backend.core.google_sheets import get_shaxmatka_data, get_price_data_for_sheet

# –ü–æ–ª—É—á–∏—Ç—å —à–∞—Ö–º–∞—Ç–∫—É
shaxmatka = await get_shaxmatka_data("–ñ–ö_–†–∞—Å—Å–≤–µ—Ç")

# –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É
price = await get_price_data_for_sheet("–ñ–ö_–†–∞—Å—Å–≤–µ—Ç_5_100")
```

## –ü–ª–∞–Ω—ã —ç—Ç–∞–∂–µ–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫

–°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–ª–∞–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

1. **–ü—Ä–µ–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ PNG:**
   - `static/floorplans/–ñ–ö_–†–∞—Å—Å–≤–µ—Ç/*.png`
   - –ù—É–º–µ—Ä—É—é—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º (1.png, 2.png, ...)

2. **–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
   - `plan_A_5.png` ‚Äî –±–ª–æ–∫ A, —ç—Ç–∞–∂ 5
   - `plan_5.png` ‚Äî —ç—Ç–∞–∂ 5
   - `floor_5.png` ‚Äî —ç—Ç–∞–∂ 5

3. **PDF —Ñ–∞–π–ª—ã:**
   - `plan_roof.pdf` ‚Äî –ø–ª–∞–Ω—ã –≤—Å–µ—Ö —ç—Ç–∞–∂–µ–π –≤ –æ–¥–Ω–æ–º PDF
   - `Plan pradaja.pdf` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –Ω—É–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ PDF

1. **–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É:**
   - "–≠—Ç–∞–∂ 5" –∏–ª–∏ "Floor 5" –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

2. **–ü–æ –ø–æ—Ä—è–¥–∫—É —ç—Ç–∞–∂–µ–π –∏–∑ —à–∞—Ö–º–∞—Ç–∫–∏:**
   - –ë–µ—Ä—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç—Ç–∞–∂–∏ –∏–∑ —à–∞—Ö–º–∞—Ç–∫–∏
   - –°–æ—Ä—Ç–∏—Ä—É–µ—Ç (–ø—Ä—è–º–æ–π –∏–ª–∏ –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
   - –ù–∞—Ö–æ–¥–∏—Ç –∏–Ω–¥–µ–∫—Å –Ω—É–∂–Ω–æ–≥–æ —ç—Ç–∞–∂–∞

3. **Fallback:**
   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ = —ç—Ç–∞–∂ - 1 (–¥–ª—è –ñ–ö —Å 1 —ç—Ç–∞–∂–∞)

### –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü

–î–ª—è –ñ–ö —Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π:

```python
PDF_PAGE_OVERRIDES = {
    "–ñ–ö_–†–∞—Å—Å–≤–µ—Ç": 1,  # –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 1 (–∞ –Ω–µ 0)
}
```

## –ü–ª–∞–Ω—ã –∫–≤–∞—Ä—Ç–∏—Ä

–°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä—É–µ—Ç –ø–ª–∞–Ω—ã –∫–≤–∞—Ä—Ç–∏—Ä –≤ `static/cached_plans/`:

```python
from backend.core.plan_cache import ensure_plan_image_cached

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–ª–∞–Ω –∏ –∫—ç—à–∏—Ä—É–µ—Ç
cached_path = ensure_plan_image_cached("–ñ–ö_–†–∞—Å—Å–≤–µ—Ç", "A", "55.5")
```

–ü–æ–∏—Å–∫ –ø–ª–∞–Ω–æ–≤:
1. `–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏/55.5.png` ‚Äî –ø–æ –ø–ª–æ—â–∞–¥–∏
2. `–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏/2K_55.5.png` ‚Äî –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º –∏ –ø–ª–æ—â–∞–¥–∏
3. `–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏/A/55.5.png` ‚Äî –ø–æ –±–ª–æ–∫—É –∏ –ø–ª–æ—â–∞–¥–∏

## –†–µ–µ—Å—Ç—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã —á–µ—Ä–µ–∑ `ContractRegistryEntry`.

### –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏–∑ Excel:

```python
from backend.core.excel_importer import import_contract_registry_from_excel

entries = import_contract_registry_from_excel(db, complex_record, "registry.xlsx")
```

### –§–æ—Ä–º–∞—Ç Excel:

| –ë–ª–æ–∫ | –≠—Ç–∞–∂ | ‚Ññ –ö–í | –ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ | –î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ |
|------|------|------|----------------|---------------|
| A    | 5    | 45   | –î-2025-123     | 2025-12-01    |

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API:

```javascript
// –í –æ—Ç–≤–µ—Ç–µ /api/complexes/jk/{jk_name}
"registryContracts": [
  {
    "block": "A",
    "blockNormalized": "a",
    "floor": "5",
    "apartmentNumber": "45",
    "contractNumber": "–î-2025-123",
    "contractDate": "2025-12-01"
  }
]
```

Frontend –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä –≤ —à–∞—Ö–º–∞—Ç–∫–µ.

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### JavaScript: –ü–æ–ª—É—á–µ–Ω–∏–µ —à–∞—Ö–º–∞—Ç–∫–∏

```javascript
async function loadComplex(jkName) {
  const response = await fetch(`/api/complexes/jk/${jkName}`);
  const data = await response.json();
  
  if (data.status === 'success') {
    console.log('–ë–ª–æ–∫–∏:', data.blocks);
    console.log('–≠—Ç–∞–∂–∏:', data.floors);
    console.log('–®–∞—Ö–º–∞—Ç–∫–∞:', data.shaxmatka);
    
    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —à–∞—Ö–º–∞—Ç–∫—É
    renderChessboard(data.shaxmatka, data.registryContracts);
  }
}
```

### JavaScript: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ

```javascript
async function getApartmentInfo(jk, block, floor, size, number) {
  const params = new URLSearchParams({
    jkName: jk,
    blockName: block,
    floor: floor,
    apartmentSize: size,
    apartmentNumber: number
  });
  
  const response = await fetch(`/api/complexes/apartment-info?${params}`);
  const data = await response.json();
  
  if (data.status === 'success') {
    const info = data.data;
    console.log(`–¶–µ–Ω–∞ 100%: $${info.pricePerM2_100}/–º¬≤`);
    console.log(`–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $${info.total_price}`);
    console.log(`–°–¥–∞—á–∞ —á–µ—Ä–µ–∑ ${info.months_left} –º–µ—Å—è—Ü–µ–≤`);
  }
}
```

### JavaScript: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ñ–ö

```javascript
async function addComplex(name, jkFile, priceFile, templateFile) {
  const formData = new FormData();
  formData.append('name', name);
  formData.append('jk_file', jkFile);
  formData.append('price_file', priceFile);
  formData.append('template_file', templateFile);
  
  const response = await fetch('/api/complexes/add-complex', {
    method: 'POST',
    body: formData
  });
  
  const result = await response.json();
  console.log('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–≤–∞—Ä—Ç–∏—Ä:', result.imported.apartments);
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è (15 –º–∏–Ω)
   - –ü–ª–∞–Ω—ã –∫–≤–∞—Ä—Ç–∏—Ä –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `@cache` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞

2. **Eager loading:**
   - `joinedload()` –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò–∑–±–µ–≥–∞–µ–º N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

3. **PDF –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü –≤ PNG –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–¥–∞—á–∏
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è

4. **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ NaN, Inf –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ Excel
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –±–ª–æ–∫–æ–≤ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞)

## –û—à–∏–±–∫–∏

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏—á–∏–Ω–∞ |
|-----|----------|---------|
| 400 | Bad Request | –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã |
| 404 | Not Found | –ñ–ö, –ø–ª–∞–Ω –∏–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã |
| 500 | Internal Error | –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Excel –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF |

## TODO

- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π –ñ–ö
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
- [ ] 3D —Ç—É—Ä—ã –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º
- [ ] –û–Ω–ª–∞–π–Ω –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–ø–æ—Ç–µ–∫–∏
- [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º (–∫–æ–º–Ω–∞—Ç—ã, –ø–ª–æ—â–∞–¥—å, —Ü–µ–Ω–∞)

---

**–ê–≤—Ç–æ—Ä:** RealEstate CRM Team  
**–î–∞—Ç–∞:** 2025

